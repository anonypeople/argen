<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<unit xmlns="http://www.sdml.info/srcML/src" language="Java"
      filename="C:\Users\dnader\git\biorimp\BIO-RIMP\test_data\code\xerces\src\org\apache\xerces\impl\dtd\models\DFAContentModel.java">
    <comment type="block">/*
        * Copyright 1999-2002,2004 The Apache Software Foundation.
        *
        * Licensed under the Apache License, Version 2.0 (the "License");
        * you may not use this file except in compliance with the License.
        * You may obtain a copy of the License at
        *
        * http://www.apache.org/licenses/LICENSE-2.0
        *
        * Unless required by applicable law or agreed to in writing, software
        * distributed under the License is distributed on an "AS IS" BASIS,
        * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
        * See the License for the specific language governing permissions and
        * limitations under the License.
        */
    </comment>

    <package>package
        <name><name>org</name>.<name>apache</name>.<name>xerces</name>.<name>impl</name>.<name>dtd</name>.
            <name>models</name>
        </name>
        ;
    </package>

    <import>import
        <name><name>org</name>.<name>apache</name>.<name>xerces</name>.<name>xni</name>.
            <name>QName</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>org</name>.<name>apache</name>.<name>xerces</name>.<name>impl</name>.<name>dtd</name>.
            <name>XMLContentSpec</name>
        </name>
        ;
    </import>

    <comment type="javadoc">/**
        * DFAContentModel is the derivative of ContentModel that does
        * all of the non-trivial element content validation. This class does
        * the conversion from the regular expression to the DFA that
        * it then uses in its validation algorithm.
        * &lt;p&gt;
        * &lt;b&gt;Note:&lt;/b&gt; Upstream work insures that this class will never see
        * a content model with PCDATA in it. Any model with PCDATA is 'mixed'
        * and is handled via the MixedContentModel class since mixed models
        * are very constrained in form and easily handled via a special case.
        * This also makes implementation of this class much easier.
        *
        * @xerces.internal
        *
        * @version $Id: DFAContentModel.java,v 1.7 2004/10/04 22:00:42 mrglavas Exp $
        */
    </comment>
    <class>
        <specifier>public</specifier>
        class
        <name>DFAContentModel</name>
        <super>
            <implements>implements
                <name>ContentModelValidator</name>
            </implements>
        </super>
        <block>{

            <comment type="line">//</comment>
            <comment type="line">// Constants</comment>
            <comment type="line">//</comment>
            <comment type="line">// special strings</comment>

            <comment type="javadoc">/** Epsilon string. */</comment>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <specifier>static</specifier>
                        <name>String</name>
                    </type>
                    <name>fEpsilonString</name> =
                    <init>
                        <expr>"&lt;&lt;CMNODE_EPSILON&gt;&gt;"</expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <comment type="javadoc">/** End-of-content string. */</comment>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <specifier>static</specifier>
                        <name>String</name>
                    </type>
                    <name>fEOCString</name> =
                    <init>
                        <expr>"&lt;&lt;CMNODE_EOC&gt;&gt;"</expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <comment type="javadoc">/** initializing static members **/</comment>
            static
            <block>{
                <expr_stmt>
                    <expr>
                        <name>fEpsilonString</name>
                        =
                        <call>
                            <name><name>fEpsilonString</name>.
                                <name>intern</name>
                            </name>
                            <argument_list>()</argument_list>
                        </call>
                    </expr>
                    ;
                </expr_stmt>
                <expr_stmt>
                    <expr>
                        <name>fEOCString</name>
                        =
                        <call>
                            <name><name>fEOCString</name>.
                                <name>intern</name>
                            </name>
                            <argument_list>()</argument_list>
                        </call>
                    </expr>
                    ;
                </expr_stmt>
                }
            </block>

            <comment type="line">// debugging</comment>

            <comment type="javadoc">/** Set to true to debug content model validation. */</comment>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <specifier>static</specifier>
                        <specifier>final</specifier>
                        <name>boolean</name>
                    </type>
                    <name>DEBUG_VALIDATE_CONTENT</name> =
                    <init>
                        <expr>false</expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <comment type="line">//</comment>
            <comment type="line">// Data</comment>
            <comment type="line">//</comment>

            <comment type="block">/* this is the EquivClassComparator object */</comment>
            <comment type="line">//private EquivClassComparator comparator = null;</comment>

            <comment type="javadoc">/**
                * This is the map of unique input symbol elements to indices into
                * each state's per-input symbol transition table entry. This is part
                * of the built DFA information that must be kept around to do the
                * actual validation.
                */
            </comment>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>QName</name>
                    </type>
                    <name>
                        <name>fElemMap</name>
                        <index>[]</index>
                    </name>
                    =
                    <init>
                        <expr>
                            <name>null</name>
                        </expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <comment type="javadoc">/**
                * This is a map of whether the element map contains information
                * related to ANY models.
                */
            </comment>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>int</name>
                    </type>
                    <name>
                        <name>fElemMapType</name>
                        <index>[]</index>
                    </name>
                    =
                    <init>
                        <expr>
                            <name>null</name>
                        </expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <comment type="javadoc">/** The element map size. */</comment>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>int</name>
                    </type>
                    <name>fElemMapSize</name> =
                    <init>
                        <expr>0</expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <comment type="javadoc">/** Boolean to distinguish Schema Mixed Content */</comment>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>boolean</name>
                    </type>
                    <name>fMixed</name>
                </decl>
                ;
            </decl_stmt>

            <comment type="javadoc">/**
                * The NFA position of the special EOC (end of content) node. This
                * is saved away since it's used during the DFA build.
                */
            </comment>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>int</name>
                    </type>
                    <name>fEOCPos</name> =
                    <init>
                        <expr>0</expr>
                    </init>
                </decl>
                ;
            </decl_stmt>


            <comment type="javadoc">/**
                * This is an array of booleans, one per state (there are
                * fTransTableSize states in the DFA) that indicates whether that
                * state is a final state.
                */
            </comment>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>boolean</name>
                    </type>
                    <name>
                        <name>fFinalStateFlags</name>
                        <index>[]</index>
                    </name>
                    =
                    <init>
                        <expr>
                            <name>null</name>
                        </expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <comment type="javadoc">/**
                * The list of follow positions for each NFA position (i.e. for each
                * non-epsilon leaf node.) This is only used during the building of
                * the DFA, and is let go afterwards.
                */
            </comment>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>CMStateSet</name>
                    </type>
                    <name>
                        <name>fFollowList</name>
                        <index>[]</index>
                    </name>
                    =
                    <init>
                        <expr>
                            <name>null</name>
                        </expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <comment type="javadoc">/**
                * This is the head node of our intermediate representation. It is
                * only non-null during the building of the DFA (just so that it
                * does not have to be passed all around.) Once the DFA is built,
                * this is no longer required so its nulled out.
                */
            </comment>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>CMNode</name>
                    </type>
                    <name>fHeadNode</name> =
                    <init>
                        <expr>
                            <name>null</name>
                        </expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <comment type="javadoc">/**
                * The count of leaf nodes. This is an important number that set some
                * limits on the sizes of data structures in the DFA process.
                */
            </comment>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>int</name>
                    </type>
                    <name>fLeafCount</name> =
                    <init>
                        <expr>0</expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <comment type="javadoc">/**
                * An array of non-epsilon leaf nodes, which is used during the DFA
                * build operation, then dropped.
                */
            </comment>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>CMLeaf</name>
                    </type>
                    <name>
                        <name>fLeafList</name>
                        <index>[]</index>
                    </name>
                    =
                    <init>
                        <expr>
                            <name>null</name>
                        </expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <comment type="javadoc">/** Array mapping ANY types to the leaf list. */</comment>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>int</name>
                    </type>
                    <name>
                        <name>fLeafListType</name>
                        <index>[]</index>
                    </name>
                    =
                    <init>
                        <expr>
                            <name>null</name>
                        </expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <comment type="line">//private ContentLeafNameTypeVector fLeafNameTypeVector = null;</comment>

            <comment type="javadoc">/**
                * The string pool of our parser session. This is set during construction
                * and kept around.
                */
            </comment>
            <comment type="line">//private StringPool fStringPool = null;</comment>

            <comment type="javadoc">/**
                * This is the transition table that is the main by product of all
                * of the effort here. It is an array of arrays of ints. The first
                * dimension is the number of states we end up with in the DFA. The
                * second dimensions is the number of unique elements in the content
                * model (fElemMapSize). Each entry in the second dimension indicates
                * the new state given that input for the first dimension's start
                * state.
                * &lt;p&gt;
                * The fElemMap array handles mapping from element indexes to
                * positions in the second dimension of the transition table.
                */
            </comment>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>int</name>
                    </type>
                    <name>
                        <name>fTransTable</name>
                        <index>[]</index>
                        <index>[]</index>
                    </name>
                    =
                    <init>
                        <expr>
                            <name>null</name>
                        </expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <comment type="javadoc">/**
                * The number of valid entries in the transition table, and in the other
                * related tables such as fFinalStateFlags.
                */
            </comment>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>int</name>
                    </type>
                    <name>fTransTableSize</name> =
                    <init>
                        <expr>0</expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <comment type="javadoc">/**
                * Flag that indicates that even though we have a "complicated"
                * content model, it is valid to have no content. In other words,
                * all parts of the content model are optional. For example:
                * &lt;pre&gt;
                * &amp;lt;!ELEMENT AllOptional (Optional*,NotRequired?)&amp;gt;
                * &lt;/pre&gt;
                */
            </comment>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>boolean</name>
                    </type>
                    <name>fEmptyContentIsValid</name> =
                    <init>
                        <expr>false</expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <comment type="line">// temp variables</comment>

            <comment type="javadoc">/** Temporary qualified name. */</comment>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>QName</name>
                    </type>
                    <name>fQName</name> =
                    <init>
                        <expr>new
                            <call>
                                <name>QName</name>
                                <argument_list>()</argument_list>
                            </call>
                        </expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <comment type="line">//</comment>
            <comment type="line">// Constructors</comment>
            <comment type="line">//</comment>


            <comment type="line">//</comment>
            <comment type="line">// Constructors</comment>
            <comment type="line">//</comment>

            <comment type="javadoc">/**
                * Constructs a DFA content model.
                *
                * @param syntaxTree The syntax tree of the content model.
                * @param leafCount The number of leaves.
                * @param mixed
                *
                */
            </comment>
            <constructor>
                <specifier>public</specifier>
                <name>DFAContentModel</name>
                <parameter_list>(
                    <param>
                        <decl>
                            <type>
                                <name>CMNode</name>
                            </type>
                            <name>syntaxTree</name>
                        </decl>
                    </param>
                    ,
                    <param>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>leafCount</name>
                        </decl>
                    </param>
                    ,
                    <param>
                        <decl>
                            <type>
                                <name>boolean</name>
                            </type>
                            <name>mixed</name>
                        </decl>
                    </param>
                    )
                </parameter_list>
                <block>{
                    <comment type="line">// Store away our index and pools in members</comment>
                    <comment type="line">//fStringPool = stringPool;</comment>
                    <expr_stmt>
                        <expr>
                            <name>fLeafCount</name>
                            =
                            <name>leafCount</name>
                        </expr>
                        ;
                    </expr_stmt>


                    <comment type="line">// this is for Schema Mixed Content</comment>
                    <expr_stmt>
                        <expr>
                            <name>fMixed</name>
                            =
                            <name>mixed</name>
                        </expr>
                        ;
                    </expr_stmt>

                    <comment type="line">//</comment>
                    <comment type="line">// Ok, so lets grind through the building of the DFA. This method</comment>
                    <comment type="line">// handles the high level logic of the algorithm, but it uses a</comment>
                    <comment type="line">// number of helper classes to do its thing.</comment>
                    <comment type="line">//</comment>
                    <comment type="line">// In order to avoid having hundreds of references to the error and</comment>
                    <comment type="line">// string handlers around, this guy and all of his helper classes</comment>
                    <comment type="line">// just throw a simple exception and we then pass it along.</comment>
                    <comment type="line">//</comment>
                    <expr_stmt>
                        <expr>
                            <call>
                                <name>buildDFA</name>
                                <argument_list>(
                                    <argument>
                                        <expr>
                                            <name>syntaxTree</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    }
                </block>
            </constructor>

            <comment type="line">//</comment>
            <comment type="line">// ContentModelValidator methods</comment>
            <comment type="line">//</comment>

            <comment type="javadoc">/**
                * Check that the specified content is valid according to this
                * content model. This method can also be called to do 'what if'
                * testing of content models just to see if they would be valid.
                * &lt;p&gt;
                * A value of -1 in the children array indicates a PCDATA node. All other
                * indexes will be positive and represent child elements. The count can be
                * zero, since some elements have the EMPTY content model and that must be
                * confirmed.
                *
                * @param children The children of this element. Each integer is an index within
                * the &lt;code&gt;StringPool&lt;/code&gt; of the child element name. An index
                * of -1 is used to indicate an occurrence of non-whitespace character
                * data.
                * @param offset Offset into the array where the children starts.
                * @param length The number of entries in the &lt;code&gt;children&lt;/code&gt; array.
                *
                * @return The value -1 if fully valid, else the 0 based index of the child
                * that first failed. If the value returned is equal to the number
                * of children, then the specified children are valid but additional
                * content is required to reach a valid ending state.
                *
                */
            </comment>
            <function>
                <type>
                    <specifier>public</specifier>
                    <name>int</name>
                </type>
                <name>validate</name>
                <parameter_list>(
                    <param>
                        <decl>
                            <type>
                                <name>
                                    <name>QName</name>
                                    <index>[]</index>
                                </name>
                            </type>
                            <name>children</name>
                        </decl>
                    </param>
                    ,
                    <param>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>offset</name>
                        </decl>
                    </param>
                    ,
                    <param>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>length</name>
                        </decl>
                    </param>
                    )
                </parameter_list>
                <block>{

                    <if>if
                        <condition>(
                            <expr>
                                <name>DEBUG_VALIDATE_CONTENT</name>
                            </expr>
                            )
                        </condition>
                        <then>
                            <expr_stmt>
                                <expr>
                                    <call>
                                        <name><name>System</name>.<name>out</name>.
                                            <name>println</name>
                                        </name>
                                        <argument_list>(
                                            <argument>
                                                <expr>"DFAContentModel#validateContent"</expr>
                                            </argument>
                                            )
                                        </argument_list>
                                    </call>
                                </expr>
                                ;
                            </expr_stmt>
                        </then>
                    </if>

                    <comment type="line">//</comment>
                    <comment type="line">// A DFA content model must *always* have at least 1 child</comment>
                    <comment type="line">// so a failure is given if no children present.</comment>
                    <comment type="line">//</comment>
                    <comment type="line">// Defect 782: This is an incorrect statement because a DFA</comment>
                    <comment type="line">// content model is also used for constructions such as:</comment>
                    <comment type="line">//</comment>
                    <comment type="line">// (Optional*,NotRequired?)</comment>
                    <comment type="line">//</comment>
                    <comment type="line">// where a perfectly valid content would be NO CHILDREN.</comment>
                    <comment type="line">// Therefore, if there are no children, we must check to</comment>
                    <comment type="line">// see if the CMNODE_EOC marker is a valid start state! -Ac</comment>
                    <comment type="line">//</comment>
                    <if>if
                        <condition>(
                            <expr>
                                <name>length</name>
                                == 0
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <if>if
                                    <condition>(
                                        <expr>
                                            <name>DEBUG_VALIDATE_CONTENT</name>
                                        </expr>
                                        )
                                    </condition>
                                    <then>
                                        <block>{
                                            <expr_stmt>
                                                <expr>
                                                    <call>
                                                        <name><name>System</name>.<name>out</name>.
                                                            <name>println</name>
                                                        </name>
                                                        <argument_list>(
                                                            <argument>
                                                                <expr>"!!! no children"</expr>
                                                            </argument>
                                                            )
                                                        </argument_list>
                                                    </call>
                                                </expr>
                                                ;
                                            </expr_stmt>
                                            <expr_stmt>
                                                <expr>
                                                    <call>
                                                        <name><name>System</name>.<name>out</name>.
                                                            <name>println</name>
                                                        </name>
                                                        <argument_list>(
                                                            <argument>
                                                                <expr>"elemMap="+
                                                                    <name>fElemMap</name>
                                                                </expr>
                                                            </argument>
                                                            )
                                                        </argument_list>
                                                    </call>
                                                </expr>
                                                ;
                                            </expr_stmt>
                                            <for>for (
                                                <init>
                                                    <decl>
                                                        <type>
                                                            <name>int</name>
                                                        </type>
                                                        <name>i</name> =
                                                        <init>
                                                            <expr>0</expr>
                                                        </init>
                                                    </decl>
                                                    ;
                                                </init>
                                                <condition>
                                                    <expr>
                                                        <name>i</name>
                                                        &lt;
                                                        <name><name>fElemMap</name>.
                                                            <name>length</name>
                                                        </name>
                                                    </expr>
                                                    ;
                                                </condition>
                                                <incr>
                                                    <expr><name>i</name>++
                                                    </expr>
                                                </incr>
                                                )
                                                <block>{
                                                    <decl_stmt>
                                                        <decl>
                                                            <type>
                                                                <name>String</name>
                                                            </type>
                                                            <name>uri</name> =
                                                            <init>
                                                                <expr>
                                                                    <name>
                                                                        <name>fElemMap</name>
                                                                        <index>[
                                                                            <expr>
                                                                                <name>i</name>
                                                                            </expr>
                                                                            ]
                                                                        </index>
                                                                    </name>
                                                                    .
                                                                    <name>uri</name>
                                                                </expr>
                                                            </init>
                                                        </decl>
                                                        ;
                                                    </decl_stmt>
                                                    <decl_stmt>
                                                        <decl>
                                                            <type>
                                                                <name>String</name>
                                                            </type>
                                                            <name>localpart</name> =
                                                            <init>
                                                                <expr>
                                                                    <name>
                                                                        <name>fElemMap</name>
                                                                        <index>[
                                                                            <expr>
                                                                                <name>i</name>
                                                                            </expr>
                                                                            ]
                                                                        </index>
                                                                    </name>
                                                                    .
                                                                    <name>localpart</name>
                                                                </expr>
                                                            </init>
                                                        </decl>
                                                        ;
                                                    </decl_stmt>

                                                    <expr_stmt>
                                                        <expr>
                                                            <call>
                                                                <name><name>System</name>.<name>out</name>.
                                                                    <name>println</name>
                                                                </name>
                                                                <argument_list>(
                                                                    <argument>
                                                                        <expr>"fElemMap["+<name>i</name>+"]="+<name>
                                                                            uri</name>+","+
                                                                            <name>localpart</name>+" ("+
                                                                            <name>uri</name>+", "+
                                                                            <name>localpart</name>+
                                                                            ')'
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                        ;
                                                    </expr_stmt>

                                                    }
                                                </block>
                                            </for>
                                            <expr_stmt>
                                                <expr>
                                                    <call>
                                                        <name><name>System</name>.<name>out</name>.
                                                            <name>println</name>
                                                        </name>
                                                        <argument_list>(
                                                            <argument>
                                                                <expr>"EOCIndex="+
                                                                    <name>fEOCString</name>
                                                                </expr>
                                                            </argument>
                                                            )
                                                        </argument_list>
                                                    </call>
                                                </expr>
                                                ;
                                            </expr_stmt>
                                            }
                                        </block>
                                    </then>
                                </if>

                                <return>return
                                    <expr>
                                        <name>fEmptyContentIsValid</name>
                                        ? -1 : 0
                                    </expr>
                                    ;
                                </return>

                                }
                            </block>
                        </then>
                    </if>
                    <comment type="line">// if child count == 0</comment>

                    <comment type="line">//</comment>
                    <comment type="line">// Lets loop through the children in the array and move our way</comment>
                    <comment type="line">// through the states. Note that we use the fElemMap array to map</comment>
                    <comment type="line">// an element index to a state index.</comment>
                    <comment type="line">//</comment>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>curState</name> =
                            <init>
                                <expr>0</expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <for>for (
                        <init>
                            <decl>
                                <type>
                                    <name>int</name>
                                </type>
                                <name>childIndex</name> =
                                <init>
                                    <expr>0</expr>
                                </init>
                            </decl>
                            ;
                        </init>
                        <condition>
                            <expr>
                                <name>childIndex</name>
                                &lt;
                                <name>length</name>
                            </expr>
                            ;
                        </condition>
                        <incr>
                            <expr><name>childIndex</name>++
                            </expr>
                        </incr>
                        )
                        <block>{
                            <comment type="line">// Get the current element index out</comment>
                            <decl_stmt>
                                <decl>
                                    <type>
                                        <specifier>final</specifier>
                                        <name>QName</name>
                                    </type>
                                    <name>curElem</name> =
                                    <init>
                                        <expr>
                                            <name>
                                                <name>children</name>
                                                <index>[
                                                    <expr>
                                                        <name>offset</name>
                                                        +
                                                        <name>childIndex</name>
                                                    </expr>
                                                    ]
                                                </index>
                                            </name>
                                        </expr>
                                    </init>
                                </decl>
                                ;
                            </decl_stmt>
                            <comment type="line">// ignore mixed text</comment>
                            <if>if
                                <condition>(
                                    <expr>
                                        <name>fMixed</name>
                                        &amp;&amp;
                                        <name><name>curElem</name>.
                                            <name>localpart</name>
                                        </name>
                                        ==
                                        <name>null</name>
                                    </expr>
                                    )
                                </condition>
                                <then>
                                    <block>{
                                        <continue>continue;</continue>
                                        }
                                    </block>
                                </then>
                            </if>

                            <comment type="line">// Look up this child in our element map</comment>
                            <decl_stmt>
                                <decl>
                                    <type>
                                        <name>int</name>
                                    </type>
                                    <name>elemIndex</name> =
                                    <init>
                                        <expr>0</expr>
                                    </init>
                                </decl>
                                ;
                            </decl_stmt>
                            <for>for (<init>;</init>
                                <condition>
                                    <expr>
                                        <name>elemIndex</name>
                                        &lt;
                                        <name>fElemMapSize</name>
                                    </expr>
                                    ;
                                </condition>
                                <incr>
                                    <expr><name>elemIndex</name>++
                                    </expr>
                                </incr>
                                )
                                <block>{
                                    <decl_stmt>
                                        <decl>
                                            <type>
                                                <name>int</name>
                                            </type>
                                            <name>type</name> =
                                            <init>
                                                <expr>
                                                    <name>
                                                        <name>fElemMapType</name>
                                                        <index>[
                                                            <expr>
                                                                <name>elemIndex</name>
                                                            </expr>
                                                            ]
                                                        </index>
                                                    </name>
                                                    &amp; 0x0f
                                                </expr>
                                            </init>
                                        </decl>
                                        ;
                                    </decl_stmt>
                                    <if>if
                                        <condition>(
                                            <expr>
                                                <name>type</name>
                                                ==
                                                <name><name>XMLContentSpec</name>.
                                                    <name>CONTENTSPECNODE_LEAF</name>
                                                </name>
                                            </expr>
                                            )
                                        </condition>
                                        <then>
                                            <block>{
                                                <comment type="line">//System.out.println("fElemMap["+elemIndex+"]:
                                                    "+fElemMap[elemIndex]);
                                                </comment>
                                                <if>if
                                                    <condition>(
                                                        <expr>
                                                            <name>
                                                                <name>fElemMap</name>
                                                                <index>[
                                                                    <expr>
                                                                        <name>elemIndex</name>
                                                                    </expr>
                                                                    ]
                                                                </index>
                                                            </name>
                                                            .<name>rawname</name> ==
                                                            <name><name>curElem</name>.
                                                                <name>rawname</name>
                                                            </name>
                                                        </expr>
                                                        )
                                                    </condition>
                                                    <then>
                                                        <block>{
                                                            <break>break;</break>
                                                            }
                                                        </block>
                                                    </then>
                                                </if>
                                                }
                                            </block>
                                        </then>
                                        <else>else
                                            <if>if
                                                <condition>(
                                                    <expr>
                                                        <name>type</name>
                                                        ==
                                                        <name><name>XMLContentSpec</name>.
                                                            <name>CONTENTSPECNODE_ANY</name>
                                                        </name>
                                                    </expr>
                                                    )
                                                </condition>
                                                <then>
                                                    <block>{
                                                        <decl_stmt>
                                                            <decl>
                                                                <type>
                                                                    <name>String</name>
                                                                </type>
                                                                <name>uri</name> =
                                                                <init>
                                                                    <expr>
                                                                        <name>
                                                                            <name>fElemMap</name>
                                                                            <index>[
                                                                                <expr>
                                                                                    <name>elemIndex</name>
                                                                                </expr>
                                                                                ]
                                                                            </index>
                                                                        </name>
                                                                        .
                                                                        <name>uri</name>
                                                                    </expr>
                                                                </init>
                                                            </decl>
                                                            ;
                                                        </decl_stmt>
                                                        <if>if
                                                            <condition>(
                                                                <expr>
                                                                    <name>uri</name>
                                                                    == <name>null</name> || <name>uri</name> ==
                                                                    <name><name>curElem</name>.
                                                                        <name>uri</name>
                                                                    </name>
                                                                </expr>
                                                                )
                                                            </condition>
                                                            <then>
                                                                <block>{
                                                                    <break>break;</break>
                                                                    }
                                                                </block>
                                                            </then>
                                                        </if>
                                                        }
                                                    </block>
                                                </then>
                                                <else>else
                                                    <if>if
                                                        <condition>(
                                                            <expr>
                                                                <name>type</name>
                                                                ==
                                                                <name><name>XMLContentSpec</name>.
                                                                    <name>CONTENTSPECNODE_ANY_LOCAL</name>
                                                                </name>
                                                            </expr>
                                                            )
                                                        </condition>
                                                        <then>
                                                            <block>{
                                                                <if>if
                                                                    <condition>(
                                                                        <expr>
                                                                            <name><name>curElem</name>.
                                                                                <name>uri</name>
                                                                            </name>
                                                                            ==
                                                                            <name>null</name>
                                                                        </expr>
                                                                        )
                                                                    </condition>
                                                                    <then>
                                                                        <block>{
                                                                            <break>break;</break>
                                                                            }
                                                                        </block>
                                                                    </then>
                                                                </if>
                                                                }
                                                            </block>
                                                        </then>
                                                        <else>else
                                                            <if>if
                                                                <condition>(
                                                                    <expr>
                                                                        <name>type</name>
                                                                        ==
                                                                        <name><name>XMLContentSpec</name>.
                                                                            <name>CONTENTSPECNODE_ANY_OTHER</name>
                                                                        </name>
                                                                    </expr>
                                                                    )
                                                                </condition>
                                                                <then>
                                                                    <block>{
                                                                        <if>if
                                                                            <condition>(
                                                                                <expr>
                                                                                    <name>
                                                                                        <name>fElemMap</name>
                                                                                        <index>[
                                                                                            <expr>
                                                                                                <name>elemIndex</name>
                                                                                            </expr>
                                                                                            ]
                                                                                        </index>
                                                                                    </name>
                                                                                    .<name>uri</name> !=
                                                                                    <name><name>curElem</name>.
                                                                                        <name>uri</name>
                                                                                    </name>
                                                                                </expr>
                                                                                )
                                                                            </condition>
                                                                            <then>
                                                                                <block>{
                                                                                    <break>break;</break>
                                                                                    }
                                                                                </block>
                                                                            </then>
                                                                        </if>
                                                                        }
                                                                    </block>
                                                                </then>
                                                            </if>
                                                        </else>
                                                    </if>
                                                </else>
                                            </if>
                                        </else>
                                    </if>
                                    }
                                </block>
                            </for>

                            <comment type="line">// If we didn't find it, then obviously not valid</comment>
                            <if>if
                                <condition>(
                                    <expr>
                                        <name>elemIndex</name>
                                        ==
                                        <name>fElemMapSize</name>
                                    </expr>
                                    )
                                </condition>
                                <then>
                                    <block>{
                                        <if>if
                                            <condition>(
                                                <expr>
                                                    <name>DEBUG_VALIDATE_CONTENT</name>
                                                </expr>
                                                )
                                            </condition>
                                            <then>
                                                <block>{
                                                    <expr_stmt>
                                                        <expr>
                                                            <call>
                                                                <name><name>System</name>.<name>out</name>.
                                                                    <name>println</name>
                                                                </name>
                                                                <argument_list>(
                                                                    <argument>
                                                                        <expr>"!!! didn't find it"</expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                        ;
                                                    </expr_stmt>

                                                    <expr_stmt>
                                                        <expr>
                                                            <call>
                                                                <name><name>System</name>.<name>out</name>.
                                                                    <name>println</name>
                                                                </name>
                                                                <argument_list>(
                                                                    <argument>
                                                                        <expr>"curElem : " +
                                                                            <name>curElem</name>
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                        ;
                                                    </expr_stmt>
                                                    <for>for (
                                                        <init>
                                                            <decl>
                                                                <type>
                                                                    <name>int</name>
                                                                </type>
                                                                <name>i</name>=
                                                                <init>
                                                                    <expr>0</expr>
                                                                </init>
                                                            </decl>
                                                            ;
                                                        </init>
                                                        <condition>
                                                            <expr><name>i</name>&lt;
                                                                <name>fElemMapSize</name>
                                                            </expr>
                                                            ;
                                                        </condition>
                                                        <incr>
                                                            <expr><name>i</name>++
                                                            </expr>
                                                        </incr>
                                                        )
                                                        <block>{
                                                            <expr_stmt>
                                                                <expr>
                                                                    <call>
                                                                        <name><name>System</name>.<name>out</name>.
                                                                            <name>println</name>
                                                                        </name>
                                                                        <argument_list>(
                                                                            <argument>
                                                                                <expr>"fElemMap["+<name>i</name>+"] = "
                                                                                    +
                                                                                    <name>
                                                                                        <name>fElemMap</name>
                                                                                        <index>[
                                                                                            <expr>
                                                                                                <name>i</name>
                                                                                            </expr>
                                                                                            ]
                                                                                        </index>
                                                                                    </name>
                                                                                </expr>
                                                                            </argument>
                                                                            )
                                                                        </argument_list>
                                                                    </call>
                                                                </expr>
                                                                ;
                                                            </expr_stmt>
                                                            <expr_stmt>
                                                                <expr>
                                                                    <call>
                                                                        <name><name>System</name>.<name>out</name>.
                                                                            <name>println</name>
                                                                        </name>
                                                                        <argument_list>(
                                                                            <argument>
                                                                                <expr>"fElemMapType["+<name>i</name>+"]
                                                                                    = " +
                                                                                    <name>
                                                                                        <name>fElemMapType</name>
                                                                                        <index>[
                                                                                            <expr>
                                                                                                <name>i</name>
                                                                                            </expr>
                                                                                            ]
                                                                                        </index>
                                                                                    </name>
                                                                                </expr>
                                                                            </argument>
                                                                            )
                                                                        </argument_list>
                                                                    </call>
                                                                </expr>
                                                                ;
                                                            </expr_stmt>
                                                            }
                                                        </block>
                                                    </for>
                                                    }
                                                </block>
                                            </then>
                                        </if>

                                        <return>return
                                            <expr>
                                                <name>childIndex</name>
                                            </expr>
                                            ;
                                        </return>
                                        }
                                    </block>
                                </then>
                            </if>

                            <comment type="line">//</comment>
                            <comment type="line">// Look up the next state for this input symbol when in the</comment>
                            <comment type="line">// current state.</comment>
                            <comment type="line">//</comment>
                            <expr_stmt>
                                <expr>
                                    <name>curState</name>
                                    =
                                    <name>
                                        <name>fTransTable</name>
                                        <index>[
                                            <expr>
                                                <name>curState</name>
                                            </expr>
                                            ]
                                        </index>
                                        <index>[
                                            <expr>
                                                <name>elemIndex</name>
                                            </expr>
                                            ]
                                        </index>
                                    </name>
                                </expr>
                                ;
                            </expr_stmt>

                            <comment type="line">// If its not a legal transition, then invalid</comment>
                            <if>if
                                <condition>(
                                    <expr>
                                        <name>curState</name>
                                        == -1
                                    </expr>
                                    )
                                </condition>
                                <then>
                                    <block>{
                                        <if>if
                                            <condition>(
                                                <expr>
                                                    <name>DEBUG_VALIDATE_CONTENT</name>
                                                </expr>
                                                )
                                            </condition>
                                            <then>
                                                <expr_stmt>
                                                    <expr>
                                                        <call>
                                                            <name><name>System</name>.<name>out</name>.
                                                                <name>println</name>
                                                            </name>
                                                            <argument_list>(
                                                                <argument>
                                                                    <expr>"!!! not a legal transition"</expr>
                                                                </argument>
                                                                )
                                                            </argument_list>
                                                        </call>
                                                    </expr>
                                                    ;
                                                </expr_stmt>
                                            </then>
                                        </if>
                                        <return>return
                                            <expr>
                                                <name>childIndex</name>
                                            </expr>
                                            ;
                                        </return>
                                        }
                                    </block>
                                </then>
                            </if>
                            }
                        </block>
                    </for>

                    <comment type="line">//</comment>
                    <comment type="line">// We transitioned all the way through the input list. However, that</comment>
                    <comment type="line">// does not mean that we ended in a final state. So check whether</comment>
                    <comment type="line">// our ending state is a final state.</comment>
                    <comment type="line">//</comment>
                    <if>if
                        <condition>(
                            <expr>
                                <name>DEBUG_VALIDATE_CONTENT</name>
                            </expr>
                            )
                        </condition>
                        <then>
                            <expr_stmt>
                                <expr>
                                    <call>
                                        <name><name>System</name>.<name>out</name>.
                                            <name>println</name>
                                        </name>
                                        <argument_list>(
                                            <argument>
                                                <expr>"curState="+<name>curState</name>+", childCount="+
                                                    <name>length</name>
                                                </expr>
                                            </argument>
                                            )
                                        </argument_list>
                                    </call>
                                </expr>
                                ;
                            </expr_stmt>
                        </then>
                    </if>
                    <if>if
                        <condition>(
                            <expr>!
                                <name>
                                    <name>fFinalStateFlags</name>
                                    <index>[
                                        <expr>
                                            <name>curState</name>
                                        </expr>
                                        ]
                                    </index>
                                </name>
                            </expr>
                            )
                        </condition>
                        <then>
                            <return>return
                                <expr>
                                    <name>length</name>
                                </expr>
                                ;
                            </return>
                        </then>
                    </if>

                    <comment type="line">// success!</comment>
                    <return>return <expr>-1</expr>;
                    </return>
                    }
                </block>
            </function>
            <comment type="line">// validate</comment>


            <comment type="line">//</comment>
            <comment type="line">// Private methods</comment>
            <comment type="line">//</comment>

            <comment type="javadoc">/**
                * Builds the internal DFA transition table from the given syntax tree.
                *
                * @param syntaxTree The syntax tree.
                *
                * @exception CMException Thrown if DFA cannot be built.
                */
            </comment>
            <function>
                <type>
                    <specifier>private</specifier>
                    <name>void</name>
                </type>
                <name>buildDFA</name>
                <parameter_list>(
                    <param>
                        <decl>
                            <type>
                                <name>CMNode</name>
                            </type>
                            <name>syntaxTree</name>
                        </decl>
                    </param>
                    )
                </parameter_list>
                <block>{
                    <comment type="line">//</comment>
                    <comment type="line">// The first step we need to take is to rewrite the content model</comment>
                    <comment type="line">// using our CMNode objects, and in the process get rid of any</comment>
                    <comment type="line">// repetition short cuts, converting them into '*' style repetitions</comment>
                    <comment type="line">// or getting rid of repetitions altogether.</comment>
                    <comment type="line">//</comment>
                    <comment type="line">// The conversions done are:</comment>
                    <comment type="line">//</comment>
                    <comment type="line">// x+ -&gt; (x|x*)</comment>
                    <comment type="line">// x? -&gt; (x|epsilon)</comment>
                    <comment type="line">//</comment>
                    <comment type="line">// This is a relatively complex scenario. What is happening is that</comment>
                    <comment type="line">// we create a top level binary node of which the special EOC value</comment>
                    <comment type="line">// is set as the right side node. The the left side is set to the</comment>
                    <comment type="line">// rewritten syntax tree. The source is the original content model</comment>
                    <comment type="line">// info from the decl pool. The rewrite is done by buildSyntaxTree()</comment>
                    <comment type="line">// which recurses the decl pool's content of the element and builds</comment>
                    <comment type="line">// a new tree in the process.</comment>
                    <comment type="line">//</comment>
                    <comment type="line">// Note that, during this operation, we set each non-epsilon leaf</comment>
                    <comment type="line">// node's DFA state position and count the number of such leafs, which
                    </comment>
                    <comment type="line">// is left in the fLeafCount member.</comment>
                    <comment type="line">//</comment>
                    <comment type="line">// The nodeTmp object is passed in just as a temp node to use during</comment>
                    <comment type="line">// the recursion. Otherwise, we'd have to create a new node on every</comment>
                    <comment type="line">// level of recursion, which would be piggy in Java (as is everything</comment>
                    <comment type="line">// for that matter.)</comment>
                    <comment type="line">//</comment>

                    <comment type="block">/* MODIFIED (Jan, 2001)
                        *
                        * Use following rules.
                        * nullable(x+) := nullable(x), first(x+) := first(x), last(x+) := last(x)
                        * nullable(x?) := true, first(x?) := first(x), last(x?) := last(x)
                        *
                        * The same computation of follow as x* is applied to x+
                        *
                        * The modification drastically reduces computation time of
                        * "(a, (b, a+, (c, (b, a+)+, a+, (d, (c, (b, a+)+, a+)+, (b, a+)+, a+)+)+)+)+"
                        */
                    </comment>

                    <expr_stmt>
                        <expr>
                            <call>
                                <name><name>fQName</name>.
                                    <name>setValues</name>
                                </name>
                                <argument_list>(
                                    <argument>
                                        <expr>
                                            <name>null</name>
                                        </expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>
                                            <name>fEOCString</name>
                                        </expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>
                                            <name>fEOCString</name>
                                        </expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>
                                            <name>null</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>CMLeaf</name>
                            </type>
                            <name>nodeEOC</name> =
                            <init>
                                <expr>new
                                    <call>
                                        <name>CMLeaf</name>
                                        <argument_list>(
                                            <argument>
                                                <expr>
                                                    <name>fQName</name>
                                                </expr>
                                            </argument>
                                            )
                                        </argument_list>
                                    </call>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <expr_stmt>
                        <expr>
                            <name>fHeadNode</name>
                            = new
                            <call>
                                <name>CMBinOp</name>
                                <argument_list>(
                                    <argument>
                                        <expr>
                                            <name><name>XMLContentSpec</name>.
                                                <name>CONTENTSPECNODE_SEQ</name>
                                            </name>
                                        </expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>
                                            <name>syntaxTree</name>
                                        </expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>
                                            <name>nodeEOC</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <comment type="line">//</comment>
                    <comment type="line">// And handle specially the EOC node, which also must be numbered</comment>
                    <comment type="line">// and counted as a non-epsilon leaf node. It could not be handled</comment>
                    <comment type="line">// in the above tree build because it was created before all that</comment>
                    <comment type="line">// started. We save the EOC position since its used during the DFA</comment>
                    <comment type="line">// building loop.</comment>
                    <comment type="line">//</comment>
                    <expr_stmt>
                        <expr>
                            <name>fEOCPos</name>
                            =
                            <name>fLeafCount</name>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <call>
                                <name><name>nodeEOC</name>.
                                    <name>setPosition</name>
                                </name>
                                <argument_list>(
                                    <argument>
                                        <expr><name>fLeafCount</name>++
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <comment type="line">//</comment>
                    <comment type="line">// Ok, so now we have to iterate the new tree and do a little more</comment>
                    <comment type="line">// work now that we know the leaf count. One thing we need to do is</comment>
                    <comment type="line">// to calculate the first and last position sets of each node. This</comment>
                    <comment type="line">// is cached away in each of the nodes.</comment>
                    <comment type="line">//</comment>
                    <comment type="line">// Along the way we also set the leaf count in each node as the</comment>
                    <comment type="line">// maximum state count. They must know this in order to create their</comment>
                    <comment type="line">// first/last pos sets.</comment>
                    <comment type="line">//</comment>
                    <comment type="line">// We also need to build an array of references to the non-epsilon</comment>
                    <comment type="line">// leaf nodes. Since we iterate it in the same way as before, this</comment>
                    <comment type="line">// will put them in the array according to their position values.</comment>
                    <comment type="line">//</comment>
                    <expr_stmt>
                        <expr>
                            <name>fLeafList</name>
                            = new
                            <name>
                                <name>CMLeaf</name>
                                <index>[
                                    <expr>
                                        <name>fLeafCount</name>
                                    </expr>
                                    ]
                                </index>
                            </name>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <name>fLeafListType</name>
                            = new
                            <name>
                                <name>int</name>
                                <index>[
                                    <expr>
                                        <name>fLeafCount</name>
                                    </expr>
                                    ]
                                </index>
                            </name>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <call>
                                <name>postTreeBuildInit</name>
                                <argument_list>(
                                    <argument>
                                        <expr>
                                            <name>fHeadNode</name>
                                        </expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>0</expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <comment type="line">//</comment>
                    <comment type="line">// And, moving onward... We now need to build the follow position</comment>
                    <comment type="line">// sets for all the nodes. So we allocate an array of state sets,</comment>
                    <comment type="line">// one for each leaf node (i.e. each DFA position.)</comment>
                    <comment type="line">//</comment>
                    <expr_stmt>
                        <expr>
                            <name>fFollowList</name>
                            = new
                            <name>
                                <name>CMStateSet</name>
                                <index>[
                                    <expr>
                                        <name>fLeafCount</name>
                                    </expr>
                                    ]
                                </index>
                            </name>
                        </expr>
                        ;
                    </expr_stmt>
                    <for>for (
                        <init>
                            <decl>
                                <type>
                                    <name>int</name>
                                </type>
                                <name>index</name> =
                                <init>
                                    <expr>0</expr>
                                </init>
                            </decl>
                            ;
                        </init>
                        <condition>
                            <expr>
                                <name>index</name>
                                &lt;
                                <name>fLeafCount</name>
                            </expr>
                            ;
                        </condition>
                        <incr>
                            <expr><name>index</name>++
                            </expr>
                        </incr>
                        )
                        <expr_stmt>
                            <expr>
                                <name>
                                    <name>fFollowList</name>
                                    <index>[
                                        <expr>
                                            <name>index</name>
                                        </expr>
                                        ]
                                    </index>
                                </name>
                                = new
                                <call>
                                    <name>CMStateSet</name>
                                    <argument_list>(
                                        <argument>
                                            <expr>
                                                <name>fLeafCount</name>
                                            </expr>
                                        </argument>
                                        )
                                    </argument_list>
                                </call>
                            </expr>
                            ;
                        </expr_stmt>
                    </for>
                    <expr_stmt>
                        <expr>
                            <call>
                                <name>calcFollowList</name>
                                <argument_list>(
                                    <argument>
                                        <expr>
                                            <name>fHeadNode</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <comment type="line">//</comment>
                    <comment type="line">// And finally the big push... Now we build the DFA using all the</comment>
                    <comment type="line">// states and the tree we've built up. First we set up the various</comment>
                    <comment type="line">// data structures we are going to use while we do this.</comment>
                    <comment type="line">//</comment>
                    <comment type="line">// First of all we need an array of unique element names in our</comment>
                    <comment type="line">// content model. For each transition table entry, we need a set of</comment>
                    <comment type="line">// contiguous indices to represent the transitions for a particular</comment>
                    <comment type="line">// input element. So we need to a zero based range of indexes that</comment>
                    <comment type="line">// map to element types. This element map provides that mapping.</comment>
                    <comment type="line">//</comment>
                    <expr_stmt>
                        <expr>
                            <name>fElemMap</name>
                            = new
                            <name>
                                <name>QName</name>
                                <index>[
                                    <expr>
                                        <name>fLeafCount</name>
                                    </expr>
                                    ]
                                </index>
                            </name>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <name>fElemMapType</name>
                            = new
                            <name>
                                <name>int</name>
                                <index>[
                                    <expr>
                                        <name>fLeafCount</name>
                                    </expr>
                                    ]
                                </index>
                            </name>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <name>fElemMapSize</name>
                            = 0
                        </expr>
                        ;
                    </expr_stmt>
                    <for>for (
                        <init>
                            <decl>
                                <type>
                                    <name>int</name>
                                </type>
                                <name>outIndex</name> =
                                <init>
                                    <expr>0</expr>
                                </init>
                            </decl>
                            ;
                        </init>
                        <condition>
                            <expr>
                                <name>outIndex</name>
                                &lt;
                                <name>fLeafCount</name>
                            </expr>
                            ;
                        </condition>
                        <incr>
                            <expr><name>outIndex</name>++
                            </expr>
                        </incr>
                        )
                        <block>{
                            <expr_stmt>
                                <expr>
                                    <name>
                                        <name>fElemMap</name>
                                        <index>[
                                            <expr>
                                                <name>outIndex</name>
                                            </expr>
                                            ]
                                        </index>
                                    </name>
                                    = new
                                    <call>
                                        <name>QName</name>
                                        <argument_list>()</argument_list>
                                    </call>
                                </expr>
                                ;
                            </expr_stmt>

                            <comment type="javadoc">/****
                                if ( (fLeafListType[outIndex] &amp; 0x0f) != 0 ) {
                                if (fLeafNameTypeVector == null) {
                                fLeafNameTypeVector = new ContentLeafNameTypeVector();
                                }
                                }
                                /****/
                            </comment>

                            <comment type="line">// Get the current leaf's element index</comment>
                            <decl_stmt>
                                <decl>
                                    <type>
                                        <specifier>final</specifier>
                                        <name>QName</name>
                                    </type>
                                    <name>element</name> =
                                    <init>
                                        <expr>
                                            <name>
                                                <name>fLeafList</name>
                                                <index>[
                                                    <expr>
                                                        <name>outIndex</name>
                                                    </expr>
                                                    ]
                                                </index>
                                            </name>
                                            .
                                            <call>
                                                <name>getElement</name>
                                                <argument_list>()</argument_list>
                                            </call>
                                        </expr>
                                    </init>
                                </decl>
                                ;
                            </decl_stmt>

                            <comment type="line">// See if the current leaf node's element index is in the list
                            </comment>
                            <decl_stmt>
                                <decl>
                                    <type>
                                        <name>int</name>
                                    </type>
                                    <name>inIndex</name> =
                                    <init>
                                        <expr>0</expr>
                                    </init>
                                </decl>
                                ;
                            </decl_stmt>
                            <for>for (<init>;</init>
                                <condition>
                                    <expr>
                                        <name>inIndex</name>
                                        &lt;
                                        <name>fElemMapSize</name>
                                    </expr>
                                    ;
                                </condition>
                                <incr>
                                    <expr><name>inIndex</name>++
                                    </expr>
                                </incr>
                                )
                                <block>{
                                    <if>if
                                        <condition>(
                                            <expr>
                                                <name>
                                                    <name>fElemMap</name>
                                                    <index>[
                                                        <expr>
                                                            <name>inIndex</name>
                                                        </expr>
                                                        ]
                                                    </index>
                                                </name>
                                                .<name>rawname</name> ==
                                                <name><name>element</name>.
                                                    <name>rawname</name>
                                                </name>
                                            </expr>
                                            )
                                        </condition>
                                        <then>
                                            <block>{
                                                <break>break;</break>
                                                }
                                            </block>
                                        </then>
                                    </if>
                                    }
                                </block>
                            </for>

                            <comment type="line">// If it was not in the list, then add it, if not the EOC node
                            </comment>
                            <if>if
                                <condition>(
                                    <expr>
                                        <name>inIndex</name>
                                        ==
                                        <name>fElemMapSize</name>
                                    </expr>
                                    )
                                </condition>
                                <then>
                                    <block>{
                                        <expr_stmt>
                                            <expr>
                                                <name>
                                                    <name>fElemMap</name>
                                                    <index>[
                                                        <expr>
                                                            <name>fElemMapSize</name>
                                                        </expr>
                                                        ]
                                                    </index>
                                                </name>
                                                .
                                                <call>
                                                    <name>setValues</name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>
                                                                <name>element</name>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        <expr_stmt>
                                            <expr>
                                                <name>
                                                    <name>fElemMapType</name>
                                                    <index>[
                                                        <expr>
                                                            <name>fElemMapSize</name>
                                                        </expr>
                                                        ]
                                                    </index>
                                                </name>
                                                =
                                                <name>
                                                    <name>fLeafListType</name>
                                                    <index>[
                                                        <expr>
                                                            <name>outIndex</name>
                                                        </expr>
                                                        ]
                                                    </index>
                                                </name>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        <expr_stmt>
                                            <expr><name>fElemMapSize</name>++
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        }
                                    </block>
                                </then>
                            </if>
                            }
                        </block>
                    </for>
                    <comment type="line">// set up the fLeafNameTypeVector object if there is one.</comment>
                    <comment type="javadoc">/*****
                        if (fLeafNameTypeVector != null) {
                        fLeafNameTypeVector.setValues(fElemMap, fElemMapType, fElemMapSize);
                        }

                        /***
                        * Optimization(Jan, 2001); We sort fLeafList according to
                        * elemIndex which is *uniquely* associated to each leaf.
                        * We are *assuming* that each element appears in at least one leaf.
                        **/
                    </comment>

                    <decl_stmt>
                        <decl>
                            <type>
                                <name>int</name>
                                <index>[]</index>
                            </type>
                            <name>fLeafSorter</name> =
                            <init>
                                <expr>new
                                    <name>
                                        <name>int</name>
                                        <index>[
                                            <expr>
                                                <name>fLeafCount</name>
                                                +
                                                <name>fElemMapSize</name>
                                            </expr>
                                            ]
                                        </index>
                                    </name>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>fSortCount</name> =
                            <init>
                                <expr>0</expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>

                    <for>for (
                        <init>
                            <decl>
                                <type>
                                    <name>int</name>
                                </type>
                                <name>elemIndex</name> =
                                <init>
                                    <expr>0</expr>
                                </init>
                            </decl>
                            ;
                        </init>
                        <condition>
                            <expr>
                                <name>elemIndex</name>
                                &lt;
                                <name>fElemMapSize</name>
                            </expr>
                            ;
                        </condition>
                        <incr>
                            <expr><name>elemIndex</name>++
                            </expr>
                        </incr>
                        )
                        <block>{
                            <for>for (
                                <init>
                                    <decl>
                                        <type>
                                            <name>int</name>
                                        </type>
                                        <name>leafIndex</name> =
                                        <init>
                                            <expr>0</expr>
                                        </init>
                                    </decl>
                                    ;
                                </init>
                                <condition>
                                    <expr>
                                        <name>leafIndex</name>
                                        &lt;
                                        <name>fLeafCount</name>
                                    </expr>
                                    ;
                                </condition>
                                <incr>
                                    <expr><name>leafIndex</name>++
                                    </expr>
                                </incr>
                                )
                                <block>{
                                    <decl_stmt>
                                        <decl>
                                            <type>
                                                <specifier>final</specifier>
                                                <name>QName</name>
                                            </type>
                                            <name>leaf</name> =
                                            <init>
                                                <expr>
                                                    <name>
                                                        <name>fLeafList</name>
                                                        <index>[
                                                            <expr>
                                                                <name>leafIndex</name>
                                                            </expr>
                                                            ]
                                                        </index>
                                                    </name>
                                                    .
                                                    <call>
                                                        <name>getElement</name>
                                                        <argument_list>()</argument_list>
                                                    </call>
                                                </expr>
                                            </init>
                                        </decl>
                                        ;
                                    </decl_stmt>
                                    <decl_stmt>
                                        <decl>
                                            <type>
                                                <specifier>final</specifier>
                                                <name>QName</name>
                                            </type>
                                            <name>element</name> =
                                            <init>
                                                <expr>
                                                    <name>
                                                        <name>fElemMap</name>
                                                        <index>[
                                                            <expr>
                                                                <name>elemIndex</name>
                                                            </expr>
                                                            ]
                                                        </index>
                                                    </name>
                                                </expr>
                                            </init>
                                        </decl>
                                        ;
                                    </decl_stmt>
                                    <if>if
                                        <condition>(
                                            <expr>
                                                <name><name>leaf</name>.
                                                    <name>rawname</name>
                                                </name>
                                                ==
                                                <name><name>element</name>.
                                                    <name>rawname</name>
                                                </name>
                                            </expr>
                                            )
                                        </condition>
                                        <then>
                                            <block>{
                                                <expr_stmt>
                                                    <expr>
                                                        <name>
                                                            <name>fLeafSorter</name>
                                                            <index>[
                                                                <expr><name>fSortCount</name>++
                                                                </expr>
                                                                ]
                                                            </index>
                                                        </name>
                                                        =
                                                        <name>leafIndex</name>
                                                    </expr>
                                                    ;
                                                </expr_stmt>
                                                }
                                            </block>
                                        </then>
                                    </if>
                                    }
                                </block>
                            </for>
                            <expr_stmt>
                                <expr>
                                    <name>
                                        <name>fLeafSorter</name>
                                        <index>[
                                            <expr><name>fSortCount</name>++
                                            </expr>
                                            ]
                                        </index>
                                    </name>
                                    = -1
                                </expr>
                                ;
                            </expr_stmt>
                            }
                        </block>
                    </for>

                    <comment type="block">/* Optimization(Jan, 2001) */</comment>

                    <comment type="line">//</comment>
                    <comment type="line">// Next lets create some arrays, some that that hold transient</comment>
                    <comment type="line">// information during the DFA build and some that are permament.</comment>
                    <comment type="line">// These are kind of sticky since we cannot know how big they will</comment>
                    <comment type="line">// get, but we don't want to use any Java collections because of</comment>
                    <comment type="line">// performance.</comment>
                    <comment type="line">//</comment>
                    <comment type="line">// Basically they will probably be about fLeafCount*2 on average,</comment>
                    <comment type="line">// but can be as large as 2^(fLeafCount*2), worst case. So we start</comment>
                    <comment type="line">// with fLeafCount*4 as a middle ground. This will be very unlikely</comment>
                    <comment type="line">// to ever have to expand, though it if does, the overhead will be</comment>
                    <comment type="line">// somewhat ugly.</comment>
                    <comment type="line">//</comment>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>curArraySize</name> =
                            <init>
                                <expr>
                                    <name>fLeafCount</name>
                                    * 4
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>CMStateSet</name>
                                <index>[]</index>
                            </type>
                            <name>statesToDo</name> =
                            <init>
                                <expr>new
                                    <name>
                                        <name>CMStateSet</name>
                                        <index>[
                                            <expr>
                                                <name>curArraySize</name>
                                            </expr>
                                            ]
                                        </index>
                                    </name>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <expr_stmt>
                        <expr>
                            <name>fFinalStateFlags</name>
                            = new
                            <name>
                                <name>boolean</name>
                                <index>[
                                    <expr>
                                        <name>curArraySize</name>
                                    </expr>
                                    ]
                                </index>
                            </name>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <name>fTransTable</name>
                            = new
                            <name>
                                <name>int</name>
                                <index>[
                                    <expr>
                                        <name>curArraySize</name>
                                    </expr>
                                    ]
                                </index>
                                <index>[]</index>
                            </name>
                        </expr>
                        ;
                    </expr_stmt>

                    <comment type="line">//</comment>
                    <comment type="line">// Ok we start with the initial set as the first pos set of the</comment>
                    <comment type="line">// head node (which is the seq node that holds the content model</comment>
                    <comment type="line">// and the EOC node.)</comment>
                    <comment type="line">//</comment>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>CMStateSet</name>
                            </type>
                            <name>setT</name> =
                            <init>
                                <expr>
                                    <call>
                                        <name><name>fHeadNode</name>.
                                            <name>firstPos</name>
                                        </name>
                                        <argument_list>()</argument_list>
                                    </call>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>

                    <comment type="line">//</comment>
                    <comment type="line">// Init our two state flags. Basically the unmarked state counter</comment>
                    <comment type="line">// is always chasing the current state counter. When it catches up,</comment>
                    <comment type="line">// that means we made a pass through that did not add any new states</comment>
                    <comment type="line">// to the lists, at which time we are done. We could have used a</comment>
                    <comment type="line">// expanding array of flags which we used to mark off states as we</comment>
                    <comment type="line">// complete them, but this is easier though less readable maybe.</comment>
                    <comment type="line">//</comment>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>unmarkedState</name> =
                            <init>
                                <expr>0</expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>curState</name> =
                            <init>
                                <expr>0</expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>

                    <comment type="line">//</comment>
                    <comment type="line">// Init the first transition table entry, and put the initial state</comment>
                    <comment type="line">// into the states to do list, then bump the current state.</comment>
                    <comment type="line">//</comment>
                    <expr_stmt>
                        <expr>
                            <name>
                                <name>fTransTable</name>
                                <index>[
                                    <expr>
                                        <name>curState</name>
                                    </expr>
                                    ]
                                </index>
                            </name>
                            =
                            <call>
                                <name>makeDefStateList</name>
                                <argument_list>()</argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <name>
                                <name>statesToDo</name>
                                <index>[
                                    <expr>
                                        <name>curState</name>
                                    </expr>
                                    ]
                                </index>
                            </name>
                            =
                            <name>setT</name>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr><name>curState</name>++
                        </expr>
                        ;
                    </expr_stmt>

                    <comment type="block">/* Optimization(Jan, 2001); This is faster for
                        * a large content model such as, "(t001+|t002+|.... |t500+)".
                        */
                    </comment>

                    <decl_stmt>
                        <decl>
                            <type>
                                <name><name>java</name>.<name>util</name>.
                                    <name>Hashtable</name>
                                </name>
                            </type>
                            <name>stateTable</name> =
                            <init>
                                <expr>new
                                    <call>
                                        <name><name>java</name>.<name>util</name>.
                                            <name>Hashtable</name>
                                        </name>
                                        <argument_list>()</argument_list>
                                    </call>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>

                    <comment type="block">/* Optimization(Jan, 2001) */</comment>

                    <comment type="line">//</comment>
                    <comment type="line">// Ok, almost done with the algorithm... We now enter the</comment>
                    <comment type="line">// loop where we go until the states done counter catches up with</comment>
                    <comment type="line">// the states to do counter.</comment>
                    <comment type="line">//</comment>
                    <while>while
                        <condition>(
                            <expr>
                                <name>unmarkedState</name>
                                &lt;
                                <name>curState</name>
                            </expr>
                            )
                        </condition>
                        <block>{
                            <comment type="line">//</comment>
                            <comment type="line">// Get the first unmarked state out of the list of states to do.
                            </comment>
                            <comment type="line">// And get the associated transition table entry.</comment>
                            <comment type="line">//</comment>
                            <expr_stmt>
                                <expr>
                                    <name>setT</name>
                                    =
                                    <name>
                                        <name>statesToDo</name>
                                        <index>[
                                            <expr>
                                                <name>unmarkedState</name>
                                            </expr>
                                            ]
                                        </index>
                                    </name>
                                </expr>
                                ;
                            </expr_stmt>
                            <decl_stmt>
                                <decl>
                                    <type>
                                        <name>int</name>
                                        <index>[]</index>
                                    </type>
                                    <name>transEntry</name> =
                                    <init>
                                        <expr>
                                            <name>
                                                <name>fTransTable</name>
                                                <index>[
                                                    <expr>
                                                        <name>unmarkedState</name>
                                                    </expr>
                                                    ]
                                                </index>
                                            </name>
                                        </expr>
                                    </init>
                                </decl>
                                ;
                            </decl_stmt>

                            <comment type="line">// Mark this one final if it contains the EOC state</comment>
                            <expr_stmt>
                                <expr>
                                    <name>
                                        <name>fFinalStateFlags</name>
                                        <index>[
                                            <expr>
                                                <name>unmarkedState</name>
                                            </expr>
                                            ]
                                        </index>
                                    </name>
                                    =
                                    <call>
                                        <name><name>setT</name>.
                                            <name>getBit</name>
                                        </name>
                                        <argument_list>(
                                            <argument>
                                                <expr>
                                                    <name>fEOCPos</name>
                                                </expr>
                                            </argument>
                                            )
                                        </argument_list>
                                    </call>
                                </expr>
                                ;
                            </expr_stmt>

                            <comment type="line">// Bump up the unmarked state count, marking this state done</comment>
                            <expr_stmt>
                                <expr><name>unmarkedState</name>++
                                </expr>
                                ;
                            </expr_stmt>

                            <comment type="line">// Loop through each possible input symbol in the element map</comment>
                            <decl_stmt>
                                <decl>
                                    <type>
                                        <name>CMStateSet</name>
                                    </type>
                                    <name>newSet</name> =
                                    <init>
                                        <expr>
                                            <name>null</name>
                                        </expr>
                                    </init>
                                </decl>
                                ;
                            </decl_stmt>
                            <comment type="block">/* Optimization(Jan, 2001) */</comment>
                            <decl_stmt>
                                <decl>
                                    <type>
                                        <name>int</name>
                                    </type>
                                    <name>sorterIndex</name> =
                                    <init>
                                        <expr>0</expr>
                                    </init>
                                </decl>
                                ;
                            </decl_stmt>
                            <comment type="block">/* Optimization(Jan, 2001) */</comment>
                            <for>for (
                                <init>
                                    <decl>
                                        <type>
                                            <name>int</name>
                                        </type>
                                        <name>elemIndex</name> =
                                        <init>
                                            <expr>0</expr>
                                        </init>
                                    </decl>
                                    ;
                                </init>
                                <condition>
                                    <expr>
                                        <name>elemIndex</name>
                                        &lt;
                                        <name>fElemMapSize</name>
                                    </expr>
                                    ;
                                </condition>
                                <incr>
                                    <expr><name>elemIndex</name>++
                                    </expr>
                                </incr>
                                )
                                <block>{
                                    <comment type="line">//</comment>
                                    <comment type="line">// Build up a set of states which is the union of all of
                                    </comment>
                                    <comment type="line">// the follow sets of DFA positions that are in the current
                                    </comment>
                                    <comment type="line">// state. If we gave away the new set last time through then
                                    </comment>
                                    <comment type="line">// create a new one. Otherwise, zero out the existing one.
                                    </comment>
                                    <comment type="line">//</comment>
                                    <if>if
                                        <condition>(
                                            <expr>
                                                <name>newSet</name>
                                                ==
                                                <name>null</name>
                                            </expr>
                                            )
                                        </condition>
                                        <then>
                                            <expr_stmt>
                                                <expr>
                                                    <name>newSet</name>
                                                    = new
                                                    <call>
                                                        <name>CMStateSet</name>
                                                        <argument_list>(
                                                            <argument>
                                                                <expr>
                                                                    <name>fLeafCount</name>
                                                                </expr>
                                                            </argument>
                                                            )
                                                        </argument_list>
                                                    </call>
                                                </expr>
                                                ;
                                            </expr_stmt>
                                        </then>
                                        <else>else
                                            <expr_stmt>
                                                <expr>
                                                    <call>
                                                        <name><name>newSet</name>.
                                                            <name>zeroBits</name>
                                                        </name>
                                                        <argument_list>()</argument_list>
                                                    </call>
                                                </expr>
                                                ;
                                            </expr_stmt>
                                        </else>
                                    </if>

                                    <comment type="block">/* Optimization(Jan, 2001) */</comment>
                                    <decl_stmt>
                                        <decl>
                                            <type>
                                                <name>int</name>
                                            </type>
                                            <name>leafIndex</name> =
                                            <init>
                                                <expr>
                                                    <name>
                                                        <name>fLeafSorter</name>
                                                        <index>[
                                                            <expr><name>sorterIndex</name>++
                                                            </expr>
                                                            ]
                                                        </index>
                                                    </name>
                                                </expr>
                                            </init>
                                        </decl>
                                        ;
                                    </decl_stmt>

                                    <while>while
                                        <condition>(
                                            <expr>
                                                <name>leafIndex</name>
                                                != -1
                                            </expr>
                                            )
                                        </condition>
                                        <block>{
                                            <comment type="line">// If this leaf index (DFA position) is in the current
                                                set...
                                            </comment>
                                            <if>if
                                                <condition>(
                                                    <expr>
                                                        <call>
                                                            <name><name>setT</name>.
                                                                <name>getBit</name>
                                                            </name>
                                                            <argument_list>(
                                                                <argument>
                                                                    <expr>
                                                                        <name>leafIndex</name>
                                                                    </expr>
                                                                </argument>
                                                                )
                                                            </argument_list>
                                                        </call>
                                                    </expr>
                                                    )
                                                </condition>
                                                <then>
                                                    <block>{
                                                        <comment type="line">//</comment>
                                                        <comment type="line">// If this leaf is the current input
                                                            symbol, then we
                                                        </comment>
                                                        <comment type="line">// want to add its follow list to the set
                                                            of states to
                                                        </comment>
                                                        <comment type="line">// transition to from the current state.
                                                        </comment>
                                                        <comment type="line">//</comment>
                                                        <expr_stmt>
                                                            <expr>
                                                                <call>
                                                                    <name><name>newSet</name>.
                                                                        <name>union</name>
                                                                    </name>
                                                                    <argument_list>(
                                                                        <argument>
                                                                            <expr>
                                                                                <name>
                                                                                    <name>fFollowList</name>
                                                                                    <index>[
                                                                                        <expr>
                                                                                            <name>leafIndex</name>
                                                                                        </expr>
                                                                                        ]
                                                                                    </index>
                                                                                </name>
                                                                            </expr>
                                                                        </argument>
                                                                        )
                                                                    </argument_list>
                                                                </call>
                                                            </expr>
                                                            ;
                                                        </expr_stmt>
                                                        }
                                                    </block>
                                                </then>
                                            </if>

                                            <expr_stmt>
                                                <expr>
                                                    <name>leafIndex</name>
                                                    =
                                                    <name>
                                                        <name>fLeafSorter</name>
                                                        <index>[
                                                            <expr><name>sorterIndex</name>++
                                                            </expr>
                                                            ]
                                                        </index>
                                                    </name>
                                                </expr>
                                                ;
                                            </expr_stmt>
                                            }
                                        </block>
                                    </while>
                                    <comment type="block">/* Optimization(Jan, 2001) */</comment>

                                    <comment type="line">//</comment>
                                    <comment type="line">// If this new set is not empty, then see if its in the list
                                    </comment>
                                    <comment type="line">// of states to do. If not, then add it.</comment>
                                    <comment type="line">//</comment>
                                    <if>if
                                        <condition>(
                                            <expr>!
                                                <call>
                                                    <name><name>newSet</name>.
                                                        <name>isEmpty</name>
                                                    </name>
                                                    <argument_list>()</argument_list>
                                                </call>
                                            </expr>
                                            )
                                        </condition>
                                        <then>
                                            <block>{
                                                <comment type="line">//</comment>
                                                <comment type="line">// Search the 'states to do' list to see if this
                                                    new
                                                </comment>
                                                <comment type="line">// state set is already in there.</comment>
                                                <comment type="line">//</comment>

                                                <comment type="block">/* Optimization(Jan, 2001) */</comment>
                                                <decl_stmt>
                                                    <decl>
                                                        <type>
                                                            <name>Integer</name>
                                                        </type>
                                                        <name>stateObj</name> =
                                                        <init>
                                                            <expr>(<name>Integer</name>)
                                                                <call>
                                                                    <name><name>stateTable</name>.
                                                                        <name>get</name>
                                                                    </name>
                                                                    <argument_list>(
                                                                        <argument>
                                                                            <expr>
                                                                                <name>newSet</name>
                                                                            </expr>
                                                                        </argument>
                                                                        )
                                                                    </argument_list>
                                                                </call>
                                                            </expr>
                                                        </init>
                                                    </decl>
                                                    ;
                                                </decl_stmt>
                                                <decl_stmt>
                                                    <decl>
                                                        <type>
                                                            <name>int</name>
                                                        </type>
                                                        <name>stateIndex</name> =
                                                        <init>
                                                            <expr>(<name>stateObj</name> == <name>null</name> ? <name>
                                                                curState
                                                            </name> :
                                                                <call>
                                                                    <name><name>stateObj</name>.
                                                                        <name>intValue</name>
                                                                    </name>
                                                                    <argument_list>()</argument_list>
                                                                </call>
                                                                )
                                                            </expr>
                                                        </init>
                                                    </decl>
                                                    ;
                                                </decl_stmt>
                                                <comment type="block">/* Optimization(Jan, 2001) */</comment>

                                                <comment type="line">// If we did not find it, then add it</comment>
                                                <if>if
                                                    <condition>(
                                                        <expr>
                                                            <name>stateIndex</name>
                                                            ==
                                                            <name>curState</name>
                                                        </expr>
                                                        )
                                                    </condition>
                                                    <then>
                                                        <block>{
                                                            <comment type="line">//</comment>
                                                            <comment type="line">// Put this new state into the states
                                                                to do and init
                                                            </comment>
                                                            <comment type="line">// a new entry at the same index in the
                                                                transition
                                                            </comment>
                                                            <comment type="line">// table.</comment>
                                                            <comment type="line">//</comment>
                                                            <expr_stmt>
                                                                <expr>
                                                                    <name>
                                                                        <name>statesToDo</name>
                                                                        <index>[
                                                                            <expr>
                                                                                <name>curState</name>
                                                                            </expr>
                                                                            ]
                                                                        </index>
                                                                    </name>
                                                                    =
                                                                    <name>newSet</name>
                                                                </expr>
                                                                ;
                                                            </expr_stmt>
                                                            <expr_stmt>
                                                                <expr>
                                                                    <name>
                                                                        <name>fTransTable</name>
                                                                        <index>[
                                                                            <expr>
                                                                                <name>curState</name>
                                                                            </expr>
                                                                            ]
                                                                        </index>
                                                                    </name>
                                                                    =
                                                                    <call>
                                                                        <name>makeDefStateList</name>
                                                                        <argument_list>()</argument_list>
                                                                    </call>
                                                                </expr>
                                                                ;
                                                            </expr_stmt>

                                                            <comment type="block">/* Optimization(Jan, 2001) */
                                                            </comment>
                                                            <expr_stmt>
                                                                <expr>
                                                                    <call>
                                                                        <name><name>stateTable</name>.
                                                                            <name>put</name>
                                                                        </name>
                                                                        <argument_list>(
                                                                            <argument>
                                                                                <expr>
                                                                                    <name>newSet</name>
                                                                                </expr>
                                                                            </argument>
                                                                            ,
                                                                            <argument>
                                                                                <expr>new
                                                                                    <call>
                                                                                        <name>Integer</name>
                                                                                        <argument_list>(
                                                                                            <argument>
                                                                                                <expr>
                                                                                                    <name>curState
                                                                                                    </name>
                                                                                                </expr>
                                                                                            </argument>
                                                                                            )
                                                                                        </argument_list>
                                                                                    </call>
                                                                                </expr>
                                                                            </argument>
                                                                            )
                                                                        </argument_list>
                                                                    </call>
                                                                </expr>
                                                                ;
                                                            </expr_stmt>
                                                            <comment type="block">/* Optimization(Jan, 2001) */
                                                            </comment>

                                                            <comment type="line">// We now have a new state to do so
                                                                bump the count
                                                            </comment>
                                                            <expr_stmt>
                                                                <expr><name>curState</name>++
                                                                </expr>
                                                                ;
                                                            </expr_stmt>

                                                            <comment type="line">//</comment>
                                                            <comment type="line">// Null out the new set to indicate we
                                                                adopted it.
                                                            </comment>
                                                            <comment type="line">// This will cause the creation of a
                                                                new set on the
                                                            </comment>
                                                            <comment type="line">// next time around the loop.</comment>
                                                            <comment type="line">//</comment>
                                                            <expr_stmt>
                                                                <expr>
                                                                    <name>newSet</name>
                                                                    =
                                                                    <name>null</name>
                                                                </expr>
                                                                ;
                                                            </expr_stmt>
                                                            }
                                                        </block>
                                                    </then>
                                                </if>

                                                <comment type="line">//</comment>
                                                <comment type="line">// Now set this state in the transition table's
                                                    entry
                                                </comment>
                                                <comment type="line">// for this element (using its index), with the
                                                    DFA
                                                </comment>
                                                <comment type="line">// state we will move to from the current state
                                                    when we
                                                </comment>
                                                <comment type="line">// see this input element.</comment>
                                                <comment type="line">//</comment>
                                                <expr_stmt>
                                                    <expr>
                                                        <name>
                                                            <name>transEntry</name>
                                                            <index>[
                                                                <expr>
                                                                    <name>elemIndex</name>
                                                                </expr>
                                                                ]
                                                            </index>
                                                        </name>
                                                        =
                                                        <name>stateIndex</name>
                                                    </expr>
                                                    ;
                                                </expr_stmt>

                                                <comment type="line">// Expand the arrays if we're full</comment>
                                                <if>if
                                                    <condition>(
                                                        <expr>
                                                            <name>curState</name>
                                                            ==
                                                            <name>curArraySize</name>
                                                        </expr>
                                                        )
                                                    </condition>
                                                    <then>
                                                        <block>{
                                                            <comment type="line">//</comment>
                                                            <comment type="line">// Yikes, we overflowed the initial
                                                                array size, so
                                                            </comment>
                                                            <comment type="line">// we've got to expand all of these
                                                                arrays. So adjust
                                                            </comment>
                                                            <comment type="line">// up the size by 50% and allocate new
                                                                arrays.
                                                            </comment>
                                                            <comment type="line">//</comment>
                                                            <decl_stmt>
                                                                <decl>
                                                                    <type>
                                                                        <specifier>final</specifier>
                                                                        <name>int</name>
                                                                    </type>
                                                                    <name>newSize</name> =
                                                                    <init>
                                                                        <expr>
                                                                            <call>(<name>int</name>)
                                                                                <argument_list>(
                                                                                    <argument>
                                                                                        <expr>
                                                                                            <name>curArraySize</name>
                                                                                            * 1.5
                                                                                        </expr>
                                                                                    </argument>
                                                                                    )
                                                                                </argument_list>
                                                                            </call>
                                                                        </expr>
                                                                    </init>
                                                                </decl>
                                                                ;
                                                            </decl_stmt>
                                                            <decl_stmt>
                                                                <decl>
                                                                    <type>
                                                                        <name>CMStateSet</name>
                                                                        <index>[]</index>
                                                                    </type>
                                                                    <name>newToDo</name> =
                                                                    <init>
                                                                        <expr>new
                                                                            <name>
                                                                                <name>CMStateSet</name>
                                                                                <index>[
                                                                                    <expr>
                                                                                        <name>newSize</name>
                                                                                    </expr>
                                                                                    ]
                                                                                </index>
                                                                            </name>
                                                                        </expr>
                                                                    </init>
                                                                </decl>
                                                                ;
                                                            </decl_stmt>
                                                            <decl_stmt>
                                                                <decl>
                                                                    <type>
                                                                        <name>boolean</name>
                                                                        <index>[]</index>
                                                                    </type>
                                                                    <name>newFinalFlags</name> =
                                                                    <init>
                                                                        <expr>new
                                                                            <name>
                                                                                <name>boolean</name>
                                                                                <index>[
                                                                                    <expr>
                                                                                        <name>newSize</name>
                                                                                    </expr>
                                                                                    ]
                                                                                </index>
                                                                            </name>
                                                                        </expr>
                                                                    </init>
                                                                </decl>
                                                                ;
                                                            </decl_stmt>
                                                            <decl_stmt>
                                                                <decl>
                                                                    <type>
                                                                        <name>int</name>
                                                                        <index>[]</index>
                                                                        <index>[]</index>
                                                                    </type>
                                                                    <name>newTransTable</name> =
                                                                    <init>
                                                                        <expr>new
                                                                            <name>
                                                                                <name>int</name>
                                                                                <index>[
                                                                                    <expr>
                                                                                        <name>newSize</name>
                                                                                    </expr>
                                                                                    ]
                                                                                </index>
                                                                                <index>[]</index>
                                                                            </name>
                                                                        </expr>
                                                                    </init>
                                                                </decl>
                                                                ;
                                                            </decl_stmt>

                                                            <comment type="line">// Copy over all of the existing
                                                                content
                                                            </comment>
                                                            <for>for (
                                                                <init>
                                                                    <decl>
                                                                        <type>
                                                                            <name>int</name>
                                                                        </type>
                                                                        <name>expIndex</name> =
                                                                        <init>
                                                                            <expr>0</expr>
                                                                        </init>
                                                                    </decl>
                                                                    ;
                                                                </init>
                                                                <condition>
                                                                    <expr>
                                                                        <name>expIndex</name>
                                                                        &lt;
                                                                        <name>curArraySize</name>
                                                                    </expr>
                                                                    ;
                                                                </condition>
                                                                <incr>
                                                                    <expr><name>expIndex</name>++
                                                                    </expr>
                                                                </incr>
                                                                )
                                                                <block>{
                                                                    <expr_stmt>
                                                                        <expr>
                                                                            <name>
                                                                                <name>newToDo</name>
                                                                                <index>[
                                                                                    <expr>
                                                                                        <name>expIndex</name>
                                                                                    </expr>
                                                                                    ]
                                                                                </index>
                                                                            </name>
                                                                            =
                                                                            <name>
                                                                                <name>statesToDo</name>
                                                                                <index>[
                                                                                    <expr>
                                                                                        <name>expIndex</name>
                                                                                    </expr>
                                                                                    ]
                                                                                </index>
                                                                            </name>
                                                                        </expr>
                                                                        ;
                                                                    </expr_stmt>
                                                                    <expr_stmt>
                                                                        <expr>
                                                                            <name>
                                                                                <name>newFinalFlags</name>
                                                                                <index>[
                                                                                    <expr>
                                                                                        <name>expIndex</name>
                                                                                    </expr>
                                                                                    ]
                                                                                </index>
                                                                            </name>
                                                                            =
                                                                            <name>
                                                                                <name>fFinalStateFlags</name>
                                                                                <index>[
                                                                                    <expr>
                                                                                        <name>expIndex</name>
                                                                                    </expr>
                                                                                    ]
                                                                                </index>
                                                                            </name>
                                                                        </expr>
                                                                        ;
                                                                    </expr_stmt>
                                                                    <expr_stmt>
                                                                        <expr>
                                                                            <name>
                                                                                <name>newTransTable</name>
                                                                                <index>[
                                                                                    <expr>
                                                                                        <name>expIndex</name>
                                                                                    </expr>
                                                                                    ]
                                                                                </index>
                                                                            </name>
                                                                            =
                                                                            <name>
                                                                                <name>fTransTable</name>
                                                                                <index>[
                                                                                    <expr>
                                                                                        <name>expIndex</name>
                                                                                    </expr>
                                                                                    ]
                                                                                </index>
                                                                            </name>
                                                                        </expr>
                                                                        ;
                                                                    </expr_stmt>
                                                                    }
                                                                </block>
                                                            </for>

                                                            <comment type="line">// Store the new array size</comment>
                                                            <expr_stmt>
                                                                <expr>
                                                                    <name>curArraySize</name>
                                                                    =
                                                                    <name>newSize</name>
                                                                </expr>
                                                                ;
                                                            </expr_stmt>
                                                            <expr_stmt>
                                                                <expr>
                                                                    <name>statesToDo</name>
                                                                    =
                                                                    <name>newToDo</name>
                                                                </expr>
                                                                ;
                                                            </expr_stmt>
                                                            <expr_stmt>
                                                                <expr>
                                                                    <name>fFinalStateFlags</name>
                                                                    =
                                                                    <name>newFinalFlags</name>
                                                                </expr>
                                                                ;
                                                            </expr_stmt>
                                                            <expr_stmt>
                                                                <expr>
                                                                    <name>fTransTable</name>
                                                                    =
                                                                    <name>newTransTable</name>
                                                                </expr>
                                                                ;
                                                            </expr_stmt>
                                                            }
                                                        </block>
                                                    </then>
                                                </if>
                                                }
                                            </block>
                                        </then>
                                    </if>
                                    }
                                </block>
                            </for>
                            }
                        </block>
                    </while>

                    <comment type="line">// Check to see if we can set the fEmptyContentIsValid flag.</comment>
                    <expr_stmt>
                        <expr>
                            <name>fEmptyContentIsValid</name>
                            = ((<name>CMBinOp</name>)<name>fHeadNode</name>).
                            <call>
                                <name>getLeft</name>
                                <argument_list>()</argument_list>
                            </call>
                            .
                            <call>
                                <name>isNullable</name>
                                <argument_list>()</argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <comment type="line">//</comment>
                    <comment type="line">// And now we can say bye bye to the temp representation since we've</comment>
                    <comment type="line">// built the DFA.</comment>
                    <comment type="line">//</comment>
                    <if>if
                        <condition>(
                            <expr>
                                <name>DEBUG_VALIDATE_CONTENT</name>
                            </expr>
                            )
                        </condition>
                        <then>
                            <expr_stmt>
                                <expr>
                                    <call>
                                        <name>dumpTree</name>
                                        <argument_list>(
                                            <argument>
                                                <expr>
                                                    <name>fHeadNode</name>
                                                </expr>
                                            </argument>
                                            ,
                                            <argument>
                                                <expr>0</expr>
                                            </argument>
                                            )
                                        </argument_list>
                                    </call>
                                </expr>
                                ;
                            </expr_stmt>
                        </then>
                    </if>
                    <expr_stmt>
                        <expr>
                            <name>fHeadNode</name>
                            =
                            <name>null</name>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <name>fLeafList</name>
                            =
                            <name>null</name>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <name>fFollowList</name>
                            =
                            <name>null</name>
                        </expr>
                        ;
                    </expr_stmt>

                    }
                </block>
            </function>

            <comment type="javadoc">/**
                * Calculates the follow list of the current node.
                *
                * @param nodeCur The curent node.
                *
                * @exception CMException Thrown if follow list cannot be calculated.
                */
            </comment>
            <function>
                <type>
                    <specifier>private</specifier>
                    <name>void</name>
                </type>
                <name>calcFollowList</name>
                <parameter_list>(
                    <param>
                        <decl>
                            <type>
                                <name>CMNode</name>
                            </type>
                            <name>nodeCur</name>
                        </decl>
                    </param>
                    )
                </parameter_list>
                <block>{
                    <comment type="line">// Recurse as required</comment>
                    <if>if
                        <condition>(
                            <expr>
                                <call>
                                    <name><name>nodeCur</name>.
                                        <name>type</name>
                                    </name>
                                    <argument_list>()</argument_list>
                                </call>
                                ==
                                <name><name>XMLContentSpec</name>.
                                    <name>CONTENTSPECNODE_CHOICE</name>
                                </name>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <comment type="line">// Recurse only</comment>
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name>calcFollowList</name>
                                            <argument_list>(
                                                <argument>
                                                    <expr>((<name>CMBinOp</name>)<name>nodeCur</name>).
                                                        <call>
                                                            <name>getLeft</name>
                                                            <argument_list>()</argument_list>
                                                        </call>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name>calcFollowList</name>
                                            <argument_list>(
                                                <argument>
                                                    <expr>((<name>CMBinOp</name>)<name>nodeCur</name>).
                                                        <call>
                                                            <name>getRight</name>
                                                            <argument_list>()</argument_list>
                                                        </call>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </then>
                        <else>else
                            <if>if
                                <condition>(
                                    <expr>
                                        <call>
                                            <name><name>nodeCur</name>.
                                                <name>type</name>
                                            </name>
                                            <argument_list>()</argument_list>
                                        </call>
                                        ==
                                        <name><name>XMLContentSpec</name>.
                                            <name>CONTENTSPECNODE_SEQ</name>
                                        </name>
                                    </expr>
                                    )
                                </condition>
                                <then>
                                    <block>{
                                        <comment type="line">// Recurse first</comment>
                                        <expr_stmt>
                                            <expr>
                                                <call>
                                                    <name>calcFollowList</name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>((<name>CMBinOp</name>)<name>nodeCur</name>).
                                                                <call>
                                                                    <name>getLeft</name>
                                                                    <argument_list>()</argument_list>
                                                                </call>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        <expr_stmt>
                                            <expr>
                                                <call>
                                                    <name>calcFollowList</name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>((<name>CMBinOp</name>)<name>nodeCur</name>).
                                                                <call>
                                                                    <name>getRight</name>
                                                                    <argument_list>()</argument_list>
                                                                </call>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>

                                        <comment type="line">//</comment>
                                        <comment type="line">// Now handle our level. We use our left child's last pos
                                        </comment>
                                        <comment type="line">// set and our right child's first pos set, so go ahead
                                            and
                                        </comment>
                                        <comment type="line">// get them ahead of time.</comment>
                                        <comment type="line">//</comment>
                                        <decl_stmt>
                                            <decl>
                                                <type>
                                                    <specifier>final</specifier>
                                                    <name>CMStateSet</name>
                                                </type>
                                                <name>last</name>  =
                                                <init>
                                                    <expr>((<name>CMBinOp</name>)<name>nodeCur</name>).
                                                        <call>
                                                            <name>getLeft</name>
                                                            <argument_list>()</argument_list>
                                                        </call>
                                                        .
                                                        <call>
                                                            <name>lastPos</name>
                                                            <argument_list>()</argument_list>
                                                        </call>
                                                    </expr>
                                                </init>
                                            </decl>
                                            ;
                                        </decl_stmt>
                                        <decl_stmt>
                                            <decl>
                                                <type>
                                                    <specifier>final</specifier>
                                                    <name>CMStateSet</name>
                                                </type>
                                                <name>first</name> =
                                                <init>
                                                    <expr>((<name>CMBinOp</name>)<name>nodeCur</name>).
                                                        <call>
                                                            <name>getRight</name>
                                                            <argument_list>()</argument_list>
                                                        </call>
                                                        .
                                                        <call>
                                                            <name>firstPos</name>
                                                            <argument_list>()</argument_list>
                                                        </call>
                                                    </expr>
                                                </init>
                                            </decl>
                                            ;
                                        </decl_stmt>

                                        <comment type="line">//</comment>
                                        <comment type="line">// Now, for every position which is in our left child's
                                            last set
                                        </comment>
                                        <comment type="line">// add all of the states in our right child's first set to
                                            the
                                        </comment>
                                        <comment type="line">// follow set for that position.</comment>
                                        <comment type="line">//</comment>
                                        <for>for (
                                            <init>
                                                <decl>
                                                    <type>
                                                        <name>int</name>
                                                    </type>
                                                    <name>index</name> =
                                                    <init>
                                                        <expr>0</expr>
                                                    </init>
                                                </decl>
                                                ;
                                            </init>
                                            <condition>
                                                <expr>
                                                    <name>index</name>
                                                    &lt;
                                                    <name>fLeafCount</name>
                                                </expr>
                                                ;
                                            </condition>
                                            <incr>
                                                <expr><name>index</name>++
                                                </expr>
                                            </incr>
                                            )
                                            <block>{
                                                <if>if
                                                    <condition>(
                                                        <expr>
                                                            <call>
                                                                <name><name>last</name>.
                                                                    <name>getBit</name>
                                                                </name>
                                                                <argument_list>(
                                                                    <argument>
                                                                        <expr>
                                                                            <name>index</name>
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                        )
                                                    </condition>
                                                    <then>
                                                        <expr_stmt>
                                                            <expr>
                                                                <name>
                                                                    <name>fFollowList</name>
                                                                    <index>[
                                                                        <expr>
                                                                            <name>index</name>
                                                                        </expr>
                                                                        ]
                                                                    </index>
                                                                </name>
                                                                .
                                                                <call>
                                                                    <name>union</name>
                                                                    <argument_list>(
                                                                        <argument>
                                                                            <expr>
                                                                                <name>first</name>
                                                                            </expr>
                                                                        </argument>
                                                                        )
                                                                    </argument_list>
                                                                </call>
                                                            </expr>
                                                            ;
                                                        </expr_stmt>
                                                    </then>
                                                </if>
                                                }
                                            </block>
                                        </for>
                                        }
                                    </block>
                                </then>
                            </if>
                        </else>
                    </if>
                    <comment type="javadoc">/***
                        else if (nodeCur.type() == XMLContentSpec.CONTENTSPECNODE_ZERO_OR_MORE)
                        {
                        // Recurse first
                        calcFollowList(((CMUniOp)nodeCur).getChild());

                        //
                        // Now handle our level. We use our own first and last position
                        // sets, so get them up front.
                        //
                        final CMStateSet first = nodeCur.firstPos();
                        final CMStateSet last = nodeCur.lastPos();

                        //
                        // For every position which is in our last position set, add all
                        // of our first position states to the follow set for that
                        // position.
                        //
                        for (int index = 0; index &lt; fLeafCount; index++)
                        {
                        if (last.getBit(index))
                        fFollowList[index].union(first);
                        }
                        }
                        else if ((nodeCur.type() == XMLContentSpec.CONTENTSPECNODE_ONE_OR_MORE)
                        || (nodeCur.type() == XMLContentSpec.CONTENTSPECNODE_ZERO_OR_ONE))
                        {
                        throw new RuntimeException("ImplementationMessages.VAL_NIICM");
                        }
                        /***/
                    </comment>
                    <else>else
                        <if>if
                            <condition>(
                                <expr>
                                    <call>
                                        <name><name>nodeCur</name>.
                                            <name>type</name>
                                        </name>
                                        <argument_list>()</argument_list>
                                    </call>
                                    ==
                                    <name><name>XMLContentSpec</name>.
                                        <name>CONTENTSPECNODE_ZERO_OR_MORE</name>
                                    </name>
                                    ||
                                    <call>
                                        <name><name>nodeCur</name>.
                                            <name>type</name>
                                        </name>
                                        <argument_list>()</argument_list>
                                    </call>
                                    ==
                                    <name><name>XMLContentSpec</name>.
                                        <name>CONTENTSPECNODE_ONE_OR_MORE</name>
                                    </name>
                                </expr>
                                )
                            </condition>
                            <then>
                                <block>{
                                    <comment type="line">// Recurse first</comment>
                                    <expr_stmt>
                                        <expr>
                                            <call>
                                                <name>calcFollowList</name>
                                                <argument_list>(
                                                    <argument>
                                                        <expr>((<name>CMUniOp</name>)<name>nodeCur</name>).
                                                            <call>
                                                                <name>getChild</name>
                                                                <argument_list>()</argument_list>
                                                            </call>
                                                        </expr>
                                                    </argument>
                                                    )
                                                </argument_list>
                                            </call>
                                        </expr>
                                        ;
                                    </expr_stmt>

                                    <comment type="line">//</comment>
                                    <comment type="line">// Now handle our level. We use our own first and last
                                        position
                                    </comment>
                                    <comment type="line">// sets, so get them up front.</comment>
                                    <comment type="line">//</comment>
                                    <decl_stmt>
                                        <decl>
                                            <type>
                                                <specifier>final</specifier>
                                                <name>CMStateSet</name>
                                            </type>
                                            <name>first</name> =
                                            <init>
                                                <expr>
                                                    <call>
                                                        <name><name>nodeCur</name>.
                                                            <name>firstPos</name>
                                                        </name>
                                                        <argument_list>()</argument_list>
                                                    </call>
                                                </expr>
                                            </init>
                                        </decl>
                                        ;
                                    </decl_stmt>
                                    <decl_stmt>
                                        <decl>
                                            <type>
                                                <specifier>final</specifier>
                                                <name>CMStateSet</name>
                                            </type>
                                            <name>last</name>  =
                                            <init>
                                                <expr>
                                                    <call>
                                                        <name><name>nodeCur</name>.
                                                            <name>lastPos</name>
                                                        </name>
                                                        <argument_list>()</argument_list>
                                                    </call>
                                                </expr>
                                            </init>
                                        </decl>
                                        ;
                                    </decl_stmt>

                                    <comment type="line">//</comment>
                                    <comment type="line">// For every position which is in our last position set, add
                                        all
                                    </comment>
                                    <comment type="line">// of our first position states to the follow set for that
                                    </comment>
                                    <comment type="line">// position.</comment>
                                    <comment type="line">//</comment>
                                    <for>for (
                                        <init>
                                            <decl>
                                                <type>
                                                    <name>int</name>
                                                </type>
                                                <name>index</name> =
                                                <init>
                                                    <expr>0</expr>
                                                </init>
                                            </decl>
                                            ;
                                        </init>
                                        <condition>
                                            <expr>
                                                <name>index</name>
                                                &lt;
                                                <name>fLeafCount</name>
                                            </expr>
                                            ;
                                        </condition>
                                        <incr>
                                            <expr><name>index</name>++
                                            </expr>
                                        </incr>
                                        )
                                        <block>{
                                            <if>if
                                                <condition>(
                                                    <expr>
                                                        <call>
                                                            <name><name>last</name>.
                                                                <name>getBit</name>
                                                            </name>
                                                            <argument_list>(
                                                                <argument>
                                                                    <expr>
                                                                        <name>index</name>
                                                                    </expr>
                                                                </argument>
                                                                )
                                                            </argument_list>
                                                        </call>
                                                    </expr>
                                                    )
                                                </condition>
                                                <then>
                                                    <expr_stmt>
                                                        <expr>
                                                            <name>
                                                                <name>fFollowList</name>
                                                                <index>[
                                                                    <expr>
                                                                        <name>index</name>
                                                                    </expr>
                                                                    ]
                                                                </index>
                                                            </name>
                                                            .
                                                            <call>
                                                                <name>union</name>
                                                                <argument_list>(
                                                                    <argument>
                                                                        <expr>
                                                                            <name>first</name>
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                        ;
                                                    </expr_stmt>
                                                </then>
                                            </if>
                                            }
                                        </block>
                                    </for>
                                    }
                                </block>
                            </then>

                            <else>else
                                <if>if
                                    <condition>(
                                        <expr>
                                            <call>
                                                <name><name>nodeCur</name>.
                                                    <name>type</name>
                                                </name>
                                                <argument_list>()</argument_list>
                                            </call>
                                            ==
                                            <name><name>XMLContentSpec</name>.
                                                <name>CONTENTSPECNODE_ZERO_OR_ONE</name>
                                            </name>
                                        </expr>
                                        )
                                    </condition>
                                    <then>
                                        <block>{
                                            <comment type="line">// Recurse only</comment>
                                            <expr_stmt>
                                                <expr>
                                                    <call>
                                                        <name>calcFollowList</name>
                                                        <argument_list>(
                                                            <argument>
                                                                <expr>((<name>CMUniOp</name>)<name>nodeCur</name>).
                                                                    <call>
                                                                        <name>getChild</name>
                                                                        <argument_list>()</argument_list>
                                                                    </call>
                                                                </expr>
                                                            </argument>
                                                            )
                                                        </argument_list>
                                                    </call>
                                                </expr>
                                                ;
                                            </expr_stmt>
                                            }
                                        </block>
                                    </then>
                                </if>
                            </else>
                        </if>
                    </else>
                    <comment type="javadoc">/***/</comment>
                    }
                </block>
            </function>

            <comment type="javadoc">/**
                * Dumps the tree of the current node to standard output.
                *
                * @param nodeCur The current node.
                * @param level The maximum levels to output.
                *
                * @exception CMException Thrown on error.
                */
            </comment>
            <function>
                <type>
                    <specifier>private</specifier>
                    <name>void</name>
                </type>
                <name>dumpTree</name>
                <parameter_list>(
                    <param>
                        <decl>
                            <type>
                                <name>CMNode</name>
                            </type>
                            <name>nodeCur</name>
                        </decl>
                    </param>
                    ,
                    <param>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>level</name>
                        </decl>
                    </param>
                    )
                </parameter_list>
                <block>{
                    <for>for (
                        <init>
                            <decl>
                                <type>
                                    <name>int</name>
                                </type>
                                <name>index</name> =
                                <init>
                                    <expr>0</expr>
                                </init>
                            </decl>
                            ;
                        </init>
                        <condition>
                            <expr>
                                <name>index</name>
                                &lt;
                                <name>level</name>
                            </expr>
                            ;
                        </condition>
                        <incr>
                            <expr><name>index</name>++
                            </expr>
                        </incr>
                        )
                        <expr_stmt>
                            <expr>
                                <call>
                                    <name><name>System</name>.<name>out</name>.
                                        <name>print</name>
                                    </name>
                                    <argument_list>(
                                        <argument>
                                            <expr>" "</expr>
                                        </argument>
                                        )
                                    </argument_list>
                                </call>
                            </expr>
                            ;
                        </expr_stmt>
                    </for>

                    <decl_stmt>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>type</name> =
                            <init>
                                <expr>
                                    <call>
                                        <name><name>nodeCur</name>.
                                            <name>type</name>
                                        </name>
                                        <argument_list>()</argument_list>
                                    </call>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <if>if
                        <condition>(
                            <expr>(<name>type</name> ==
                                <name><name>XMLContentSpec</name>.
                                    <name>CONTENTSPECNODE_CHOICE</name>
                                </name>
                                )
                                || (<name>type</name> ==
                                <name><name>XMLContentSpec</name>.
                                    <name>CONTENTSPECNODE_SEQ</name>
                                </name>
                                )
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <if>if
                                    <condition>(
                                        <expr>
                                            <name>type</name>
                                            ==
                                            <name><name>XMLContentSpec</name>.
                                                <name>CONTENTSPECNODE_CHOICE</name>
                                            </name>
                                        </expr>
                                        )
                                    </condition>
                                    <then>
                                        <expr_stmt>
                                            <expr>
                                                <call>
                                                    <name><name>System</name>.<name>out</name>.
                                                        <name>print</name>
                                                    </name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>"Choice Node "</expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                    </then>
                                    <else>else
                                        <expr_stmt>
                                            <expr>
                                                <call>
                                                    <name><name>System</name>.<name>out</name>.
                                                        <name>print</name>
                                                    </name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>"Seq Node "</expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                    </else>
                                </if>

                                <if>if
                                    <condition>(
                                        <expr>
                                            <call>
                                                <name><name>nodeCur</name>.
                                                    <name>isNullable</name>
                                                </name>
                                                <argument_list>()</argument_list>
                                            </call>
                                        </expr>
                                        )
                                    </condition>
                                    <then>
                                        <expr_stmt>
                                            <expr>
                                                <call>
                                                    <name><name>System</name>.<name>out</name>.
                                                        <name>print</name>
                                                    </name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>"Nullable "</expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                    </then>
                                </if>

                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name><name>System</name>.<name>out</name>.
                                                <name>print</name>
                                            </name>
                                            <argument_list>(
                                                <argument>
                                                    <expr>"firstPos="</expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name><name>System</name>.<name>out</name>.
                                                <name>print</name>
                                            </name>
                                            <argument_list>(
                                                <argument>
                                                    <expr>
                                                        <call>
                                                            <name><name>nodeCur</name>.
                                                                <name>firstPos</name>
                                                            </name>
                                                            <argument_list>()</argument_list>
                                                        </call>
                                                        .
                                                        <call>
                                                            <name>toString</name>
                                                            <argument_list>()</argument_list>
                                                        </call>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name><name>System</name>.<name>out</name>.
                                                <name>print</name>
                                            </name>
                                            <argument_list>(
                                                <argument>
                                                    <expr>" lastPos="</expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name><name>System</name>.<name>out</name>.
                                                <name>println</name>
                                            </name>
                                            <argument_list>(
                                                <argument>
                                                    <expr>
                                                        <call>
                                                            <name><name>nodeCur</name>.
                                                                <name>lastPos</name>
                                                            </name>
                                                            <argument_list>()</argument_list>
                                                        </call>
                                                        .
                                                        <call>
                                                            <name>toString</name>
                                                            <argument_list>()</argument_list>
                                                        </call>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>

                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name>dumpTree</name>
                                            <argument_list>(
                                                <argument>
                                                    <expr>((<name>CMBinOp</name>)<name>nodeCur</name>).
                                                        <call>
                                                            <name>getLeft</name>
                                                            <argument_list>()</argument_list>
                                                        </call>
                                                    </expr>
                                                </argument>
                                                ,
                                                <argument>
                                                    <expr><name>level</name>+1
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name>dumpTree</name>
                                            <argument_list>(
                                                <argument>
                                                    <expr>((<name>CMBinOp</name>)<name>nodeCur</name>).
                                                        <call>
                                                            <name>getRight</name>
                                                            <argument_list>()</argument_list>
                                                        </call>
                                                    </expr>
                                                </argument>
                                                ,
                                                <argument>
                                                    <expr><name>level</name>+1
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </then>
                        <else>else
                            <if>if
                                <condition>(
                                    <expr>
                                        <call>
                                            <name><name>nodeCur</name>.
                                                <name>type</name>
                                            </name>
                                            <argument_list>()</argument_list>
                                        </call>
                                        ==
                                        <name><name>XMLContentSpec</name>.
                                            <name>CONTENTSPECNODE_ZERO_OR_MORE</name>
                                        </name>
                                    </expr>
                                    )
                                </condition>
                                <then>
                                    <block>{
                                        <expr_stmt>
                                            <expr>
                                                <call>
                                                    <name><name>System</name>.<name>out</name>.
                                                        <name>print</name>
                                                    </name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>"Rep Node "</expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>

                                        <if>if
                                            <condition>(
                                                <expr>
                                                    <call>
                                                        <name><name>nodeCur</name>.
                                                            <name>isNullable</name>
                                                        </name>
                                                        <argument_list>()</argument_list>
                                                    </call>
                                                </expr>
                                                )
                                            </condition>
                                            <then>
                                                <expr_stmt>
                                                    <expr>
                                                        <call>
                                                            <name><name>System</name>.<name>out</name>.
                                                                <name>print</name>
                                                            </name>
                                                            <argument_list>(
                                                                <argument>
                                                                    <expr>"Nullable "</expr>
                                                                </argument>
                                                                )
                                                            </argument_list>
                                                        </call>
                                                    </expr>
                                                    ;
                                                </expr_stmt>
                                            </then>
                                        </if>

                                        <expr_stmt>
                                            <expr>
                                                <call>
                                                    <name><name>System</name>.<name>out</name>.
                                                        <name>print</name>
                                                    </name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>"firstPos="</expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        <expr_stmt>
                                            <expr>
                                                <call>
                                                    <name><name>System</name>.<name>out</name>.
                                                        <name>print</name>
                                                    </name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>
                                                                <call>
                                                                    <name><name>nodeCur</name>.
                                                                        <name>firstPos</name>
                                                                    </name>
                                                                    <argument_list>()</argument_list>
                                                                </call>
                                                                .
                                                                <call>
                                                                    <name>toString</name>
                                                                    <argument_list>()</argument_list>
                                                                </call>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        <expr_stmt>
                                            <expr>
                                                <call>
                                                    <name><name>System</name>.<name>out</name>.
                                                        <name>print</name>
                                                    </name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>" lastPos="</expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        <expr_stmt>
                                            <expr>
                                                <call>
                                                    <name><name>System</name>.<name>out</name>.
                                                        <name>println</name>
                                                    </name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>
                                                                <call>
                                                                    <name><name>nodeCur</name>.
                                                                        <name>lastPos</name>
                                                                    </name>
                                                                    <argument_list>()</argument_list>
                                                                </call>
                                                                .
                                                                <call>
                                                                    <name>toString</name>
                                                                    <argument_list>()</argument_list>
                                                                </call>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>

                                        <expr_stmt>
                                            <expr>
                                                <call>
                                                    <name>dumpTree</name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>((<name>CMUniOp</name>)<name>nodeCur</name>).
                                                                <call>
                                                                    <name>getChild</name>
                                                                    <argument_list>()</argument_list>
                                                                </call>
                                                            </expr>
                                                        </argument>
                                                        ,
                                                        <argument>
                                                            <expr><name>level</name>+1
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        }
                                    </block>
                                </then>
                                <else>else
                                    <if>if
                                        <condition>(
                                            <expr>
                                                <call>
                                                    <name><name>nodeCur</name>.
                                                        <name>type</name>
                                                    </name>
                                                    <argument_list>()</argument_list>
                                                </call>
                                                ==
                                                <name><name>XMLContentSpec</name>.
                                                    <name>CONTENTSPECNODE_LEAF</name>
                                                </name>
                                            </expr>
                                            )
                                        </condition>
                                        <then>
                                            <block>{
                                                <expr_stmt>
                                                    <expr>
                                                        <call>
                                                            <name><name>System</name>.<name>out</name>.
                                                                <name>print</name>
                                                            </name>
                                                            <argument_list>(
                                                                <argument>
                                                                    <expr>"Leaf: (pos="
                                                                        + ((<name>CMLeaf</name>)<name>nodeCur</name>).
                                                                        <call>
                                                                            <name>getPosition</name>
                                                                            <argument_list>()</argument_list>
                                                                        </call>
                                                                        + "), "
                                                                        + ((<name>CMLeaf</name>)<name>nodeCur</name>).
                                                                        <call>
                                                                            <name>getElement</name>
                                                                            <argument_list>()</argument_list>
                                                                        </call>
                                                                        + "(elemIndex="
                                                                        + ((<name>CMLeaf</name>)<name>nodeCur</name>).
                                                                        <call>
                                                                            <name>getElement</name>
                                                                            <argument_list>()</argument_list>
                                                                        </call>
                                                                        + ") "
                                                                    </expr>
                                                                </argument>
                                                                )
                                                            </argument_list>
                                                        </call>
                                                    </expr>
                                                    ;
                                                </expr_stmt>

                                                <if>if
                                                    <condition>(
                                                        <expr>
                                                            <call>
                                                                <name><name>nodeCur</name>.
                                                                    <name>isNullable</name>
                                                                </name>
                                                                <argument_list>()</argument_list>
                                                            </call>
                                                        </expr>
                                                        )
                                                    </condition>
                                                    <then>
                                                        <expr_stmt>
                                                            <expr>
                                                                <call>
                                                                    <name><name>System</name>.<name>out</name>.
                                                                        <name>print</name>
                                                                    </name>
                                                                    <argument_list>(
                                                                        <argument>
                                                                            <expr>" Nullable "</expr>
                                                                        </argument>
                                                                        )
                                                                    </argument_list>
                                                                </call>
                                                            </expr>
                                                            ;
                                                        </expr_stmt>
                                                    </then>
                                                </if>

                                                <expr_stmt>
                                                    <expr>
                                                        <call>
                                                            <name><name>System</name>.<name>out</name>.
                                                                <name>print</name>
                                                            </name>
                                                            <argument_list>(
                                                                <argument>
                                                                    <expr>"firstPos="</expr>
                                                                </argument>
                                                                )
                                                            </argument_list>
                                                        </call>
                                                    </expr>
                                                    ;
                                                </expr_stmt>
                                                <expr_stmt>
                                                    <expr>
                                                        <call>
                                                            <name><name>System</name>.<name>out</name>.
                                                                <name>print</name>
                                                            </name>
                                                            <argument_list>(
                                                                <argument>
                                                                    <expr>
                                                                        <call>
                                                                            <name><name>nodeCur</name>.
                                                                                <name>firstPos</name>
                                                                            </name>
                                                                            <argument_list>()</argument_list>
                                                                        </call>
                                                                        .
                                                                        <call>
                                                                            <name>toString</name>
                                                                            <argument_list>()</argument_list>
                                                                        </call>
                                                                    </expr>
                                                                </argument>
                                                                )
                                                            </argument_list>
                                                        </call>
                                                    </expr>
                                                    ;
                                                </expr_stmt>
                                                <expr_stmt>
                                                    <expr>
                                                        <call>
                                                            <name><name>System</name>.<name>out</name>.
                                                                <name>print</name>
                                                            </name>
                                                            <argument_list>(
                                                                <argument>
                                                                    <expr>" lastPos="</expr>
                                                                </argument>
                                                                )
                                                            </argument_list>
                                                        </call>
                                                    </expr>
                                                    ;
                                                </expr_stmt>
                                                <expr_stmt>
                                                    <expr>
                                                        <call>
                                                            <name><name>System</name>.<name>out</name>.
                                                                <name>println</name>
                                                            </name>
                                                            <argument_list>(
                                                                <argument>
                                                                    <expr>
                                                                        <call>
                                                                            <name><name>nodeCur</name>.
                                                                                <name>lastPos</name>
                                                                            </name>
                                                                            <argument_list>()</argument_list>
                                                                        </call>
                                                                        .
                                                                        <call>
                                                                            <name>toString</name>
                                                                            <argument_list>()</argument_list>
                                                                        </call>
                                                                    </expr>
                                                                </argument>
                                                                )
                                                            </argument_list>
                                                        </call>
                                                    </expr>
                                                    ;
                                                </expr_stmt>
                                                }
                                            </block>
                                        </then>
                                        <else>else
                                            <block>{
                                                <throw>throw
                                                    <expr>new
                                                        <call>
                                                            <name>RuntimeException</name>
                                                            <argument_list>(
                                                                <argument>
                                                                    <expr>"ImplementationMessages.VAL_NIICM"</expr>
                                                                </argument>
                                                                )
                                                            </argument_list>
                                                        </call>
                                                    </expr>
                                                    ;
                                                </throw>
                                                }
                                            </block>
                                        </else>
                                    </if>
                                </else>
                            </if>
                        </else>
                    </if>
                    }
                </block>
            </function>


            <comment type="javadoc">/**
                * -1 is used to represent bad transitions in the transition table
                * entry for each state. So each entry is initialized to an all -1
                * array. This method creates a new entry and initializes it.
                */
            </comment>
            <function>
                <type>
                    <specifier>private</specifier>
                    <name>int</name>
                    <index>[]</index>
                </type>
                <name>makeDefStateList</name>
                <parameter_list>()</parameter_list>
                <block>{
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>int</name>
                                <index>[]</index>
                            </type>
                            <name>retArray</name> =
                            <init>
                                <expr>new
                                    <name>
                                        <name>int</name>
                                        <index>[
                                            <expr>
                                                <name>fElemMapSize</name>
                                            </expr>
                                            ]
                                        </index>
                                    </name>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <for>for (
                        <init>
                            <decl>
                                <type>
                                    <name>int</name>
                                </type>
                                <name>index</name> =
                                <init>
                                    <expr>0</expr>
                                </init>
                            </decl>
                            ;
                        </init>
                        <condition>
                            <expr>
                                <name>index</name>
                                &lt;
                                <name>fElemMapSize</name>
                            </expr>
                            ;
                        </condition>
                        <incr>
                            <expr><name>index</name>++
                            </expr>
                        </incr>
                        )
                        <expr_stmt>
                            <expr>
                                <name>
                                    <name>retArray</name>
                                    <index>[
                                        <expr>
                                            <name>index</name>
                                        </expr>
                                        ]
                                    </index>
                                </name>
                                = -1
                            </expr>
                            ;
                        </expr_stmt>
                    </for>
                    <return>return
                        <expr>
                            <name>retArray</name>
                        </expr>
                        ;
                    </return>
                    }
                </block>
            </function>

            <comment type="javadoc">/** Post tree build initialization. */</comment>
            <function>
                <type>
                    <specifier>private</specifier>
                    <name>int</name>
                </type>
                <name>postTreeBuildInit</name>
                <parameter_list>(
                    <param>
                        <decl>
                            <type>
                                <name>CMNode</name>
                            </type>
                            <name>nodeCur</name>
                        </decl>
                    </param>
                    ,
                    <param>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>curIndex</name>
                        </decl>
                    </param>
                    )
                </parameter_list>
                <block>{
                    <comment type="line">// Set the maximum states on this node</comment>
                    <expr_stmt>
                        <expr>
                            <call>
                                <name><name>nodeCur</name>.
                                    <name>setMaxStates</name>
                                </name>
                                <argument_list>(
                                    <argument>
                                        <expr>
                                            <name>fLeafCount</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>

                    <comment type="line">// Recurse as required</comment>
                    <if>if
                        <condition>(
                            <expr>(
                                <call>
                                    <name><name>nodeCur</name>.
                                        <name>type</name>
                                    </name>
                                    <argument_list>()</argument_list>
                                </call>
                                &amp; 0x0f) ==
                                <name><name>XMLContentSpec</name>.
                                    <name>CONTENTSPECNODE_ANY</name>
                                </name>
                                ||
                                (
                                <call>
                                    <name><name>nodeCur</name>.
                                        <name>type</name>
                                    </name>
                                    <argument_list>()</argument_list>
                                </call>
                                &amp; 0x0f) ==
                                <name><name>XMLContentSpec</name>.
                                    <name>CONTENTSPECNODE_ANY_LOCAL</name>
                                </name>
                                ||
                                (
                                <call>
                                    <name><name>nodeCur</name>.
                                        <name>type</name>
                                    </name>
                                    <argument_list>()</argument_list>
                                </call>
                                &amp; 0x0f) ==
                                <name><name>XMLContentSpec</name>.
                                    <name>CONTENTSPECNODE_ANY_OTHER</name>
                                </name>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <comment type="line">// REVISIT: Don't waste these structures.</comment>
                                <decl_stmt>
                                    <decl>
                                        <type>
                                            <name>QName</name>
                                        </type>
                                        <name>qname</name> =
                                        <init>
                                            <expr>new
                                                <call>
                                                    <name>QName</name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>
                                                                <name>null</name>
                                                            </expr>
                                                        </argument>
                                                        ,
                                                        <argument>
                                                            <expr>
                                                                <name>null</name>
                                                            </expr>
                                                        </argument>
                                                        ,
                                                        <argument>
                                                            <expr>
                                                                <name>null</name>
                                                            </expr>
                                                        </argument>
                                                        ,
                                                        <argument>
                                                            <expr>((<name>CMAny</name>)<name>nodeCur</name>).
                                                                <call>
                                                                    <name>getURI</name>
                                                                    <argument_list>()</argument_list>
                                                                </call>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                        </init>
                                    </decl>
                                    ;
                                </decl_stmt>
                                <expr_stmt>
                                    <expr>
                                        <name>
                                            <name>fLeafList</name>
                                            <index>[
                                                <expr>
                                                    <name>curIndex</name>
                                                </expr>
                                                ]
                                            </index>
                                        </name>
                                        = new
                                        <call>
                                            <name>CMLeaf</name>
                                            <argument_list>(
                                                <argument>
                                                    <expr>
                                                        <name>qname</name>
                                                    </expr>
                                                </argument>
                                                ,
                                                <argument>
                                                    <expr>((<name>CMAny</name>)<name>nodeCur</name>).
                                                        <call>
                                                            <name>getPosition</name>
                                                            <argument_list>()</argument_list>
                                                        </call>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                <expr_stmt>
                                    <expr>
                                        <name>
                                            <name>fLeafListType</name>
                                            <index>[
                                                <expr>
                                                    <name>curIndex</name>
                                                </expr>
                                                ]
                                            </index>
                                        </name>
                                        =
                                        <call>
                                            <name><name>nodeCur</name>.
                                                <name>type</name>
                                            </name>
                                            <argument_list>()</argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                <expr_stmt>
                                    <expr><name>curIndex</name>++
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </then>
                        <else>else
                            <if>if
                                <condition>(
                                    <expr>(
                                        <call>
                                            <name><name>nodeCur</name>.
                                                <name>type</name>
                                            </name>
                                            <argument_list>()</argument_list>
                                        </call>
                                        ==
                                        <name><name>XMLContentSpec</name>.
                                            <name>CONTENTSPECNODE_CHOICE</name>
                                        </name>
                                        )
                                        || (
                                        <call>
                                            <name><name>nodeCur</name>.
                                                <name>type</name>
                                            </name>
                                            <argument_list>()</argument_list>
                                        </call>
                                        ==
                                        <name><name>XMLContentSpec</name>.
                                            <name>CONTENTSPECNODE_SEQ</name>
                                        </name>
                                        )
                                    </expr>
                                    )
                                </condition>
                                <then>
                                    <block>{
                                        <expr_stmt>
                                            <expr>
                                                <name>curIndex</name>
                                                =
                                                <call>
                                                    <name>postTreeBuildInit</name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>((<name>CMBinOp</name>)<name>nodeCur</name>).
                                                                <call>
                                                                    <name>getLeft</name>
                                                                    <argument_list>()</argument_list>
                                                                </call>
                                                            </expr>
                                                        </argument>
                                                        ,
                                                        <argument>
                                                            <expr>
                                                                <name>curIndex</name>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        <expr_stmt>
                                            <expr>
                                                <name>curIndex</name>
                                                =
                                                <call>
                                                    <name>postTreeBuildInit</name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>((<name>CMBinOp</name>)<name>nodeCur</name>).
                                                                <call>
                                                                    <name>getRight</name>
                                                                    <argument_list>()</argument_list>
                                                                </call>
                                                            </expr>
                                                        </argument>
                                                        ,
                                                        <argument>
                                                            <expr>
                                                                <name>curIndex</name>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        }
                                    </block>
                                </then>
                                <else>else
                                    <if>if
                                        <condition>(
                                            <expr>
                                                <call>
                                                    <name><name>nodeCur</name>.
                                                        <name>type</name>
                                                    </name>
                                                    <argument_list>()</argument_list>
                                                </call>
                                                ==
                                                <name><name>XMLContentSpec</name>.
                                                    <name>CONTENTSPECNODE_ZERO_OR_MORE</name>
                                                </name>
                                                ||
                                                <call>
                                                    <name><name>nodeCur</name>.
                                                        <name>type</name>
                                                    </name>
                                                    <argument_list>()</argument_list>
                                                </call>
                                                ==
                                                <name><name>XMLContentSpec</name>.
                                                    <name>CONTENTSPECNODE_ONE_OR_MORE</name>
                                                </name>
                                                ||
                                                <call>
                                                    <name><name>nodeCur</name>.
                                                        <name>type</name>
                                                    </name>
                                                    <argument_list>()</argument_list>
                                                </call>
                                                ==
                                                <name><name>XMLContentSpec</name>.
                                                    <name>CONTENTSPECNODE_ZERO_OR_ONE</name>
                                                </name>
                                            </expr>
                                            )
                                        </condition>
                                        <then>
                                            <block>{
                                                <expr_stmt>
                                                    <expr>
                                                        <name>curIndex</name>
                                                        =
                                                        <call>
                                                            <name>postTreeBuildInit</name>
                                                            <argument_list>(
                                                                <argument>
                                                                    <expr>((<name>CMUniOp</name>)<name>nodeCur</name>).
                                                                        <call>
                                                                            <name>getChild</name>
                                                                            <argument_list>()</argument_list>
                                                                        </call>
                                                                    </expr>
                                                                </argument>
                                                                ,
                                                                <argument>
                                                                    <expr>
                                                                        <name>curIndex</name>
                                                                    </expr>
                                                                </argument>
                                                                )
                                                            </argument_list>
                                                        </call>
                                                    </expr>
                                                    ;
                                                </expr_stmt>
                                                }
                                            </block>
                                        </then>
                                        <else>else
                                            <if>if
                                                <condition>(
                                                    <expr>
                                                        <call>
                                                            <name><name>nodeCur</name>.
                                                                <name>type</name>
                                                            </name>
                                                            <argument_list>()</argument_list>
                                                        </call>
                                                        ==
                                                        <name><name>XMLContentSpec</name>.
                                                            <name>CONTENTSPECNODE_LEAF</name>
                                                        </name>
                                                    </expr>
                                                    )
                                                </condition>
                                                <then>
                                                    <block>{
                                                        <comment type="line">//</comment>
                                                        <comment type="line">// Put this node in the leaf list at the
                                                            current index if its
                                                        </comment>
                                                        <comment type="line">// a non-epsilon leaf.</comment>
                                                        <comment type="line">//</comment>
                                                        <decl_stmt>
                                                            <decl>
                                                                <type>
                                                                    <specifier>final</specifier>
                                                                    <name>QName</name>
                                                                </type>
                                                                <name>node</name> =
                                                                <init>
                                                                    <expr>((<name>CMLeaf</name>)<name>nodeCur</name>).
                                                                        <call>
                                                                            <name>getElement</name>
                                                                            <argument_list>()</argument_list>
                                                                        </call>
                                                                    </expr>
                                                                </init>
                                                            </decl>
                                                            ;
                                                        </decl_stmt>
                                                        <if>if
                                                            <condition>(
                                                                <expr>
                                                                    <name><name>node</name>.
                                                                        <name>localpart</name>
                                                                    </name>
                                                                    !=
                                                                    <name>fEpsilonString</name>
                                                                </expr>
                                                                )
                                                            </condition>
                                                            <then>
                                                                <block>{
                                                                    <expr_stmt>
                                                                        <expr>
                                                                            <name>
                                                                                <name>fLeafList</name>
                                                                                <index>[
                                                                                    <expr>
                                                                                        <name>curIndex</name>
                                                                                    </expr>
                                                                                    ]
                                                                                </index>
                                                                            </name>
                                                                            = (<name>CMLeaf</name>)
                                                                            <name>nodeCur</name>
                                                                        </expr>
                                                                        ;
                                                                    </expr_stmt>
                                                                    <expr_stmt>
                                                                        <expr>
                                                                            <name>
                                                                                <name>fLeafListType</name>
                                                                                <index>[
                                                                                    <expr>
                                                                                        <name>curIndex</name>
                                                                                    </expr>
                                                                                    ]
                                                                                </index>
                                                                            </name>
                                                                            =
                                                                            <name><name>XMLContentSpec</name>.
                                                                                <name>CONTENTSPECNODE_LEAF</name>
                                                                            </name>
                                                                        </expr>
                                                                        ;
                                                                    </expr_stmt>
                                                                    <expr_stmt>
                                                                        <expr><name>curIndex</name>++
                                                                        </expr>
                                                                        ;
                                                                    </expr_stmt>
                                                                    }
                                                                </block>
                                                            </then>
                                                        </if>
                                                        }
                                                    </block>
                                                </then>
                                                <else>else
                                                    <block>{
                                                        <throw>throw
                                                            <expr>new
                                                                <call>
                                                                    <name>RuntimeException</name>
                                                                    <argument_list>(
                                                                        <argument>
                                                                            <expr>"ImplementationMessages.VAL_NIICM:
                                                                                type="+
                                                                                <call>
                                                                                    <name><name>nodeCur</name>.
                                                                                        <name>type</name>
                                                                                    </name>
                                                                                    <argument_list>()</argument_list>
                                                                                </call>
                                                                            </expr>
                                                                        </argument>
                                                                        )
                                                                    </argument_list>
                                                                </call>
                                                            </expr>
                                                            ;
                                                        </throw>
                                                        }
                                                    </block>
                                                </else>
                                            </if>
                                        </else>
                                    </if>
                                </else>
                            </if>
                        </else>
                    </if>
                    <return>return
                        <expr>
                            <name>curIndex</name>
                        </expr>
                        ;
                    </return>
                    }
                </block>
            </function>

            }
        </block>
    </class>
    <comment type="line">// class DFAContentModel</comment>
</unit>
