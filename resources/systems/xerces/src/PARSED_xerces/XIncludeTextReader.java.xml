<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<unit xmlns="http://www.sdml.info/srcML/src" language="Java"
      filename="C:\Users\dnader\git\biorimp\BIO-RIMP\test_data\code\xerces\src\org\apache\xerces\xinclude\XIncludeTextReader.java">
    <comment type="block">/*
        * Copyright 2003-2005 The Apache Software Foundation.
        *
        * Licensed under the Apache License, Version 2.0 (the "License");
        * you may not use this file except in compliance with the License.
        * You may obtain a copy of the License at
        *
        * http://www.apache.org/licenses/LICENSE-2.0
        *
        * Unless required by applicable law or agreed to in writing, software
        * distributed under the License is distributed on an "AS IS" BASIS,
        * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
        * See the License for the specific language governing permissions and
        * limitations under the License.
        */
    </comment>
    <package>package
        <name><name>org</name>.<name>apache</name>.<name>xerces</name>.
            <name>xinclude</name>
        </name>
        ;
    </package>

    <import>import
        <name><name>java</name>.<name>io</name>.
            <name>BufferedInputStream</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>java</name>.<name>io</name>.
            <name>IOException</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>java</name>.<name>io</name>.
            <name>InputStream</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>java</name>.<name>io</name>.
            <name>InputStreamReader</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>java</name>.<name>io</name>.
            <name>Reader</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>java</name>.<name>net</name>.
            <name>HttpURLConnection</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>java</name>.<name>net</name>.
            <name>URL</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>java</name>.<name>net</name>.
            <name>URLConnection</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>java</name>.<name>util</name>.
            <name>Iterator</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>java</name>.<name>util</name>.
            <name>Locale</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>java</name>.<name>util</name>.
            <name>Map</name>
        </name>
        ;
    </import>

    <import>import
        <name><name>org</name>.<name>apache</name>.<name>xerces</name>.<name>impl</name>.
            <name>XMLEntityManager</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>org</name>.<name>apache</name>.<name>xerces</name>.<name>impl</name>.
            <name>XMLErrorReporter</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>org</name>.<name>apache</name>.<name>xerces</name>.<name>impl</name>.<name>io</name>.
            <name>ASCIIReader</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>org</name>.<name>apache</name>.<name>xerces</name>.<name>impl</name>.<name>io</name>.
            <name>UTF8Reader</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>org</name>.<name>apache</name>.<name>xerces</name>.<name>impl</name>.<name>msg</name>.
            <name>XMLMessageFormatter</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>org</name>.<name>apache</name>.<name>xerces</name>.<name>util</name>.
            <name>EncodingMap</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>org</name>.<name>apache</name>.<name>xerces</name>.<name>util</name>.
            <name>HTTPInputSource</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>org</name>.<name>apache</name>.<name>xerces</name>.<name>util</name>.
            <name>MessageFormatter</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>org</name>.<name>apache</name>.<name>xerces</name>.<name>util</name>.
            <name>XMLChar</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>org</name>.<name>apache</name>.<name>xerces</name>.<name>xni</name>.
            <name>XMLString</name>
        </name>
        ;
    </import>
    <import>import
        <name><name>org</name>.<name>apache</name>.<name>xerces</name>.<name>xni</name>.<name>parser</name>.
            <name>XMLInputSource</name>
        </name>
        ;
    </import>

    <comment type="javadoc">/**
        * This class is used for reading resources requested in &amp;lt;include&amp;gt; elements,
        * when the parse attribute of the &amp;lt;include&amp;gt; element is "text". Using this
        * class will open the location, detect the encoding, and discard the byte order
        * mark, if applicable.
        *
        * REVISIT:
        * Much of the code in this class is taken from XMLEntityManager. It would be nice
        * if this code could be shared in some way. However, since XMLEntityManager is used
        * for reading files as XML, and this needs to read files as text, there would need
        * to be some refactoring done.
        *
        * @author Michael Glavassevich, IBM
        * @author Peter McCracken, IBM
        * @author Ankit Pasricha, IBM
        * @author Arun Yadav, Sun Microsystems Inc.
        *
        * @version $Id: XIncludeTextReader.java,v 1.15 2005/05/08 18:21:08 mrglavas Exp $
        *
        * @see XIncludeHandler
        */
    </comment>
    <class>
        <specifier>public</specifier>
        class <name>XIncludeTextReader</name>
        <block>{

            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>Reader</name>
                    </type>
                    <name>fReader</name>
                </decl>
                ;
            </decl_stmt>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>XIncludeHandler</name>
                    </type>
                    <name>fHandler</name>
                </decl>
                ;
            </decl_stmt>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>XMLInputSource</name>
                    </type>
                    <name>fSource</name>
                </decl>
                ;
            </decl_stmt>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>XMLErrorReporter</name>
                    </type>
                    <name>fErrorReporter</name>
                </decl>
                ;
            </decl_stmt>
            <decl_stmt>
                <decl>
                    <type>
                        <specifier>private</specifier>
                        <name>XMLString</name>
                    </type>
                    <name>fTempString</name> =
                    <init>
                        <expr>new
                            <call>
                                <name>XMLString</name>
                                <argument_list>()</argument_list>
                            </call>
                        </expr>
                    </init>
                </decl>
                ;
            </decl_stmt>

            <comment type="javadoc">/**
                * Construct the XIncludeReader using the XMLInputSource and XIncludeHandler.
                *
                * @param source The XMLInputSource to use.
                * @param handler The XIncludeHandler to use.
                * @param bufferSize The size of this text reader's buffer.
                */
            </comment>
            <constructor>
                <specifier>public</specifier>
                <name>XIncludeTextReader</name>
                <parameter_list>(
                    <param>
                        <decl>
                            <type>
                                <name>XMLInputSource</name>
                            </type>
                            <name>source</name>
                        </decl>
                    </param>
                    ,
                    <param>
                        <decl>
                            <type>
                                <name>XIncludeHandler</name>
                            </type>
                            <name>handler</name>
                        </decl>
                    </param>
                    ,
                    <param>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>bufferSize</name>
                        </decl>
                    </param>
                    )
                </parameter_list>
                <throws>throws
                    <argument>
                        <expr>
                            <name>IOException</name>
                        </expr>
                    </argument>
                </throws>
                <block>{
                    <expr_stmt>
                        <expr>
                            <name>fHandler</name>
                            =
                            <name>handler</name>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <name>fSource</name>
                            =
                            <name>source</name>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <name>fTempString</name>
                            = new
                            <call>
                                <name>XMLString</name>
                                <argument_list>(
                                    <argument>
                                        <expr>new
                                            <name>
                                                <name>char</name>
                                                <index>[
                                                    <expr>
                                                        <name>bufferSize</name>
                                                        + 1
                                                    </expr>
                                                    ]
                                                </index>
                                            </name>
                                        </expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>0</expr>
                                    </argument>
                                    ,
                                    <argument>
                                        <expr>0</expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    }
                </block>
            </constructor>

            <comment type="javadoc">/**
                * Sets the XMLErrorReporter used for reporting errors while
                * reading the text include.
                *
                * @param errorReporter the XMLErrorReporter to be used for
                * reporting errors.
                */
            </comment>
            <function>
                <type>
                    <specifier>public</specifier>
                    <name>void</name>
                </type>
                <name>setErrorReporter</name>
                <parameter_list>(
                    <param>
                        <decl>
                            <type>
                                <name>XMLErrorReporter</name>
                            </type>
                            <name>errorReporter</name>
                        </decl>
                    </param>
                    )
                </parameter_list>
                <block>{
                    <expr_stmt>
                        <expr>
                            <name>fErrorReporter</name>
                            =
                            <name>errorReporter</name>
                        </expr>
                        ;
                    </expr_stmt>
                    }
                </block>
            </function>

            <comment type="javadoc">/**
                * Return the Reader for given XMLInputSource.
                *
                * @param source The XMLInputSource to use.
                */
            </comment>
            <function>
                <type>
                    <specifier>protected</specifier>
                    <name>Reader</name>
                </type>
                <name>getReader</name>
                <parameter_list>(
                    <param>
                        <decl>
                            <type>
                                <name>XMLInputSource</name>
                            </type>
                            <name>source</name>
                        </decl>
                    </param>
                    )
                </parameter_list>
                <throws>throws
                    <argument>
                        <expr>
                            <name>IOException</name>
                        </expr>
                    </argument>
                </throws>
                <block>{
                    <if>if
                        <condition>(
                            <expr>
                                <call>
                                    <name><name>source</name>.
                                        <name>getCharacterStream</name>
                                    </name>
                                    <argument_list>()</argument_list>
                                </call>
                                !=
                                <name>null</name>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <return>return
                                    <expr>
                                        <call>
                                            <name><name>source</name>.
                                                <name>getCharacterStream</name>
                                            </name>
                                            <argument_list>()</argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </return>
                                }
                            </block>
                        </then>
                        <else>else
                            <block>{
                                <decl_stmt>
                                    <decl>
                                        <type>
                                            <name>InputStream</name>
                                        </type>
                                        <name>stream</name> =
                                        <init>
                                            <expr>
                                                <name>null</name>
                                            </expr>
                                        </init>
                                    </decl>
                                    ;
                                </decl_stmt>

                                <decl_stmt>
                                    <decl>
                                        <type>
                                            <name>String</name>
                                        </type>
                                        <name>encoding</name> =
                                        <init>
                                            <expr>
                                                <call>
                                                    <name><name>source</name>.
                                                        <name>getEncoding</name>
                                                    </name>
                                                    <argument_list>()</argument_list>
                                                </call>
                                            </expr>
                                        </init>
                                    </decl>
                                    ;
                                </decl_stmt>
                                <if>if
                                    <condition>(
                                        <expr>
                                            <name>encoding</name>
                                            ==
                                            <name>null</name>
                                        </expr>
                                        )
                                    </condition>
                                    <then>
                                        <block>{
                                            <expr_stmt>
                                                <expr>
                                                    <name>encoding</name>
                                                    = "UTF-8"
                                                </expr>
                                                ;
                                            </expr_stmt>
                                            }
                                        </block>
                                    </then>
                                </if>
                                <if>if
                                    <condition>(
                                        <expr>
                                            <call>
                                                <name><name>source</name>.
                                                    <name>getByteStream</name>
                                                </name>
                                                <argument_list>()</argument_list>
                                            </call>
                                            !=
                                            <name>null</name>
                                        </expr>
                                        )
                                    </condition>
                                    <then>
                                        <block>{
                                            <expr_stmt>
                                                <expr>
                                                    <name>stream</name>
                                                    =
                                                    <call>
                                                        <name><name>source</name>.
                                                            <name>getByteStream</name>
                                                        </name>
                                                        <argument_list>()</argument_list>
                                                    </call>
                                                </expr>
                                                ;
                                            </expr_stmt>
                                            <comment type="line">// Wrap the InputStream so that it is possible to
                                                rewind it.
                                            </comment>
                                            <if>if
                                                <condition>(
                                                    <expr>!(<name>stream</name>
                                                        <name>instanceof</name>
                                                        <name>BufferedInputStream</name>)
                                                    </expr>
                                                    )
                                                </condition>
                                                <then>
                                                    <block>{
                                                        <expr_stmt>
                                                            <expr>
                                                                <name>stream</name>
                                                                = new
                                                                <call>
                                                                    <name>BufferedInputStream</name>
                                                                    <argument_list>(
                                                                        <argument>
                                                                            <expr>
                                                                                <name>stream</name>
                                                                            </expr>
                                                                        </argument>
                                                                        ,
                                                                        <argument>
                                                                            <expr>
                                                                                <name><name>fTempString</name>.<name>
                                                                                    ch</name>.
                                                                                    <name>length</name>
                                                                                </name>
                                                                            </expr>
                                                                        </argument>
                                                                        )
                                                                    </argument_list>
                                                                </call>
                                                            </expr>
                                                            ;
                                                        </expr_stmt>
                                                        }
                                                    </block>
                                                </then>
                                            </if>
                                            }
                                        </block>
                                    </then>
                                    <else>else
                                        <block>{
                                            <decl_stmt>
                                                <decl>
                                                    <type>
                                                        <name>String</name>
                                                    </type>
                                                    <name>expandedSystemId</name> =
                                                    <init>
                                                        <expr>
                                                            <call>
                                                                <name><name>XMLEntityManager</name>.
                                                                    <name>expandSystemId</name>
                                                                </name>
                                                                <argument_list>(
                                                                    <argument>
                                                                        <expr>
                                                                            <call>
                                                                                <name><name>source</name>.
                                                                                    <name>getSystemId</name>
                                                                                </name>
                                                                                <argument_list>()</argument_list>
                                                                            </call>
                                                                        </expr>
                                                                    </argument>
                                                                    ,
                                                                    <argument>
                                                                        <expr>
                                                                            <call>
                                                                                <name><name>source</name>.
                                                                                    <name>getBaseSystemId</name>
                                                                                </name>
                                                                                <argument_list>()</argument_list>
                                                                            </call>
                                                                        </expr>
                                                                    </argument>
                                                                    ,
                                                                    <argument>
                                                                        <expr>false</expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                    </init>
                                                </decl>
                                                ;
                                            </decl_stmt>

                                            <decl_stmt>
                                                <decl>
                                                    <type>
                                                        <name>URL</name>
                                                    </type>
                                                    <name>url</name> =
                                                    <init>
                                                        <expr>new
                                                            <call>
                                                                <name>URL</name>
                                                                <argument_list>(
                                                                    <argument>
                                                                        <expr>
                                                                            <name>expandedSystemId</name>
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                    </init>
                                                </decl>
                                                ;
                                            </decl_stmt>
                                            <decl_stmt>
                                                <decl>
                                                    <type>
                                                        <name>URLConnection</name>
                                                    </type>
                                                    <name>urlCon</name> =
                                                    <init>
                                                        <expr>
                                                            <call>
                                                                <name><name>url</name>.
                                                                    <name>openConnection</name>
                                                                </name>
                                                                <argument_list>()</argument_list>
                                                            </call>
                                                        </expr>
                                                    </init>
                                                </decl>
                                                ;
                                            </decl_stmt>

                                            <comment type="line">// If this is an HTTP connection attach any request
                                                properties to the request.
                                            </comment>
                                            <if>if
                                                <condition>(
                                                    <expr>
                                                        <name>urlCon</name>
                                                        <name>instanceof</name>
                                                        <name>HttpURLConnection</name> &amp;&amp; <name>source</name>
                                                        <name>instanceof</name>
                                                        <name>HTTPInputSource</name>
                                                    </expr>
                                                    )
                                                </condition>
                                                <then>
                                                    <block>{
                                                        <decl_stmt>
                                                            <decl>
                                                                <type>
                                                                    <specifier>final</specifier>
                                                                    <name>HttpURLConnection</name>
                                                                </type>
                                                                <name>urlConnection</name> =
                                                                <init>
                                                                    <expr>(<name>HttpURLConnection</name>)
                                                                        <name>urlCon</name>
                                                                    </expr>
                                                                </init>
                                                            </decl>
                                                            ;
                                                        </decl_stmt>
                                                        <decl_stmt>
                                                            <decl>
                                                                <type>
                                                                    <specifier>final</specifier>
                                                                    <name>HTTPInputSource</name>
                                                                </type>
                                                                <name>httpInputSource</name> =
                                                                <init>
                                                                    <expr>(<name>HTTPInputSource</name>)
                                                                        <name>source</name>
                                                                    </expr>
                                                                </init>
                                                            </decl>
                                                            ;
                                                        </decl_stmt>

                                                        <comment type="line">// set request properties</comment>
                                                        <decl_stmt>
                                                            <decl>
                                                                <type>
                                                                    <name>Iterator</name>
                                                                </type>
                                                                <name>propIter</name> =
                                                                <init>
                                                                    <expr>
                                                                        <call>
                                                                            <name><name>httpInputSource</name>.
                                                                                <name>getHTTPRequestProperties</name>
                                                                            </name>
                                                                            <argument_list>()</argument_list>
                                                                        </call>
                                                                    </expr>
                                                                </init>
                                                            </decl>
                                                            ;
                                                        </decl_stmt>
                                                        <while>while
                                                            <condition>(
                                                                <expr>
                                                                    <call>
                                                                        <name><name>propIter</name>.
                                                                            <name>hasNext</name>
                                                                        </name>
                                                                        <argument_list>()</argument_list>
                                                                    </call>
                                                                </expr>
                                                                )
                                                            </condition>
                                                            <block>{
                                                                <decl_stmt>
                                                                    <decl>
                                                                        <type>
                                                                            <name><name>Map</name>.
                                                                                <name>Entry</name>
                                                                            </name>
                                                                        </type>
                                                                        <name>entry</name> =
                                                                        <init>
                                                                            <expr>(
                                                                                <name><name>Map</name>.
                                                                                    <name>Entry</name>
                                                                                </name>
                                                                                )
                                                                                <call>
                                                                                    <name><name>propIter</name>.
                                                                                        <name>next</name>
                                                                                    </name>
                                                                                    <argument_list>()</argument_list>
                                                                                </call>
                                                                            </expr>
                                                                        </init>
                                                                    </decl>
                                                                    ;
                                                                </decl_stmt>
                                                                <expr_stmt>
                                                                    <expr>
                                                                        <call>
                                                                            <name><name>urlConnection</name>.
                                                                                <name>setRequestProperty</name>
                                                                            </name>
                                                                            <argument_list>(
                                                                                <argument>
                                                                                    <expr>(<name>String</name>)
                                                                                        <call>
                                                                                            <name><name>entry</name>.
                                                                                                <name>getKey</name>
                                                                                            </name>
                                                                                            <argument_list>()
                                                                                            </argument_list>
                                                                                        </call>
                                                                                    </expr>
                                                                                </argument>
                                                                                ,
                                                                                <argument>
                                                                                    <expr>(<name>String</name>)
                                                                                        <call>
                                                                                            <name><name>entry</name>.
                                                                                                <name>getValue</name>
                                                                                            </name>
                                                                                            <argument_list>()
                                                                                            </argument_list>
                                                                                        </call>
                                                                                    </expr>
                                                                                </argument>
                                                                                )
                                                                            </argument_list>
                                                                        </call>
                                                                    </expr>
                                                                    ;
                                                                </expr_stmt>
                                                                }
                                                            </block>
                                                        </while>

                                                        <comment type="line">// set preference for redirection</comment>
                                                        <decl_stmt>
                                                            <decl>
                                                                <type>
                                                                    <name>boolean</name>
                                                                </type>
                                                                <name>followRedirects</name> =
                                                                <init>
                                                                    <expr>
                                                                        <call>
                                                                            <name><name>httpInputSource</name>.
                                                                                <name>getFollowHTTPRedirects</name>
                                                                            </name>
                                                                            <argument_list>()</argument_list>
                                                                        </call>
                                                                    </expr>
                                                                </init>
                                                            </decl>
                                                            ;
                                                        </decl_stmt>
                                                        <if>if
                                                            <condition>(
                                                                <expr>!
                                                                    <name>followRedirects</name>
                                                                </expr>
                                                                )
                                                            </condition>
                                                            <then>
                                                                <block>{
                                                                    <expr_stmt>
                                                                        <expr>
                                                                            <call>
                                                                                <name><name>XMLEntityManager</name>.
                                                                                    <name>setInstanceFollowRedirects
                                                                                    </name>
                                                                                </name>
                                                                                <argument_list>(
                                                                                    <argument>
                                                                                        <expr>
                                                                                            <name>urlConnection</name>
                                                                                        </expr>
                                                                                    </argument>
                                                                                    ,
                                                                                    <argument>
                                                                                        <expr>
                                                                                            <name>followRedirects</name>
                                                                                        </expr>
                                                                                    </argument>
                                                                                    )
                                                                                </argument_list>
                                                                            </call>
                                                                        </expr>
                                                                        ;
                                                                    </expr_stmt>
                                                                    }
                                                                </block>
                                                            </then>
                                                        </if>
                                                        }
                                                    </block>
                                                </then>
                                            </if>

                                            <comment type="line">// Wrap the InputStream so that it is possible to
                                                rewind it.
                                            </comment>
                                            <expr_stmt>
                                                <expr>
                                                    <name>stream</name>
                                                    = new
                                                    <call>
                                                        <name>BufferedInputStream</name>
                                                        <argument_list>(
                                                            <argument>
                                                                <expr>
                                                                    <call>
                                                                        <name><name>urlCon</name>.
                                                                            <name>getInputStream</name>
                                                                        </name>
                                                                        <argument_list>()</argument_list>
                                                                    </call>
                                                                </expr>
                                                            </argument>
                                                            )
                                                        </argument_list>
                                                    </call>
                                                </expr>
                                                ;
                                            </expr_stmt>

                                            <comment type="line">// content type will be string like "text/xml;
                                                charset=UTF-8" or "text/xml"
                                            </comment>
                                            <decl_stmt>
                                                <decl>
                                                    <type>
                                                        <name>String</name>
                                                    </type>
                                                    <name>rawContentType</name> =
                                                    <init>
                                                        <expr>
                                                            <call>
                                                                <name><name>urlCon</name>.
                                                                    <name>getContentType</name>
                                                                </name>
                                                                <argument_list>()</argument_list>
                                                            </call>
                                                        </expr>
                                                    </init>
                                                </decl>
                                                ;
                                            </decl_stmt>

                                            <comment type="line">// text/xml and application/xml offer only one optional
                                                parameter
                                            </comment>
                                            <decl_stmt>
                                                <decl>
                                                    <type>
                                                        <name>int</name>
                                                    </type>
                                                    <name>index</name> =
                                                    <init>
                                                        <expr>(<name>rawContentType</name> != <name>null</name>) ?
                                                            <call>
                                                                <name><name>rawContentType</name>.
                                                                    <name>indexOf</name>
                                                                </name>
                                                                <argument_list>(
                                                                    <argument>
                                                                        <expr>';'</expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                            : -1
                                                        </expr>
                                                    </init>
                                                </decl>
                                                ;
                                            </decl_stmt>

                                            <decl_stmt>
                                                <decl>
                                                    <type>
                                                        <name>String</name>
                                                    </type>
                                                    <name>contentType</name> =
                                                    <init>
                                                        <expr>
                                                            <name>null</name>
                                                        </expr>
                                                    </init>
                                                </decl>
                                                ;
                                            </decl_stmt>
                                            <decl_stmt>
                                                <decl>
                                                    <type>
                                                        <name>String</name>
                                                    </type>
                                                    <name>charset</name> =
                                                    <init>
                                                        <expr>
                                                            <name>null</name>
                                                        </expr>
                                                    </init>
                                                </decl>
                                                ;
                                            </decl_stmt>
                                            <if>if
                                                <condition>(
                                                    <expr>
                                                        <name>index</name>
                                                        != -1
                                                    </expr>
                                                    )
                                                </condition>
                                                <then>
                                                    <block>{
                                                        <comment type="line">// this should be something like
                                                            "text/xml"
                                                        </comment>
                                                        <expr_stmt>
                                                            <expr>
                                                                <name>contentType</name>
                                                                =
                                                                <call>
                                                                    <name><name>rawContentType</name>.
                                                                        <name>substring</name>
                                                                    </name>
                                                                    <argument_list>(
                                                                        <argument>
                                                                            <expr>0</expr>
                                                                        </argument>
                                                                        ,
                                                                        <argument>
                                                                            <expr>
                                                                                <name>index</name>
                                                                            </expr>
                                                                        </argument>
                                                                        )
                                                                    </argument_list>
                                                                </call>
                                                                .
                                                                <call>
                                                                    <name>trim</name>
                                                                    <argument_list>()</argument_list>
                                                                </call>
                                                            </expr>
                                                            ;
                                                        </expr_stmt>

                                                        <comment type="line">// this should be something like
                                                            "charset=UTF-8", but we want to
                                                        </comment>
                                                        <comment type="line">// strip it down to just "UTF-8"</comment>
                                                        <expr_stmt>
                                                            <expr>
                                                                <name>charset</name>
                                                                =
                                                                <call>
                                                                    <name><name>rawContentType</name>.
                                                                        <name>substring</name>
                                                                    </name>
                                                                    <argument_list>(
                                                                        <argument>
                                                                            <expr>
                                                                                <name>index</name>
                                                                                + 1
                                                                            </expr>
                                                                        </argument>
                                                                        )
                                                                    </argument_list>
                                                                </call>
                                                                .
                                                                <call>
                                                                    <name>trim</name>
                                                                    <argument_list>()</argument_list>
                                                                </call>
                                                            </expr>
                                                            ;
                                                        </expr_stmt>
                                                        <if>if
                                                            <condition>(
                                                                <expr>
                                                                    <call>
                                                                        <name><name>charset</name>.
                                                                            <name>startsWith</name>
                                                                        </name>
                                                                        <argument_list>(
                                                                            <argument>
                                                                                <expr>"charset="</expr>
                                                                            </argument>
                                                                            )
                                                                        </argument_list>
                                                                    </call>
                                                                </expr>
                                                                )
                                                            </condition>
                                                            <then>
                                                                <block>{
                                                                    <comment type="line">// 8 is the length of
                                                                        "charset="
                                                                    </comment>
                                                                    <expr_stmt>
                                                                        <expr>
                                                                            <name>charset</name>
                                                                            =
                                                                            <call>
                                                                                <name><name>charset</name>.
                                                                                    <name>substring</name>
                                                                                </name>
                                                                                <argument_list>(
                                                                                    <argument>
                                                                                        <expr>8</expr>
                                                                                    </argument>
                                                                                    )
                                                                                </argument_list>
                                                                            </call>
                                                                            .
                                                                            <call>
                                                                                <name>trim</name>
                                                                                <argument_list>()</argument_list>
                                                                            </call>
                                                                        </expr>
                                                                        ;
                                                                    </expr_stmt>
                                                                    <comment type="line">// strip quotes, if present
                                                                    </comment>
                                                                    <if>if
                                                                        <condition>(
                                                                            <expr>(
                                                                                <call>
                                                                                    <name><name>charset</name>.
                                                                                        <name>charAt</name>
                                                                                    </name>
                                                                                    <argument_list>(
                                                                                        <argument>
                                                                                            <expr>0</expr>
                                                                                        </argument>
                                                                                        )
                                                                                    </argument_list>
                                                                                </call>
                                                                                == '"'
                                                                                &amp;&amp;
                                                                                <call>
                                                                                    <name><name>charset</name>.
                                                                                        <name>charAt</name>
                                                                                    </name>
                                                                                    <argument_list>(
                                                                                        <argument>
                                                                                            <expr>
                                                                                                <call>
                                                                                                    <name><name>
                                                                                                        charset</name>.
                                                                                                        <name>length
                                                                                                        </name>
                                                                                                    </name>
                                                                                                    <argument_list>()
                                                                                                    </argument_list>
                                                                                                </call>
                                                                                                - 1
                                                                                            </expr>
                                                                                        </argument>
                                                                                        )
                                                                                    </argument_list>
                                                                                </call>
                                                                                == '"')
                                                                                || (
                                                                                <call>
                                                                                    <name><name>charset</name>.
                                                                                        <name>charAt</name>
                                                                                    </name>
                                                                                    <argument_list>(
                                                                                        <argument>
                                                                                            <expr>0</expr>
                                                                                        </argument>
                                                                                        )
                                                                                    </argument_list>
                                                                                </call>
                                                                                == '\''
                                                                                &amp;&amp;
                                                                                <call>
                                                                                    <name><name>charset</name>.
                                                                                        <name>charAt</name>
                                                                                    </name>
                                                                                    <argument_list>(
                                                                                        <argument>
                                                                                            <expr>
                                                                                                <call>
                                                                                                    <name><name>
                                                                                                        charset</name>.
                                                                                                        <name>length
                                                                                                        </name>
                                                                                                    </name>
                                                                                                    <argument_list>()
                                                                                                    </argument_list>
                                                                                                </call>
                                                                                                - 1
                                                                                            </expr>
                                                                                        </argument>
                                                                                        )
                                                                                    </argument_list>
                                                                                </call>
                                                                                == '\'')
                                                                            </expr>
                                                                            )
                                                                        </condition>
                                                                        <then>
                                                                            <block>{
                                                                                <expr_stmt>
                                                                                    <expr>
                                                                                        <name>charset</name>
                                                                                        =
                                                                                        <call>
                                                                                            <name><name>charset</name>.
                                                                                                <name>substring</name>
                                                                                            </name>
                                                                                            <argument_list>(
                                                                                                <argument>
                                                                                                    <expr>1</expr>
                                                                                                </argument>
                                                                                                ,
                                                                                                <argument>
                                                                                                    <expr>
                                                                                                        <call>
                                                                                                            <name><name>
                                                                                                                charset</name>
                                                                                                                .
                                                                                                                <name>
                                                                                                                    length
                                                                                                                </name>
                                                                                                            </name>
                                                                                                            <argument_list>
                                                                                                                ()
                                                                                                            </argument_list>
                                                                                                        </call>
                                                                                                        - 1
                                                                                                    </expr>
                                                                                                </argument>
                                                                                                )
                                                                                            </argument_list>
                                                                                        </call>
                                                                                    </expr>
                                                                                    ;
                                                                                </expr_stmt>
                                                                                }
                                                                            </block>
                                                                        </then>
                                                                    </if>
                                                                    }
                                                                </block>
                                                            </then>
                                                            <else>else
                                                                <block>{
                                                                    <expr_stmt>
                                                                        <expr>
                                                                            <name>charset</name>
                                                                            =
                                                                            <name>null</name>
                                                                        </expr>
                                                                        ;
                                                                    </expr_stmt>
                                                                    }
                                                                </block>
                                                            </else>
                                                        </if>
                                                        }
                                                    </block>
                                                </then>
                                                <else>else
                                                    <block>{
                                                        <expr_stmt>
                                                            <expr>
                                                                <name>contentType</name>
                                                                =
                                                                <call>
                                                                    <name><name>rawContentType</name>.
                                                                        <name>trim</name>
                                                                    </name>
                                                                    <argument_list>()</argument_list>
                                                                </call>
                                                            </expr>
                                                            ;
                                                        </expr_stmt>
                                                        }
                                                    </block>
                                                </else>
                                            </if>

                                            <decl_stmt>
                                                <decl>
                                                    <type>
                                                        <name>String</name>
                                                    </type>
                                                    <name>detectedEncoding</name> =
                                                    <init>
                                                        <expr>
                                                            <name>null</name>
                                                        </expr>
                                                    </init>
                                                </decl>
                                                ;
                                            </decl_stmt>
                                            <comment type="javadoc">/** The encoding of such a resource is determined
                                                by:
                                                1 external encoding information, if available, otherwise
                                                -- the most common type of external information is the "charset"
                                                parameter of a MIME package
                                                2 if the media type of the resource is text/xml, application/xml, or
                                                matches the conventions text/*+xml or application/*+xml as described in
                                                XML Media Types [IETF RFC 3023], the encoding is recognized as specified
                                                in XML 1.0, otherwise
                                                3 the value of the encoding attribute if one exists, otherwise
                                                4 UTF-8.
                                                **/
                                            </comment>
                                            <if>if
                                                <condition>(
                                                    <expr>
                                                        <call>
                                                            <name><name>contentType</name>.
                                                                <name>equals</name>
                                                            </name>
                                                            <argument_list>(
                                                                <argument>
                                                                    <expr>"text/xml"</expr>
                                                                </argument>
                                                                )
                                                            </argument_list>
                                                        </call>
                                                    </expr>
                                                    )
                                                </condition>
                                                <then>
                                                    <block>{
                                                        <if>if
                                                            <condition>(
                                                                <expr>
                                                                    <name>charset</name>
                                                                    !=
                                                                    <name>null</name>
                                                                </expr>
                                                                )
                                                            </condition>
                                                            <then>
                                                                <block>{
                                                                    <expr_stmt>
                                                                        <expr>
                                                                            <name>detectedEncoding</name>
                                                                            =
                                                                            <name>charset</name>
                                                                        </expr>
                                                                        ;
                                                                    </expr_stmt>
                                                                    }
                                                                </block>
                                                            </then>
                                                            <else>else
                                                                <block>{
                                                                    <comment type="line">// see RFC2376 or 3023, section
                                                                        3.1
                                                                    </comment>
                                                                    <expr_stmt>
                                                                        <expr>
                                                                            <name>detectedEncoding</name>
                                                                            = "US-ASCII"
                                                                        </expr>
                                                                        ;
                                                                    </expr_stmt>
                                                                    }
                                                                </block>
                                                            </else>
                                                        </if>
                                                        }
                                                    </block>
                                                </then>
                                                <else>else
                                                    <if>if
                                                        <condition>(
                                                            <expr>
                                                                <call>
                                                                    <name><name>contentType</name>.
                                                                        <name>equals</name>
                                                                    </name>
                                                                    <argument_list>(
                                                                        <argument>
                                                                            <expr>"application/xml"</expr>
                                                                        </argument>
                                                                        )
                                                                    </argument_list>
                                                                </call>
                                                            </expr>
                                                            )
                                                        </condition>
                                                        <then>
                                                            <block>{
                                                                <if>if
                                                                    <condition>(
                                                                        <expr>
                                                                            <name>charset</name>
                                                                            !=
                                                                            <name>null</name>
                                                                        </expr>
                                                                        )
                                                                    </condition>
                                                                    <then>
                                                                        <block>{
                                                                            <expr_stmt>
                                                                                <expr>
                                                                                    <name>detectedEncoding</name>
                                                                                    =
                                                                                    <name>charset</name>
                                                                                </expr>
                                                                                ;
                                                                            </expr_stmt>
                                                                            }
                                                                        </block>
                                                                    </then>
                                                                    <else>else
                                                                        <block>{
                                                                            <comment type="line">// see RFC2376 or 3023,
                                                                                section 3.2
                                                                            </comment>
                                                                            <expr_stmt>
                                                                                <expr>
                                                                                    <name>detectedEncoding</name>
                                                                                    =
                                                                                    <call>
                                                                                        <name>getEncodingName</name>
                                                                                        <argument_list>(
                                                                                            <argument>
                                                                                                <expr>
                                                                                                    <name>stream</name>
                                                                                                </expr>
                                                                                            </argument>
                                                                                            )
                                                                                        </argument_list>
                                                                                    </call>
                                                                                </expr>
                                                                                ;
                                                                            </expr_stmt>
                                                                            }
                                                                        </block>
                                                                    </else>
                                                                </if>
                                                                }
                                                            </block>
                                                        </then>
                                                        <else>else
                                                            <if>if
                                                                <condition>(
                                                                    <expr>
                                                                        <call>
                                                                            <name><name>contentType</name>.
                                                                                <name>endsWith</name>
                                                                            </name>
                                                                            <argument_list>(
                                                                                <argument>
                                                                                    <expr>"+xml"</expr>
                                                                                </argument>
                                                                                )
                                                                            </argument_list>
                                                                        </call>
                                                                    </expr>
                                                                    )
                                                                </condition>
                                                                <then>
                                                                    <block>{
                                                                        <expr_stmt>
                                                                            <expr>
                                                                                <name>detectedEncoding</name>
                                                                                =
                                                                                <call>
                                                                                    <name>getEncodingName</name>
                                                                                    <argument_list>(
                                                                                        <argument>
                                                                                            <expr>
                                                                                                <name>stream</name>
                                                                                            </expr>
                                                                                        </argument>
                                                                                        )
                                                                                    </argument_list>
                                                                                </call>
                                                                            </expr>
                                                                            ;
                                                                        </expr_stmt>
                                                                        }
                                                                    </block>
                                                                </then>
                                                            </if>
                                                        </else>
                                                    </if>
                                                </else>
                                            </if>

                                            <if>if
                                                <condition>(
                                                    <expr>
                                                        <name>detectedEncoding</name>
                                                        !=
                                                        <name>null</name>
                                                    </expr>
                                                    )
                                                </condition>
                                                <then>
                                                    <block>{
                                                        <expr_stmt>
                                                            <expr>
                                                                <name>encoding</name>
                                                                =
                                                                <name>detectedEncoding</name>
                                                            </expr>
                                                            ;
                                                        </expr_stmt>
                                                        }
                                                    </block>
                                                </then>
                                            </if>
                                            <comment type="line">// else 3 or 4.</comment>
                                            }
                                        </block>
                                    </else>
                                </if>

                                <expr_stmt>
                                    <expr>
                                        <name>encoding</name>
                                        =
                                        <call>
                                            <name><name>encoding</name>.
                                                <name>toUpperCase</name>
                                            </name>
                                            <argument_list>(
                                                <argument>
                                                    <expr>
                                                        <name><name>Locale</name>.
                                                            <name>ENGLISH</name>
                                                        </name>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>

                                <comment type="line">// eat the Byte Order Mark</comment>
                                <expr_stmt>
                                    <expr>
                                        <name>encoding</name>
                                        =
                                        <call>
                                            <name>consumeBOM</name>
                                            <argument_list>(
                                                <argument>
                                                    <expr>
                                                        <name>stream</name>
                                                    </expr>
                                                </argument>
                                                ,
                                                <argument>
                                                    <expr>
                                                        <name>encoding</name>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>

                                <comment type="line">// If the document is UTF-8 or US-ASCII use</comment>
                                <comment type="line">// the Xerces readers for these encodings. For</comment>
                                <comment type="line">// US-ASCII consult the encoding map since</comment>
                                <comment type="line">// this encoding has many aliases.</comment>
                                <if>if
                                    <condition>(
                                        <expr>
                                            <call>
                                                <name><name>encoding</name>.
                                                    <name>equals</name>
                                                </name>
                                                <argument_list>(
                                                    <argument>
                                                        <expr>"UTF-8"</expr>
                                                    </argument>
                                                    )
                                                </argument_list>
                                            </call>
                                        </expr>
                                        )
                                    </condition>
                                    <then>
                                        <block>{
                                            <return>return
                                                <expr>new
                                                    <call>
                                                        <name>UTF8Reader</name>
                                                        <argument_list>(
                                                            <argument>
                                                                <expr>
                                                                    <name>stream</name>
                                                                </expr>
                                                            </argument>
                                                            ,
                                                            <argument>
                                                                <expr>
                                                                    <name><name>fTempString</name>.<name>ch</name>.
                                                                        <name>length</name>
                                                                    </name>
                                                                </expr>
                                                            </argument>
                                                            ,
                                                            <argument>
                                                                <expr>
                                                                    <call>
                                                                        <name><name>fErrorReporter</name>.
                                                                            <name>getMessageFormatter</name>
                                                                        </name>
                                                                        <argument_list>(
                                                                            <argument>
                                                                                <expr>
                                                                                    <name><name>
                                                                                        XMLMessageFormatter</name>.
                                                                                        <name>XML_DOMAIN</name>
                                                                                    </name>
                                                                                </expr>
                                                                            </argument>
                                                                            )
                                                                        </argument_list>
                                                                    </call>
                                                                </expr>
                                                            </argument>
                                                            ,
                                                            <argument>
                                                                <expr>
                                                                    <call>
                                                                        <name><name>fErrorReporter</name>.
                                                                            <name>getLocale</name>
                                                                        </name>
                                                                        <argument_list>()</argument_list>
                                                                    </call>
                                                                </expr>
                                                            </argument>
                                                            )
                                                        </argument_list>
                                                    </call>
                                                </expr>
                                                ;
                                            </return>
                                            }
                                        </block>
                                    </then>
                                </if>

                                <comment type="line">// Try to use a Java reader.</comment>
                                <decl_stmt>
                                    <decl>
                                        <type>
                                            <name>String</name>
                                        </type>
                                        <name>javaEncoding</name> =
                                        <init>
                                            <expr>
                                                <call>
                                                    <name><name>EncodingMap</name>.
                                                        <name>getIANA2JavaMapping</name>
                                                    </name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>
                                                                <name>encoding</name>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                        </init>
                                    </decl>
                                    ;
                                </decl_stmt>

                                <comment type="line">// If the specified encoding wasn't a recognized IANA encoding
                                    throw an IOException.
                                </comment>
                                <comment type="line">// The XIncludeHandler will report this as a ResourceError and then
                                    will
                                </comment>
                                <comment type="line">// attempt to include a fallback if there is one.</comment>
                                <if>if
                                    <condition>(
                                        <expr>
                                            <name>javaEncoding</name>
                                            ==
                                            <name>null</name>
                                        </expr>
                                        )
                                    </condition>
                                    <then>
                                        <block>{
                                            <decl_stmt>
                                                <decl>
                                                    <type>
                                                        <name>MessageFormatter</name>
                                                    </type>
                                                    <name>aFormatter</name> =
                                                    <init>
                                                        <expr>
                                                            <call>
                                                                <name><name>fErrorReporter</name>.
                                                                    <name>getMessageFormatter</name>
                                                                </name>
                                                                <argument_list>(
                                                                    <argument>
                                                                        <expr>
                                                                            <name><name>XMLMessageFormatter</name>.
                                                                                <name>XML_DOMAIN</name>
                                                                            </name>
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                    </init>
                                                </decl>
                                                ;
                                            </decl_stmt>
                                            <decl_stmt>
                                                <decl>
                                                    <type>
                                                        <name>Locale</name>
                                                    </type>
                                                    <name>aLocale</name> =
                                                    <init>
                                                        <expr>
                                                            <call>
                                                                <name><name>fErrorReporter</name>.
                                                                    <name>getLocale</name>
                                                                </name>
                                                                <argument_list>()</argument_list>
                                                            </call>
                                                        </expr>
                                                    </init>
                                                </decl>
                                                ;
                                            </decl_stmt>
                                            <throw>throw
                                                <expr>new
                                                    <call>
                                                        <name>IOException</name>
                                                        <argument_list>(
                                                            <argument>
                                                                <expr>
                                                                    <call>
                                                                        <name><name>aFormatter</name>.
                                                                            <name>formatMessage</name>
                                                                        </name>
                                                                        <argument_list>(
                                                                            <argument>
                                                                                <expr>
                                                                                    <name>aLocale</name>
                                                                                </expr>
                                                                            </argument>
                                                                            ,
                                                                            <argument>
                                                                                <expr>"EncodingDeclInvalid"</expr>
                                                                            </argument>
                                                                            ,
                                                                            <argument>
                                                                                <expr>new
                                                                                    <name>
                                                                                        <name>Object</name>
                                                                                        <index>[]</index>
                                                                                    </name>
                                                                                    <block>{
                                                                                        <expr>
                                                                                            <name>encoding</name>
                                                                                        </expr>
                                                                                        }
                                                                                    </block>
                                                                                </expr>
                                                                            </argument>
                                                                            )
                                                                        </argument_list>
                                                                    </call>
                                                                </expr>
                                                            </argument>
                                                            )
                                                        </argument_list>
                                                    </call>
                                                </expr>
                                                ;
                                            </throw>
                                            }
                                        </block>
                                    </then>
                                    <else>else
                                        <if>if
                                            <condition>(
                                                <expr>
                                                    <call>
                                                        <name><name>javaEncoding</name>.
                                                            <name>equals</name>
                                                        </name>
                                                        <argument_list>(
                                                            <argument>
                                                                <expr>"ASCII"</expr>
                                                            </argument>
                                                            )
                                                        </argument_list>
                                                    </call>
                                                </expr>
                                                )
                                            </condition>
                                            <then>
                                                <block>{
                                                    <return>return
                                                        <expr>new
                                                            <call>
                                                                <name>ASCIIReader</name>
                                                                <argument_list>(
                                                                    <argument>
                                                                        <expr>
                                                                            <name>stream</name>
                                                                        </expr>
                                                                    </argument>
                                                                    ,
                                                                    <argument>
                                                                        <expr>
                                                                            <name><name>fTempString</name>.<name>
                                                                                ch</name>.
                                                                                <name>length</name>
                                                                            </name>
                                                                        </expr>
                                                                    </argument>
                                                                    ,
                                                                    <argument>
                                                                        <expr>
                                                                            <call>
                                                                                <name><name>fErrorReporter</name>.
                                                                                    <name>getMessageFormatter</name>
                                                                                </name>
                                                                                <argument_list>(
                                                                                    <argument>
                                                                                        <expr>
                                                                                            <name><name>
                                                                                                XMLMessageFormatter</name>
                                                                                                .
                                                                                                <name>XML_DOMAIN</name>
                                                                                            </name>
                                                                                        </expr>
                                                                                    </argument>
                                                                                    )
                                                                                </argument_list>
                                                                            </call>
                                                                        </expr>
                                                                    </argument>
                                                                    ,
                                                                    <argument>
                                                                        <expr>
                                                                            <call>
                                                                                <name><name>fErrorReporter</name>.
                                                                                    <name>getLocale</name>
                                                                                </name>
                                                                                <argument_list>()</argument_list>
                                                                            </call>
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                        ;
                                                    </return>
                                                    }
                                                </block>
                                            </then>
                                        </if>
                                    </else>
                                </if>

                                <return>return
                                    <expr>new
                                        <call>
                                            <name>InputStreamReader</name>
                                            <argument_list>(
                                                <argument>
                                                    <expr>
                                                        <name>stream</name>
                                                    </expr>
                                                </argument>
                                                ,
                                                <argument>
                                                    <expr>
                                                        <name>javaEncoding</name>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </return>
                                }
                            </block>
                        </else>
                    </if>
                    }
                </block>
            </function>

            <comment type="javadoc">/**
                * XMLEntityManager cares about endian-ness, since it creates its own optimized
                * readers. Since we're just using generic Java readers for now, we're not caring
                * about endian-ness. If this changes, even more code needs to be copied from
                * XMLEntity manager. -- PJM
                */
            </comment>
            <function>
                <type>
                    <specifier>protected</specifier>
                    <name>String</name>
                </type>
                <name>getEncodingName</name>
                <parameter_list>(
                    <param>
                        <decl>
                            <type>
                                <name>InputStream</name>
                            </type>
                            <name>stream</name>
                        </decl>
                    </param>
                    )
                </parameter_list>
                <throws>throws
                    <argument>
                        <expr>
                            <name>IOException</name>
                        </expr>
                    </argument>
                </throws>
                <block>{
                    <decl_stmt>
                        <decl>
                            <type>
                                <specifier>final</specifier>
                                <name>byte</name>
                                <index>[]</index>
                            </type>
                            <name>b4</name> =
                            <init>
                                <expr>new
                                    <name>
                                        <name>byte</name>
                                        <index>[<expr>4</expr>]
                                        </index>
                                    </name>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>encoding</name> =
                            <init>
                                <expr>
                                    <name>null</name>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>

                    <comment type="line">// this has the potential to throw an exception</comment>
                    <comment type="line">// it will be fixed when we ensure the stream is rewindable (see note above)
                    </comment>
                    <expr_stmt>
                        <expr>
                            <call>
                                <name><name>stream</name>.
                                    <name>mark</name>
                                </name>
                                <argument_list>(
                                    <argument>
                                        <expr>4</expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>count</name> =
                            <init>
                                <expr>
                                    <call>
                                        <name><name>stream</name>.
                                            <name>read</name>
                                        </name>
                                        <argument_list>(
                                            <argument>
                                                <expr>
                                                    <name>b4</name>
                                                </expr>
                                            </argument>
                                            ,
                                            <argument>
                                                <expr>0</expr>
                                            </argument>
                                            ,
                                            <argument>
                                                <expr>4</expr>
                                            </argument>
                                            )
                                        </argument_list>
                                    </call>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <expr_stmt>
                        <expr>
                            <call>
                                <name><name>stream</name>.
                                    <name>reset</name>
                                </name>
                                <argument_list>()</argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <if>if
                        <condition>(
                            <expr>
                                <name>count</name>
                                == 4
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <expr_stmt>
                                    <expr>
                                        <name>encoding</name>
                                        =
                                        <call>
                                            <name>getEncodingName</name>
                                            <argument_list>(
                                                <argument>
                                                    <expr>
                                                        <name>b4</name>
                                                    </expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </then>
                    </if>

                    <return>return
                        <expr>
                            <name>encoding</name>
                        </expr>
                        ;
                    </return>
                    }
                </block>
            </function>

            <comment type="javadoc">/**
                * Removes the byte order mark from the stream, if
                * it exists and returns the encoding name.
                *
                * @param stream
                * @param encoding
                * @throws IOException
                */
            </comment>
            <function>
                <type>
                    <specifier>protected</specifier>
                    <name>String</name>
                </type>
                <name>consumeBOM</name>
                <parameter_list>(
                    <param>
                        <decl>
                            <type>
                                <name>InputStream</name>
                            </type>
                            <name>stream</name>
                        </decl>
                    </param>
                    ,
                    <param>
                        <decl>
                            <type>
                                <name>String</name>
                            </type>
                            <name>encoding</name>
                        </decl>
                    </param>
                    )
                </parameter_list>
                <throws>throws
                    <argument>
                        <expr>
                            <name>IOException</name>
                        </expr>
                    </argument>
                </throws>
                <block>{

                    <decl_stmt>
                        <decl>
                            <type>
                                <name>byte</name>
                                <index>[]</index>
                            </type>
                            <name>b</name> =
                            <init>
                                <expr>new
                                    <name>
                                        <name>byte</name>
                                        <index>[<expr>3</expr>]
                                        </index>
                                    </name>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>count</name> =
                            <init>
                                <expr>0</expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <expr_stmt>
                        <expr>
                            <call>
                                <name><name>stream</name>.
                                    <name>mark</name>
                                </name>
                                <argument_list>(
                                    <argument>
                                        <expr>3</expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <if>if
                        <condition>(
                            <expr>
                                <call>
                                    <name><name>encoding</name>.
                                        <name>equals</name>
                                    </name>
                                    <argument_list>(
                                        <argument>
                                            <expr>"UTF-8"</expr>
                                        </argument>
                                        )
                                    </argument_list>
                                </call>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <expr_stmt>
                                    <expr>
                                        <name>count</name>
                                        =
                                        <call>
                                            <name><name>stream</name>.
                                                <name>read</name>
                                            </name>
                                            <argument_list>(
                                                <argument>
                                                    <expr>
                                                        <name>b</name>
                                                    </expr>
                                                </argument>
                                                ,
                                                <argument>
                                                    <expr>0</expr>
                                                </argument>
                                                ,
                                                <argument>
                                                    <expr>3</expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                <if>if
                                    <condition>(
                                        <expr>
                                            <name>count</name>
                                            == 3
                                        </expr>
                                        )
                                    </condition>
                                    <then>
                                        <block>{
                                            <decl_stmt>
                                                <decl>
                                                    <type>
                                                        <specifier>final</specifier>
                                                        <name>int</name>
                                                    </type>
                                                    <name>b0</name> =
                                                    <init>
                                                        <expr>
                                                            <name>
                                                                <name>b</name>
                                                                <index>[<expr>0</expr>]
                                                                </index>
                                                            </name>
                                                            &amp; 0xFF
                                                        </expr>
                                                    </init>
                                                </decl>
                                                ;
                                            </decl_stmt>
                                            <decl_stmt>
                                                <decl>
                                                    <type>
                                                        <specifier>final</specifier>
                                                        <name>int</name>
                                                    </type>
                                                    <name>b1</name> =
                                                    <init>
                                                        <expr>
                                                            <name>
                                                                <name>b</name>
                                                                <index>[<expr>1</expr>]
                                                                </index>
                                                            </name>
                                                            &amp; 0xFF
                                                        </expr>
                                                    </init>
                                                </decl>
                                                ;
                                            </decl_stmt>
                                            <decl_stmt>
                                                <decl>
                                                    <type>
                                                        <specifier>final</specifier>
                                                        <name>int</name>
                                                    </type>
                                                    <name>b2</name> =
                                                    <init>
                                                        <expr>
                                                            <name>
                                                                <name>b</name>
                                                                <index>[<expr>2</expr>]
                                                                </index>
                                                            </name>
                                                            &amp; 0xFF
                                                        </expr>
                                                    </init>
                                                </decl>
                                                ;
                                            </decl_stmt>
                                            <if>if
                                                <condition>(
                                                    <expr>
                                                        <name>b0</name>
                                                        != 0xEF || <name>b1</name> != 0xBB || <name>b2</name> != 0xBF
                                                    </expr>
                                                    )
                                                </condition>
                                                <then>
                                                    <block>{
                                                        <comment type="line">// First three bytes are not BOM, so
                                                            reset.
                                                        </comment>
                                                        <expr_stmt>
                                                            <expr>
                                                                <call>
                                                                    <name><name>stream</name>.
                                                                        <name>reset</name>
                                                                    </name>
                                                                    <argument_list>()</argument_list>
                                                                </call>
                                                            </expr>
                                                            ;
                                                        </expr_stmt>
                                                        }
                                                    </block>
                                                </then>
                                            </if>
                                            }
                                        </block>
                                    </then>
                                    <else>else
                                        <block>{
                                            <expr_stmt>
                                                <expr>
                                                    <call>
                                                        <name><name>stream</name>.
                                                            <name>reset</name>
                                                        </name>
                                                        <argument_list>()</argument_list>
                                                    </call>
                                                </expr>
                                                ;
                                            </expr_stmt>
                                            }
                                        </block>
                                    </else>
                                </if>
                                }
                            </block>
                        </then>
                        <else>else
                            <if>if
                                <condition>(
                                    <expr>
                                        <call>
                                            <name><name>encoding</name>.
                                                <name>startsWith</name>
                                            </name>
                                            <argument_list>(
                                                <argument>
                                                    <expr>"UTF-16"</expr>
                                                </argument>
                                                )
                                            </argument_list>
                                        </call>
                                    </expr>
                                    )
                                </condition>
                                <then>
                                    <block>{
                                        <expr_stmt>
                                            <expr>
                                                <name>count</name>
                                                =
                                                <call>
                                                    <name><name>stream</name>.
                                                        <name>read</name>
                                                    </name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>
                                                                <name>b</name>
                                                            </expr>
                                                        </argument>
                                                        ,
                                                        <argument>
                                                            <expr>0</expr>
                                                        </argument>
                                                        ,
                                                        <argument>
                                                            <expr>2</expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        <if>if
                                            <condition>(
                                                <expr>
                                                    <name>count</name>
                                                    == 2
                                                </expr>
                                                )
                                            </condition>
                                            <then>
                                                <block>{
                                                    <decl_stmt>
                                                        <decl>
                                                            <type>
                                                                <specifier>final</specifier>
                                                                <name>int</name>
                                                            </type>
                                                            <name>b0</name> =
                                                            <init>
                                                                <expr>
                                                                    <name>
                                                                        <name>b</name>
                                                                        <index>[<expr>0</expr>]
                                                                        </index>
                                                                    </name>
                                                                    &amp; 0xFF
                                                                </expr>
                                                            </init>
                                                        </decl>
                                                        ;
                                                    </decl_stmt>
                                                    <decl_stmt>
                                                        <decl>
                                                            <type>
                                                                <specifier>final</specifier>
                                                                <name>int</name>
                                                            </type>
                                                            <name>b1</name> =
                                                            <init>
                                                                <expr>
                                                                    <name>
                                                                        <name>b</name>
                                                                        <index>[<expr>1</expr>]
                                                                        </index>
                                                                    </name>
                                                                    &amp; 0xFF
                                                                </expr>
                                                            </init>
                                                        </decl>
                                                        ;
                                                    </decl_stmt>
                                                    <if>if
                                                        <condition>(
                                                            <expr>
                                                                <name>b0</name>
                                                                == 0xFE &amp;&amp; <name>b1</name> == 0xFF
                                                            </expr>
                                                            )
                                                        </condition>
                                                        <then>
                                                            <block>{
                                                                <return>return <expr>"UTF-16BE"</expr>;
                                                                </return>
                                                                }
                                                            </block>
                                                        </then>
                                                        <else>else
                                                            <if>if
                                                                <condition>(
                                                                    <expr>
                                                                        <name>b0</name>
                                                                        == 0xFF &amp;&amp; <name>b1</name> == 0xFE
                                                                    </expr>
                                                                    )
                                                                </condition>
                                                                <then>
                                                                    <block>{
                                                                        <return>return <expr>"UTF-16LE"</expr>;
                                                                        </return>
                                                                        }
                                                                    </block>
                                                                </then>
                                                            </if>
                                                        </else>
                                                    </if>
                                                    }
                                                </block>
                                            </then>
                                        </if>
                                        <comment type="line">// First two bytes are not BOM, so reset.</comment>
                                        <expr_stmt>
                                            <expr>
                                                <call>
                                                    <name><name>stream</name>.
                                                        <name>reset</name>
                                                    </name>
                                                    <argument_list>()</argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        }
                                    </block>
                                </then>
                            </if>
                        </else>
                    </if>
                    <comment type="line">// We could do UTF-32, but since the getEncodingName() doesn't support that
                    </comment>
                    <comment type="line">// we won't support it here.</comment>
                    <comment type="line">// To implement UTF-32, look for: 00 00 FE FF for big-endian</comment>
                    <comment type="line">// or FF FE 00 00 for little-endian</comment>
                    <return>return
                        <expr>
                            <name>encoding</name>
                        </expr>
                        ;
                    </return>
                    }
                </block>
            </function>

            <comment type="javadoc">/**
                * REVISIT: This code is taken from org.apache.xerces.impl.XMLEntityManager.
                * Is there any way we can share the code, without having it implemented twice?
                * I think we should make it public and static in XMLEntityManager. --PJM
                *
                * Returns the IANA encoding name that is auto-detected from
                * the bytes specified, with the endian-ness of that encoding where appropriate.
                *
                * @param b4 The first four bytes of the input.
                * @return the encoding name, or null if no encoding could be detected
                */
            </comment>
            <function>
                <type>
                    <specifier>protected</specifier>
                    <name>String</name>
                </type>
                <name>getEncodingName</name>
                <parameter_list>(
                    <param>
                        <decl>
                            <type>
                                <name>
                                    <name>byte</name>
                                    <index>[]</index>
                                </name>
                            </type>
                            <name>b4</name>
                        </decl>
                    </param>
                    )
                </parameter_list>
                <block>{

                    <comment type="line">// UTF-16, with BOM</comment>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>b0</name> =
                            <init>
                                <expr>
                                    <name>
                                        <name>b4</name>
                                        <index>[<expr>0</expr>]
                                        </index>
                                    </name>
                                    &amp; 0xFF
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>b1</name> =
                            <init>
                                <expr>
                                    <name>
                                        <name>b4</name>
                                        <index>[<expr>1</expr>]
                                        </index>
                                    </name>
                                    &amp; 0xFF
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <if>if
                        <condition>(
                            <expr>
                                <name>b0</name>
                                == 0xFE &amp;&amp; <name>b1</name> == 0xFF
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <comment type="line">// UTF-16, big-endian</comment>
                                <return>return <expr>"UTF-16BE"</expr>;
                                </return>
                                }
                            </block>
                        </then>
                    </if>
                    <if>if
                        <condition>(
                            <expr>
                                <name>b0</name>
                                == 0xFF &amp;&amp; <name>b1</name> == 0xFE
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <comment type="line">// UTF-16, little-endian</comment>
                                <return>return <expr>"UTF-16LE"</expr>;
                                </return>
                                }
                            </block>
                        </then>
                    </if>

                    <comment type="line">// UTF-8 with a BOM</comment>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>b2</name> =
                            <init>
                                <expr>
                                    <name>
                                        <name>b4</name>
                                        <index>[<expr>2</expr>]
                                        </index>
                                    </name>
                                    &amp; 0xFF
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <if>if
                        <condition>(
                            <expr>
                                <name>b0</name>
                                == 0xEF &amp;&amp; <name>b1</name> == 0xBB &amp;&amp; <name>b2</name> == 0xBF
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <return>return <expr>"UTF-8"</expr>;
                                </return>
                                }
                            </block>
                        </then>
                    </if>

                    <comment type="line">// other encodings</comment>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>b3</name> =
                            <init>
                                <expr>
                                    <name>
                                        <name>b4</name>
                                        <index>[<expr>3</expr>]
                                        </index>
                                    </name>
                                    &amp; 0xFF
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <if>if
                        <condition>(
                            <expr>
                                <name>b0</name>
                                == 0x00 &amp;&amp; <name>b1</name> == 0x00 &amp;&amp; <name>b2</name> == 0x00 &amp;&amp; <name>
                                b3
                            </name> == 0x3C
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <comment type="line">// UCS-4, big endian (1234)</comment>
                                <return>return <expr>"ISO-10646-UCS-4"</expr>;
                                </return>
                                }
                            </block>
                        </then>
                    </if>
                    <if>if
                        <condition>(
                            <expr>
                                <name>b0</name>
                                == 0x3C &amp;&amp; <name>b1</name> == 0x00 &amp;&amp; <name>b2</name> == 0x00 &amp;&amp; <name>
                                b3
                            </name> == 0x00
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <comment type="line">// UCS-4, little endian (4321)</comment>
                                <return>return <expr>"ISO-10646-UCS-4"</expr>;
                                </return>
                                }
                            </block>
                        </then>
                    </if>
                    <if>if
                        <condition>(
                            <expr>
                                <name>b0</name>
                                == 0x00 &amp;&amp; <name>b1</name> == 0x00 &amp;&amp; <name>b2</name> == 0x3C &amp;&amp; <name>
                                b3
                            </name> == 0x00
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <comment type="line">// UCS-4, unusual octet order (2143)</comment>
                                <return>return <expr>"ISO-10646-UCS-4"</expr>;
                                </return>
                                }
                            </block>
                        </then>
                    </if>
                    <if>if
                        <condition>(
                            <expr>
                                <name>b0</name>
                                == 0x00 &amp;&amp; <name>b1</name> == 0x3C &amp;&amp; <name>b2</name> == 0x00 &amp;&amp; <name>
                                b3
                            </name> == 0x00
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <comment type="line">// UCS-4, unusual octect order (3412)</comment>
                                <return>return <expr>"ISO-10646-UCS-4"</expr>;
                                </return>
                                }
                            </block>
                        </then>
                    </if>
                    <if>if
                        <condition>(
                            <expr>
                                <name>b0</name>
                                == 0x00 &amp;&amp; <name>b1</name> == 0x3C &amp;&amp; <name>b2</name> == 0x00 &amp;&amp; <name>
                                b3
                            </name> == 0x3F
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <comment type="line">// UTF-16, big-endian, no BOM</comment>
                                <comment type="line">// (or could turn out to be UCS-2...</comment>
                                <return>return <expr>"UTF-16BE"</expr>;
                                </return>
                                }
                            </block>
                        </then>
                    </if>
                    <if>if
                        <condition>(
                            <expr>
                                <name>b0</name>
                                == 0x3C &amp;&amp; <name>b1</name> == 0x00 &amp;&amp; <name>b2</name> == 0x3F &amp;&amp; <name>
                                b3
                            </name> == 0x00
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <comment type="line">// UTF-16, little-endian, no BOM</comment>
                                <comment type="line">// (or could turn out to be UCS-2...</comment>
                                <return>return <expr>"UTF-16LE"</expr>;
                                </return>
                                }
                            </block>
                        </then>
                    </if>
                    <if>if
                        <condition>(
                            <expr>
                                <name>b0</name>
                                == 0x4C &amp;&amp; <name>b1</name> == 0x6F &amp;&amp; <name>b2</name> == 0xA7 &amp;&amp; <name>
                                b3
                            </name> == 0x94
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <comment type="line">// EBCDIC</comment>
                                <comment type="line">// a la xerces1, return CP037 instead of EBCDIC here</comment>
                                <return>return <expr>"CP037"</expr>;
                                </return>
                                }
                            </block>
                        </then>
                    </if>

                    <comment type="line">// this signals us to use the value from the encoding attribute</comment>
                    <return>return
                        <expr>
                            <name>null</name>
                        </expr>
                        ;
                    </return>

                    }
                </block>
            </function>
            <comment type="line">// getEncodingName(byte[]):Object[]</comment>

            <comment type="javadoc">/**
                * Read the input stream as text, and pass the text on to the XIncludeHandler
                * using calls to characters(). This will read all of the text it can from the
                * resource.
                *
                * @throws IOException
                */
            </comment>
            <function>
                <type>
                    <specifier>public</specifier>
                    <name>void</name>
                </type>
                <name>parse</name>
                <parameter_list>()</parameter_list>
                <throws>throws
                    <argument>
                        <expr>
                            <name>IOException</name>
                        </expr>
                    </argument>
                </throws>
                <block>{

                    <expr_stmt>
                        <expr>
                            <name>fReader</name>
                            =
                            <call>
                                <name>getReader</name>
                                <argument_list>(
                                    <argument>
                                        <expr>
                                            <name>fSource</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </expr_stmt>
                    <expr_stmt>
                        <expr>
                            <name>fSource</name>
                            =
                            <name>null</name>
                        </expr>
                        ;
                    </expr_stmt>
                    <decl_stmt>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>readSize</name> =
                            <init>
                                <expr>
                                    <call>
                                        <name><name>fReader</name>.
                                            <name>read</name>
                                        </name>
                                        <argument_list>(
                                            <argument>
                                                <expr>
                                                    <name><name>fTempString</name>.
                                                        <name>ch</name>
                                                    </name>
                                                </expr>
                                            </argument>
                                            ,
                                            <argument>
                                                <expr>0</expr>
                                            </argument>
                                            ,
                                            <argument>
                                                <expr>
                                                    <name><name>fTempString</name>.<name>ch</name>.
                                                        <name>length</name>
                                                    </name>
                                                    - 1
                                                </expr>
                                            </argument>
                                            )
                                        </argument_list>
                                    </call>
                                </expr>
                            </init>
                        </decl>
                        ;
                    </decl_stmt>
                    <while>while
                        <condition>(
                            <expr>
                                <name>readSize</name>
                                != -1
                            </expr>
                            )
                        </condition>
                        <block>{
                            <for>for (
                                <init>
                                    <decl>
                                        <type>
                                            <name>int</name>
                                        </type>
                                        <name>i</name> =
                                        <init>
                                            <expr>0</expr>
                                        </init>
                                    </decl>
                                    ;
                                </init>
                                <condition>
                                    <expr>
                                        <name>i</name>
                                        &lt;
                                        <name>readSize</name>
                                    </expr>
                                    ;
                                </condition>
                                <incr>
                                    <expr>++
                                        <name>i</name>
                                    </expr>
                                </incr>
                                )
                                <block>{
                                    <decl_stmt>
                                        <decl>
                                            <type>
                                                <name>char</name>
                                            </type>
                                            <name>ch</name> =
                                            <init>
                                                <expr>
                                                    <name><name>fTempString</name>.
                                                        <name>ch</name>
                                                        <index>[
                                                            <expr>
                                                                <name>i</name>
                                                            </expr>
                                                            ]
                                                        </index>
                                                    </name>
                                                </expr>
                                            </init>
                                        </decl>
                                        ;
                                    </decl_stmt>
                                    <if>if
                                        <condition>(
                                            <expr>!
                                                <call>
                                                    <name>isValid</name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>
                                                                <name>ch</name>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            )
                                        </condition>
                                        <then>
                                            <block>{
                                                <if>if
                                                    <condition>(
                                                        <expr>
                                                            <call>
                                                                <name><name>XMLChar</name>.
                                                                    <name>isHighSurrogate</name>
                                                                </name>
                                                                <argument_list>(
                                                                    <argument>
                                                                        <expr>
                                                                            <name>ch</name>
                                                                        </expr>
                                                                    </argument>
                                                                    )
                                                                </argument_list>
                                                            </call>
                                                        </expr>
                                                        )
                                                    </condition>
                                                    <then>
                                                        <block>{
                                                            <decl_stmt>
                                                                <decl>
                                                                    <type>
                                                                        <name>int</name>
                                                                    </type>
                                                                    <name>ch2</name>
                                                                </decl>
                                                                ;
                                                            </decl_stmt>
                                                            <comment type="line">// retrieve next character</comment>
                                                            <if>if
                                                                <condition>(
                                                                    <expr>++<name>i</name> &lt;
                                                                        <name>readSize</name>
                                                                    </expr>
                                                                    )
                                                                </condition>
                                                                <then>
                                                                    <block>{
                                                                        <expr_stmt>
                                                                            <expr>
                                                                                <name>ch2</name>
                                                                                =
                                                                                <name><name>fTempString</name>.
                                                                                    <name>ch</name>
                                                                                    <index>[
                                                                                        <expr>
                                                                                            <name>i</name>
                                                                                        </expr>
                                                                                        ]
                                                                                    </index>
                                                                                </name>
                                                                            </expr>
                                                                            ;
                                                                        </expr_stmt>
                                                                        }
                                                                    </block>
                                                                </then>
                                                                <comment type="line">// handle rare boundary case
                                                                </comment>
                                                                <else>else
                                                                    <block>{
                                                                        <expr_stmt>
                                                                            <expr>
                                                                                <name>ch2</name>
                                                                                =
                                                                                <call>
                                                                                    <name><name>fReader</name>.
                                                                                        <name>read</name>
                                                                                    </name>
                                                                                    <argument_list>()</argument_list>
                                                                                </call>
                                                                            </expr>
                                                                            ;
                                                                        </expr_stmt>
                                                                        <if>if
                                                                            <condition>(
                                                                                <expr>
                                                                                    <name>ch2</name>
                                                                                    != -1
                                                                                </expr>
                                                                                )
                                                                            </condition>
                                                                            <then>
                                                                                <block>{
                                                                                    <expr_stmt>
                                                                                        <expr>
                                                                                            <name><name>
                                                                                                fTempString</name>.
                                                                                                <name>ch</name>
                                                                                                <index>[
                                                                                                    <expr><name>
                                                                                                        readSize</name>
                                                                                                        ++
                                                                                                    </expr>
                                                                                                    ]
                                                                                                </index>
                                                                                            </name>
                                                                                            = (<name>char</name>)
                                                                                            <name>ch2</name>
                                                                                        </expr>
                                                                                        ;
                                                                                    </expr_stmt>
                                                                                    }
                                                                                </block>
                                                                            </then>
                                                                        </if>
                                                                        }
                                                                    </block>
                                                                </else>
                                                            </if>
                                                            <if>if
                                                                <condition>(
                                                                    <expr>
                                                                        <call>
                                                                            <name><name>XMLChar</name>.
                                                                                <name>isLowSurrogate</name>
                                                                            </name>
                                                                            <argument_list>(
                                                                                <argument>
                                                                                    <expr>
                                                                                        <name>ch2</name>
                                                                                    </expr>
                                                                                </argument>
                                                                                )
                                                                            </argument_list>
                                                                        </call>
                                                                    </expr>
                                                                    )
                                                                </condition>
                                                                <then>
                                                                    <block>{
                                                                        <comment type="line">// convert surrogates to a
                                                                            supplemental character
                                                                        </comment>
                                                                        <decl_stmt>
                                                                            <decl>
                                                                                <type>
                                                                                    <name>int</name>
                                                                                </type>
                                                                                <name>sup</name> =
                                                                                <init>
                                                                                    <expr>
                                                                                        <call>
                                                                                            <name><name>XMLChar</name>.
                                                                                                <name>supplemental
                                                                                                </name>
                                                                                            </name>
                                                                                            <argument_list>(
                                                                                                <argument>
                                                                                                    <expr>
                                                                                                        <name>ch</name>
                                                                                                    </expr>
                                                                                                </argument>
                                                                                                ,
                                                                                                <argument>
                                                                                                    <expr>(<name>
                                                                                                        char</name>)
                                                                                                        <name>ch2</name>
                                                                                                    </expr>
                                                                                                </argument>
                                                                                                )
                                                                                            </argument_list>
                                                                                        </call>
                                                                                    </expr>
                                                                                </init>
                                                                            </decl>
                                                                            ;
                                                                        </decl_stmt>
                                                                        <if>if
                                                                            <condition>(
                                                                                <expr>!
                                                                                    <call>
                                                                                        <name>isValid</name>
                                                                                        <argument_list>(
                                                                                            <argument>
                                                                                                <expr>
                                                                                                    <name>sup</name>
                                                                                                </expr>
                                                                                            </argument>
                                                                                            )
                                                                                        </argument_list>
                                                                                    </call>
                                                                                </expr>
                                                                                )
                                                                            </condition>
                                                                            <then>
                                                                                <block>{
                                                                                    <expr_stmt>
                                                                                        <expr>
                                                                                            <call>
                                                                                                <name><name>
                                                                                                    fErrorReporter</name>
                                                                                                    .
                                                                                                    <name>reportError
                                                                                                    </name>
                                                                                                </name>
                                                                                                <argument_list>(
                                                                                                    <argument>
                                                                                                        <expr>
                                                                                                            <name><name>
                                                                                                                XMLMessageFormatter</name>
                                                                                                                .
                                                                                                                <name>
                                                                                                                    XML_DOMAIN
                                                                                                                </name>
                                                                                                            </name>
                                                                                                        </expr>
                                                                                                    </argument>
                                                                                                    ,
                                                                                                    <argument>
                                                                                                        <expr>
                                                                                                            "InvalidCharInContent"
                                                                                                        </expr>
                                                                                                    </argument>
                                                                                                    ,
                                                                                                    <argument>
                                                                                                        <expr>new
                                                                                                            <name>
                                                                                                                <name>
                                                                                                                    Object
                                                                                                                </name>
                                                                                                                <index>
                                                                                                                    []
                                                                                                                </index>
                                                                                                            </name>
                                                                                                            <block>{
                                                                                                                <expr>
                                                                                                                    <call>
                                                                                                                        <name>
                                                                                                                            <name>
                                                                                                                                Integer</name>
                                                                                                                            .
                                                                                                                            <name>
                                                                                                                                toString
                                                                                                                            </name>
                                                                                                                        </name>
                                                                                                                        <argument_list>
                                                                                                                            (
                                                                                                                            <argument>
                                                                                                                                <expr>
                                                                                                                                    <name>
                                                                                                                                        sup
                                                                                                                                    </name>
                                                                                                                                </expr>
                                                                                                                            </argument>
                                                                                                                            ,
                                                                                                                            <argument>
                                                                                                                                <expr>
                                                                                                                                    16
                                                                                                                                </expr>
                                                                                                                            </argument>
                                                                                                                            )
                                                                                                                        </argument_list>
                                                                                                                    </call>
                                                                                                                </expr>
                                                                                                                }
                                                                                                            </block>
                                                                                                        </expr>
                                                                                                    </argument>
                                                                                                    ,
                                                                                                    <argument>
                                                                                                        <expr>
                                                                                                            <name><name>
                                                                                                                XMLErrorReporter</name>
                                                                                                                .
                                                                                                                <name>
                                                                                                                    SEVERITY_FATAL_ERROR
                                                                                                                </name>
                                                                                                            </name>
                                                                                                        </expr>
                                                                                                    </argument>
                                                                                                    )
                                                                                                </argument_list>
                                                                                            </call>
                                                                                        </expr>
                                                                                        ;
                                                                                    </expr_stmt>
                                                                                    }
                                                                                </block>
                                                                            </then>
                                                                        </if>
                                                                        }
                                                                    </block>
                                                                </then>
                                                                <else>else
                                                                    <block>{
                                                                        <expr_stmt>
                                                                            <expr>
                                                                                <call>
                                                                                    <name><name>fErrorReporter</name>.
                                                                                        <name>reportError</name>
                                                                                    </name>
                                                                                    <argument_list>(
                                                                                        <argument>
                                                                                            <expr>
                                                                                                <name><name>
                                                                                                    XMLMessageFormatter</name>
                                                                                                    .
                                                                                                    <name>XML_DOMAIN
                                                                                                    </name>
                                                                                                </name>
                                                                                            </expr>
                                                                                        </argument>
                                                                                        ,
                                                                                        <argument>
                                                                                            <expr>
                                                                                                "InvalidCharInContent"
                                                                                            </expr>
                                                                                        </argument>
                                                                                        ,
                                                                                        <argument>
                                                                                            <expr>new
                                                                                                <name>
                                                                                                    <name>Object</name>
                                                                                                    <index>[]</index>
                                                                                                </name>
                                                                                                <block>{
                                                                                                    <expr>
                                                                                                        <call>
                                                                                                            <name><name>
                                                                                                                Integer</name>
                                                                                                                .
                                                                                                                <name>
                                                                                                                    toString
                                                                                                                </name>
                                                                                                            </name>
                                                                                                            <argument_list>
                                                                                                                (
                                                                                                                <argument>
                                                                                                                    <expr>
                                                                                                                        <name>
                                                                                                                            ch2
                                                                                                                        </name>
                                                                                                                    </expr>
                                                                                                                </argument>
                                                                                                                ,
                                                                                                                <argument>
                                                                                                                    <expr>
                                                                                                                        16
                                                                                                                    </expr>
                                                                                                                </argument>
                                                                                                                )
                                                                                                            </argument_list>
                                                                                                        </call>
                                                                                                    </expr>
                                                                                                    }
                                                                                                </block>
                                                                                            </expr>
                                                                                        </argument>
                                                                                        ,
                                                                                        <argument>
                                                                                            <expr>
                                                                                                <name><name>
                                                                                                    XMLErrorReporter</name>
                                                                                                    .
                                                                                                    <name>
                                                                                                        SEVERITY_FATAL_ERROR
                                                                                                    </name>
                                                                                                </name>
                                                                                            </expr>
                                                                                        </argument>
                                                                                        )
                                                                                    </argument_list>
                                                                                </call>
                                                                            </expr>
                                                                            ;
                                                                        </expr_stmt>
                                                                        }
                                                                    </block>
                                                                </else>
                                                            </if>
                                                            }
                                                        </block>
                                                    </then>
                                                    <else>else
                                                        <block>{
                                                            <expr_stmt>
                                                                <expr>
                                                                    <call>
                                                                        <name><name>fErrorReporter</name>.
                                                                            <name>reportError</name>
                                                                        </name>
                                                                        <argument_list>(
                                                                            <argument>
                                                                                <expr>
                                                                                    <name><name>
                                                                                        XMLMessageFormatter</name>.
                                                                                        <name>XML_DOMAIN</name>
                                                                                    </name>
                                                                                </expr>
                                                                            </argument>
                                                                            ,
                                                                            <argument>
                                                                                <expr>"InvalidCharInContent"</expr>
                                                                            </argument>
                                                                            ,
                                                                            <argument>
                                                                                <expr>new
                                                                                    <name>
                                                                                        <name>Object</name>
                                                                                        <index>[]</index>
                                                                                    </name>
                                                                                    <block>{
                                                                                        <expr>
                                                                                            <call>
                                                                                                <name><name>
                                                                                                    Integer</name>.
                                                                                                    <name>toString
                                                                                                    </name>
                                                                                                </name>
                                                                                                <argument_list>(
                                                                                                    <argument>
                                                                                                        <expr>
                                                                                                            <name>ch
                                                                                                            </name>
                                                                                                        </expr>
                                                                                                    </argument>
                                                                                                    ,
                                                                                                    <argument>
                                                                                                        <expr>16</expr>
                                                                                                    </argument>
                                                                                                    )
                                                                                                </argument_list>
                                                                                            </call>
                                                                                        </expr>
                                                                                        }
                                                                                    </block>
                                                                                </expr>
                                                                            </argument>
                                                                            ,
                                                                            <argument>
                                                                                <expr>
                                                                                    <name><name>XMLErrorReporter</name>.
                                                                                        <name>SEVERITY_FATAL_ERROR
                                                                                        </name>
                                                                                    </name>
                                                                                </expr>
                                                                            </argument>
                                                                            )
                                                                        </argument_list>
                                                                    </call>
                                                                </expr>
                                                                ;
                                                            </expr_stmt>
                                                            }
                                                        </block>
                                                    </else>
                                                </if>
                                                }
                                            </block>
                                        </then>
                                    </if>
                                    }
                                </block>
                            </for>
                            <if>if
                                <condition>(
                                    <expr>
                                        <name>fHandler</name>
                                        != <name>null</name> &amp;&amp; <name>readSize</name> &gt; 0
                                    </expr>
                                    )
                                </condition>
                                <then>
                                    <block>{
                                        <expr_stmt>
                                            <expr>
                                                <name><name>fTempString</name>.
                                                    <name>offset</name>
                                                </name>
                                                = 0
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        <expr_stmt>
                                            <expr>
                                                <name><name>fTempString</name>.
                                                    <name>length</name>
                                                </name>
                                                =
                                                <name>readSize</name>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        <expr_stmt>
                                            <expr>
                                                <call>
                                                    <name><name>fHandler</name>.
                                                        <name>characters</name>
                                                    </name>
                                                    <argument_list>(
                                                        <argument>
                                                            <expr>
                                                                <name>fTempString</name>
                                                            </expr>
                                                        </argument>
                                                        ,
                                                        <argument>
                                                            <expr>
                                                                <call>
                                                                    <name><name>fHandler</name>.
                                                                        <name>modifyAugmentations</name>
                                                                    </name>
                                                                    <argument_list>(
                                                                        <argument>
                                                                            <expr>
                                                                                <name>null</name>
                                                                            </expr>
                                                                        </argument>
                                                                        ,
                                                                        <argument>
                                                                            <expr>true</expr>
                                                                        </argument>
                                                                        )
                                                                    </argument_list>
                                                                </call>
                                                            </expr>
                                                        </argument>
                                                        )
                                                    </argument_list>
                                                </call>
                                            </expr>
                                            ;
                                        </expr_stmt>
                                        }
                                    </block>
                                </then>
                            </if>
                            <expr_stmt>
                                <expr>
                                    <name>readSize</name>
                                    =
                                    <call>
                                        <name><name>fReader</name>.
                                            <name>read</name>
                                        </name>
                                        <argument_list>(
                                            <argument>
                                                <expr>
                                                    <name><name>fTempString</name>.
                                                        <name>ch</name>
                                                    </name>
                                                </expr>
                                            </argument>
                                            ,
                                            <argument>
                                                <expr>0</expr>
                                            </argument>
                                            ,
                                            <argument>
                                                <expr>
                                                    <name><name>fTempString</name>.<name>ch</name>.
                                                        <name>length</name>
                                                    </name>
                                                    - 1
                                                </expr>
                                            </argument>
                                            )
                                        </argument_list>
                                    </call>
                                </expr>
                                ;
                            </expr_stmt>
                            }
                        </block>
                    </while>

                    }
                </block>
            </function>

            <comment type="javadoc">/**
                * Sets the input source on this text reader.
                *
                * @param source The XMLInputSource to use.
                */
            </comment>
            <function>
                <type>
                    <specifier>public</specifier>
                    <name>void</name>
                </type>
                <name>setInputSource</name>
                <parameter_list>(
                    <param>
                        <decl>
                            <type>
                                <name>XMLInputSource</name>
                            </type>
                            <name>source</name>
                        </decl>
                    </param>
                    )
                </parameter_list>
                <block>{
                    <expr_stmt>
                        <expr>
                            <name>fSource</name>
                            =
                            <name>source</name>
                        </expr>
                        ;
                    </expr_stmt>
                    }
                </block>
            </function>

            <comment type="javadoc">/**
                * Closes the stream. Call this after parse(), or when there is no longer any need
                * for this object.
                *
                * @throws IOException
                */
            </comment>
            <function>
                <type>
                    <specifier>public</specifier>
                    <name>void</name>
                </type>
                <name>close</name>
                <parameter_list>()</parameter_list>
                <throws>throws
                    <argument>
                        <expr>
                            <name>IOException</name>
                        </expr>
                    </argument>
                </throws>
                <block>{
                    <if>if
                        <condition>(
                            <expr>
                                <name>fReader</name>
                                !=
                                <name>null</name>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <expr_stmt>
                                    <expr>
                                        <call>
                                            <name><name>fReader</name>.
                                                <name>close</name>
                                            </name>
                                            <argument_list>()</argument_list>
                                        </call>
                                    </expr>
                                    ;
                                </expr_stmt>
                                <expr_stmt>
                                    <expr>
                                        <name>fReader</name>
                                        =
                                        <name>null</name>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </then>
                    </if>
                    }
                </block>
            </function>

            <comment type="javadoc">/**
                * Returns true if the specified character is a valid XML character
                * as per the rules of XML 1.0.
                *
                * @param ch The character to check.
                */
            </comment>
            <function>
                <type>
                    <specifier>protected</specifier>
                    <name>boolean</name>
                </type>
                <name>isValid</name>
                <parameter_list>(
                    <param>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>ch</name>
                        </decl>
                    </param>
                    )
                </parameter_list>
                <block>{
                    <return>return
                        <expr>
                            <call>
                                <name><name>XMLChar</name>.
                                    <name>isValid</name>
                                </name>
                                <argument_list>(
                                    <argument>
                                        <expr>
                                            <name>ch</name>
                                        </expr>
                                    </argument>
                                    )
                                </argument_list>
                            </call>
                        </expr>
                        ;
                    </return>
                    }
                </block>
            </function>

            <comment type="javadoc">/**
                * Sets the buffer size property for the reader which decides the chunk sizes that are parsed
                * by the reader at a time and passed to the handler
                *
                * @param bufferSize The size of the buffer desired
                */
            </comment>
            <function>
                <type>
                    <specifier>protected</specifier>
                    <name>void</name>
                </type>
                <name>setBufferSize</name>
                <parameter_list>(
                    <param>
                        <decl>
                            <type>
                                <name>int</name>
                            </type>
                            <name>bufferSize</name>
                        </decl>
                    </param>
                    )
                </parameter_list>
                <block>{
                    <if>if
                        <condition>(
                            <expr>
                                <name><name>fTempString</name>.<name>ch</name>.
                                    <name>length</name>
                                </name>
                                != ++
                                <name>bufferSize</name>
                            </expr>
                            )
                        </condition>
                        <then>
                            <block>{
                                <expr_stmt>
                                    <expr>
                                        <name><name>fTempString</name>.
                                            <name>ch</name>
                                        </name>
                                        = new
                                        <name>
                                            <name>char</name>
                                            <index>[
                                                <expr>
                                                    <name>bufferSize</name>
                                                </expr>
                                                ]
                                            </index>
                                        </name>
                                    </expr>
                                    ;
                                </expr_stmt>
                                }
                            </block>
                        </then>
                    </if>
                    }
                </block>
            </function>

            }
        </block>
    </class>
</unit>
